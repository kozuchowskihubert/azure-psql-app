# Behringer 2600 Sequencer-Patch Integration

## Overview

This guide explains how the step sequencer is integrated with the Behringer 2600 patch matrix system, enabling authentic analog-style routing where sequencer notes flow through configured patch cables.

## Architecture

### Component Structure

```
┌─────────────────────────────────────────────────────────────┐
│                     User Interface                           │
│  (synth-patch-sequencer.html - Presets, Controls, Display)  │
└────────────────┬────────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────────┐
│              PatchAwareSequencer                             │
│  (patch-sequencer.js - Routes sequencer through patches)    │
└────┬──────────────────────────────────┬────────────────────┘
     │                                   │
┌────▼─────────────────┐    ┌──────────▼──────────────────────┐
│   StepSequencer      │    │    Synth2600Audio               │
│  (synth-modules.js)  │    │  (synth-2600-audio.js)          │
│  - 16 steps          │    │  - VCO1, VCO2, VCF, VCA         │
│  - CV/Gate/Velocity  │    │  - Envelope, LFO                │
│  - Pattern presets   │    │  - Web Audio routing            │
└──────────────────────┘    └─────────────────────────────────┘
```

## Signal Flow

### CV (Control Voltage) Routing

The sequencer outputs CV values that are converted to frequencies:

```javascript
// CV to Frequency conversion (1V/octave standard)
cvToFrequency(cvVoltage) {
    const baseFreq = 261.63; // C4
    return baseFreq * Math.pow(2, cvVoltage);
}
```

**Patch Example - Acid Bass:**
```
sequencer.CV → vco1.CV
```

When a step plays, the CV signal:
1. Generated by sequencer (e.g., CV = 2.0V)
2. Converted to frequency (261.63 * 2^2 = 1046.52 Hz ≈ C6)
3. Applied to VCO1 oscillator frequency
4. VCO1 output routed through filter and VCA

### Gate Routing

Gate signals trigger envelopes and open/close the VCA:

```javascript
// Gate ON (step active)
if (gate > 0) {
    triggerEnvelope(velocity);  // Start ADSR attack
    openVCA(velocity);          // Set VCA level
}

// Gate OFF (step inactive)
else {
    releaseEnvelope();          // Start ADSR release
}
```

**Patch Example - Techno Lead:**
```
sequencer.GATE → env.GATE
env.OUT → vca.CV
```

### Velocity Routing

Velocity modulates filter cutoff for dynamic timbre:

```javascript
// Velocity to Filter modulation
applyVelocityModulation(velocity) {
    const baseFreq = filterCutoff;
    const modAmount = velocity * 2000; // Up to 2kHz
    vcf.frequency.value = baseFreq + modAmount;
}
```

**Patch Example - Dual VCO:**
```
sequencer.VELOCITY → vcf.CUTOFF
```

## Preset Patches

### 1. Acid Bass

Classic 303-style sequenced bassline with resonant filter.

**Patch Configuration:**
```javascript
{
    patches: [
        { from: 'sequencer.CV',   to: 'vco1.CV' },
        { from: 'sequencer.GATE', to: 'env.GATE' },
        { from: 'vco1.OUT',       to: 'vcf.IN' },
        { from: 'env.OUT',        to: 'vcf.CUTOFF' },
        { from: 'vcf.OUT',        to: 'vca.IN' },
        { from: 'env.OUT',        to: 'vca.CV' }
    ],
    synth: {
        vco1: { freq: 55, waveform: 'sawtooth' },
        vcf: { cutoff: 400, resonance: 12 },
        envelope: { 
            attack: 0.001, 
            decay: 0.05, 
            sustain: 0.3, 
            release: 0.1 
        }
    },
    pattern: 'bassline'
}
```

**Signal Path:**
```
Sequencer CV (2.0V)
    ↓
VCO1 (1046 Hz sawtooth)
    ↓
VCF (400 Hz cutoff + envelope modulation)
    ↓
VCA (envelope-controlled)
    ↓
Output
```

**Characteristics:**
- Punchy bass with fast attack
- Envelope modulates filter for "squelch"
- High resonance for classic acid sound
- Short decay and release for tight notes

### 2. Techno Lead

Dual VCO arpeggio lead with velocity-sensitive filter.

**Patch Configuration:**
```javascript
{
    patches: [
        { from: 'sequencer.CV',       to: 'vco1.CV' },
        { from: 'sequencer.CV',       to: 'vco2.CV' },
        { from: 'sequencer.GATE',     to: 'env.GATE' },
        { from: 'sequencer.VELOCITY', to: 'vcf.CUTOFF' },
        { from: 'vco1.OUT',           to: 'vcf.IN' },
        { from: 'vco2.OUT',           to: 'vcf.IN' },
        { from: 'vcf.OUT',            to: 'vca.IN' },
        { from: 'env.OUT',            to: 'vca.CV' }
    ],
    synth: {
        vco1: { freq: 220, waveform: 'sawtooth' },
        vco2: { freq: 220, waveform: 'square' },
        vcf: { cutoff: 2000, resonance: 6 },
        envelope: { 
            attack: 0.01, 
            decay: 0.2, 
            sustain: 0.6, 
            release: 0.3 
        }
    },
    pattern: 'arpeggio'
}
```

**Signal Path:**
```
Sequencer CV (3.0V) ──┬──→ VCO1 (1568 Hz sawtooth)
                      │           ↓
                      └──→ VCO2 (1568 Hz square)
                                  ↓
                          VCF (2000 Hz + velocity mod)
                                  ↓
                          VCA (envelope-controlled)
                                  ↓
                                Output
```

**Characteristics:**
- Rich dual oscillator timbre
- Velocity controls filter brightness
- Longer envelope for sustained notes
- Mixed waveforms for complex harmonics

### 3. Random Melody

Sample & Hold creates unpredictable note sequences.

**Patch Configuration:**
```javascript
{
    patches: [
        { from: 'noise.WHITE',    to: 'snh.IN' },
        { from: 'sequencer.TRIG', to: 'snh.TRIG' },
        { from: 'snh.OUT',        to: 'vco1.CV' },
        { from: 'sequencer.GATE', to: 'env.GATE' },
        { from: 'vco1.OUT',       to: 'vcf.IN' },
        { from: 'vcf.OUT',        to: 'vca.IN' },
        { from: 'env.OUT',        to: 'vca.CV' }
    ],
    synth: {
        vco1: { freq: 440, waveform: 'square' },
        vcf: { cutoff: 1200, resonance: 5 },
        envelope: { 
            attack: 0.005, 
            decay: 0.1, 
            sustain: 0.4, 
            release: 0.2 
        }
    },
    pattern: 'rhythm'
}
```

**Signal Path:**
```
White Noise → S&H ←(triggered by sequencer)
                ↓
          VCO1 CV (random frequencies)
                ↓
          VCO1 (random pitch square wave)
                ↓
          VCF (1200 Hz cutoff)
                ↓
          VCA (envelope-controlled)
                ↓
              Output
```

**Characteristics:**
- Each trigger samples random voltage
- Unpredictable melodic sequences
- Percussive envelope for rhythmic quality
- Classic West Coast synthesis technique

## Implementation Details

### Envelope Triggering

The ADSR envelope is triggered by gate signals:

```javascript
triggerEnvelope(velocity) {
    const now = audioContext.currentTime;
    
    // Cancel previous envelope
    vca.gain.cancelScheduledValues(now);
    vca.gain.setValueAtTime(0, now);
    
    // Attack phase
    vca.gain.linearRampToValueAtTime(
        velocity,
        now + envelope.attack
    );
    
    // Decay to Sustain
    vca.gain.linearRampToValueAtTime(
        velocity * envelope.sustain,
        now + envelope.attack + envelope.decay
    );
    
    // Sustain held until gate OFF
}

releaseEnvelope() {
    const now = audioContext.currentTime;
    
    // Release phase
    vca.gain.cancelScheduledValues(now);
    vca.gain.setValueAtTime(vca.gain.value, now);
    vca.gain.linearRampToValueAtTime(
        0,
        now + envelope.release
    );
}
```

### Smooth Frequency Transitions

VCO frequencies change with slight glide for natural sound:

```javascript
setVCOFrequency(vcoId, frequency) {
    const now = audioContext.currentTime;
    const glideTime = 0.01; // 10ms portamento
    
    vco.frequency.cancelScheduledValues(now);
    vco.frequency.setValueAtTime(
        vco.frequency.value,
        now
    );
    vco.frequency.linearRampToValueAtTime(
        frequency,
        now + glideTime
    );
}
```

### Visual Feedback

Active patches are highlighted during playback:

```javascript
highlightActiveCables() {
    patches.forEach(patch => {
        if (patch.from.includes('sequencer')) {
            const cableEl = document.querySelector(
                `[data-patch="${patch.from}-${patch.to}"]`
            );
            cableEl.classList.add('active');
            
            setTimeout(() => {
                cableEl.classList.remove('active');
            }, 100);
        }
    });
}
```

## Usage Guide

### Basic Workflow

1. **Open Demo Page**
   ```
   http://localhost:3000/synth-patch-sequencer.html
   ```

2. **Load a Preset**
   - Click "Acid Bass", "Techno Lead", or "Random Melody"
   - Watch patch cables appear in the matrix
   - Synth parameters automatically configured

3. **Start Sequencer**
   - Click ▶ Play button
   - Observe step indicators lighting up
   - CV/Gate displays show real-time signals
   - Active patches glow during playback

4. **Adjust Parameters**
   - **Filter Cutoff**: Brighten/darken timbre
   - **Resonance**: Add peak at cutoff frequency
   - **Attack/Release**: Shape note envelope
   - **Tempo**: Speed up/slow down sequence
   - **Volume**: Master output level

### Creating Custom Patches

To create your own patch configurations:

```javascript
const myCustomPatch = {
    patches: [
        // Define your patch cables
        { from: 'sequencer.CV', to: 'vco1.CV' },
        { from: 'vco1.OUT', to: 'vcf.IN' },
        // ... more cables
    ],
    synth: {
        vco1: { freq: 110, waveform: 'triangle' },
        vcf: { cutoff: 800, resonance: 3 },
        envelope: { 
            attack: 0.1, 
            decay: 0.3, 
            sustain: 0.5, 
            release: 0.4 
        }
    },
    pattern: 'your-pattern-name'
};

// Load it
patchSequencer.loadPresetWithPattern('my-custom');
```

## Available Modules

### Input Modules
- **SEQUENCER**: CV, GATE, VELOCITY, TRIG outputs
- **KEYBOARD**: CV, GATE, VELOCITY outputs (for manual playing)
- **NOISE**: WHITE, PINK outputs
- **LFO**: SIN, TRI, SAW, SQR outputs

### Processing Modules
- **VCO1, VCO2**: Oscillators with CV input
- **VCF**: Filter with CUTOFF and RESONANCE CV inputs
- **VCA**: Amplifier with CV input
- **ENV**: ADSR envelope generator
- **S&H**: Sample and Hold
- **RINGMOD**: Ring modulator
- **MIXER**: Audio mixer

### Output Modules
- **DELAY**: Echo effect
- **OUTPUT**: Final audio out

## Technical Specifications

### CV Standards
- **Range**: 0V to 5V
- **Scaling**: 1V/octave
- **Base**: 0V = C4 (261.63 Hz)

### Gate Standards
- **High**: 1 (gate open)
- **Low**: 0 (gate closed)
- **Trigger**: Rising edge triggers envelope

### Velocity Standards
- **Range**: 0.0 to 1.0
- **Default**: 0.8
- **Usage**: VCA level, filter modulation

### Timing
- **Tempo Range**: 60-180 BPM
- **Steps**: 16 per pattern
- **Glide Time**: 10ms (configurable)

## Performance Tips

### For Best Sound Quality

1. **Filter Settings**
   - Acid bass: High resonance (10-15), low cutoff (200-500 Hz)
   - Leads: Medium resonance (4-8), high cutoff (1000-3000 Hz)
   - Pads: Low resonance (1-3), medium cutoff (500-1500 Hz)

2. **Envelope Shaping**
   - Percussive: Fast attack (0.001s), short release (0.1s)
   - Plucky: Medium attack (0.01s), medium release (0.3s)
   - Sustained: Slow attack (0.1s), long release (0.5s+)

3. **Tempo Settings**
   - Acid bass: 120-130 BPM
   - Techno: 130-140 BPM
   - Ambient: 80-100 BPM

### CPU Optimization

- One active sequencer at a time
- Limit filter resonance to prevent instability
- Use appropriate envelope times (not too short)
- Stop sequencer when not in use

## Troubleshooting

### No Sound

1. Check browser console for errors
2. Verify audio context started (user gesture required)
3. Ensure a preset is loaded
4. Check master volume slider
5. Verify VCO frequencies are reasonable (50-8000 Hz)

### Clicks/Pops

1. Increase envelope attack time (min 0.005s)
2. Add slight glide to frequency changes
3. Reduce filter resonance if oscillating
4. Check for rapid parameter changes

### Wrong Notes

1. Verify CV-to-frequency conversion
2. Check sequencer pattern notes
3. Ensure VCO base frequency is set
4. Verify patch routing is correct

## Browser Compatibility

- ✅ Chrome 89+
- ✅ Firefox 88+
- ✅ Safari 14.1+
- ✅ Edge 89+

Requires Web Audio API support.

## Files Reference

- `patch-sequencer.js` - Main integration logic
- `synth-patch-sequencer.html` - Demo UI
- `synth-modules.js` - StepSequencer class
- `synth-2600-audio.js` - Audio engine
- `synth-2600-studio.js` - Patch matrix system

## Next Steps

1. Add more preset patches
2. Implement polyphonic sequencer
3. Add pattern editor
4. Save/load custom patches
5. MIDI input/output support
6. Multi-track sequencing

## Support

For issues or questions, see the main project documentation or contact the development team.
