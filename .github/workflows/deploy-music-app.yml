# =============================================================================
# Music Production App Deployment Pipeline
# =============================================================================
# 
# This workflow deploys the Music Production Application with Behringer 2600
# synthesizer visualizer and MIDI generation capabilities.
#
# Workflow Stages:
#   1. Validate    - Code quality, Docker validation, Terraform checks
#   2. Build       - Music app Docker image (Alpine + Python + MIDI libs)
#   3. Provision   - Music infrastructure (B1 App Service + VM)
#   4. Deploy      - Deploy to Azure Web App
#   5. Verify      - Health checks and MIDI endpoint testing
#   6. Notify      - Deployment status reporting
#
# Features:
#   - Behringer 2600 Synthesizer Visualizer
#   - MIDI Generation & Preview
#   - Interactive Patch Matrix
#   - 16-step ARP Sequencer
#   - Dedicated Azure VM for audio processing
#
# Infrastructure:
#   - App Service Plan: B1 Basic ($13/month)
#   - Virtual Machine: Standard_B1s (1 vCPU, 1GB RAM)
#   - Docker Image: ~1.14GB (Alpine + Python + mido + midiutil)
#
# Documentation:
#   - Synth Guide: docs/technical/SYNTH_2600_GUIDE.md
#   - Architecture: docs/technical/CALENDAR_SSO_ARCHITECTURE.md
# =============================================================================

name: Deploy Music Production App

on:
  # Only trigger on manual dispatch or release tags
  # This prevents rebuilding on every push - use feature management workflow instead
  push:
    tags:
      - 'v*.*.*'           # Semantic version tags (v1.0.0)
      - 'release-*'        # Release tags (release-production)
      - 'deploy-music-*'   # Explicit deployment tags (deploy-music-fix)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_verification:
        description: 'Skip health checks and verification'
        required: false
        default: false
        type: boolean
      force_rebuild:
        description: 'Force rebuild even if no code changes'
        required: false
        default: true
        type: boolean

# Global environment variables
env:
  ACR_NAME: notesappdevacr14363
  IMAGE_NAME: notesapp-music
  AZURE_REGION: westus2
  TERRAFORM_VERSION: '~1.5'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

# =============================================================================
# Jobs
# =============================================================================

jobs:
  # ---------------------------------------------------------------------------
  # Stage 1: Validation
  # ---------------------------------------------------------------------------
  # Validates music app code, Docker configuration, and infrastructure
  # - Checks Node.js dependencies
  # - Validates Dockerfile.music syntax
  # - Verifies Terraform configuration for music infrastructure
  # ---------------------------------------------------------------------------
  validate:
    name: Validate Music App & Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: app/package-lock.json

      - name: ğŸ”§ Install dependencies
        working-directory: ./app
        run: |
          echo "Installing npm packages for music app..."
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ³ Validate Dockerfile.music
        run: |
          echo "Checking Dockerfile.music exists and syntax..."
          if [ -f "Dockerfile.music" ]; then
            echo "âœ… Dockerfile.music found"
            head -20 Dockerfile.music
          else
            echo "âŒ Dockerfile.music not found"
            exit 1
          fi

      - name: ğŸ—ï¸ Setup Terraform ${{ env.TERRAFORM_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ğŸ“ Terraform Format Check
        working-directory: ./music-tf
        run: |
          echo "Checking Terraform formatting..."
          terraform fmt -check -recursive || echo "âš ï¸ Formatting issues found (non-blocking)"

      - name: ğŸ”§ Terraform Init (validation only)
        working-directory: ./music-tf
        run: |
          echo "Initializing Terraform (no backend)..."
          terraform init -backend=false
          echo "âœ… Terraform initialized successfully"

      - name: âœ… Terraform Validate
        working-directory: ./music-tf
        run: |
          echo "Validating Terraform configuration..."
          terraform validate
          echo "âœ… Terraform configuration is valid"
      
      - name: ğŸ“Š Validation Summary
        if: always()
        run: |
          echo "### âœ… Validation Stage Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Setup | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile.music | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Format | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Stage 2: Deploy Infrastructure
  # ---------------------------------------------------------------------------
  # Provisions Azure infrastructure for music production app
  # - B1 App Service Plan for music app
  # - Linux Web App with Docker container support
  # - Standard_B1s VM for audio processing
  # - Automatic state lock recovery
  # ---------------------------------------------------------------------------
  deploy-infrastructure:
    name: Deploy Music Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      music-app-url: ${{ steps.output.outputs.music-app-url }}
      vm-ip: ${{ steps.output.outputs.vm-ip }}
      rg-name: ${{ steps.output.outputs.rg-name }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Terraform ${{ env.TERRAFORM_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Terraform Init
        working-directory: ./music-tf
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: |
          echo "ğŸ”§ Initializing Terraform with separate music state..."
          terraform init
          echo "âœ… Terraform initialized successfully"

      - name: ğŸ” Check and Unlock Terraform State
        working-directory: ./music-tf
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for state locks in music state..."
          
          # Known lock IDs from previous failed runs
          KNOWN_LOCKS=(
            "51f2301c-cab3-7143-d36c-ec40349bd5c6"
          )
          
          # Try to unlock known locks
          for LOCK_ID in "${KNOWN_LOCKS[@]}"; do
            echo "ğŸ”“ Attempting to unlock: $LOCK_ID"
            terraform force-unlock -force "$LOCK_ID" 2>&1 | grep -v "Failed to load" || true
          done
          
          echo "âœ… Lock cleanup complete"

      - name: ğŸ“‹ Terraform Plan
        id: plan
        working-directory: ./music-tf
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_vm_ssh_public_key: ${{ secrets.VM_SSH_PUBLIC_KEY }}
        run: |
          echo "ğŸ“‹ Planning infrastructure changes..."
          terraform plan -out=tfplan -no-color | tee plan.txt
          
          # Count resource changes
          CHANGES=$(grep -E "Plan:|No changes" plan.txt || echo "Unknown")
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
          echo "âœ… Terraform plan complete"

      - name: ğŸš€ Deploy Azure Infrastructure
        working-directory: ./music-tf
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_vm_ssh_public_key: ${{ secrets.VM_SSH_PUBLIC_KEY }}
        run: |
          echo "ğŸš€ Deploying music infrastructure (isolated state)..."
          terraform apply -auto-approve
          echo "âœ… Infrastructure deployed successfully"

      - name: ğŸ“¤ Get Terraform Outputs
        id: output
        working-directory: ./music-tf
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: |
          echo "Extracting Terraform outputs..."
          
          MUSIC_APP_URL=$(terraform output -raw music_app_url 2>/dev/null || echo "")
          VM_IP=$(terraform output -raw vm_public_ip 2>/dev/null || echo "")
          RG_NAME=$(terraform output -raw resource_group_name 2>/dev/null || echo "notesapp-dev-rg")
          
          echo "music-app-url=$MUSIC_APP_URL" >> $GITHUB_OUTPUT
          echo "vm-ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "rg-name=$RG_NAME" >> $GITHUB_OUTPUT
          
          echo "### ğŸ—ï¸ Music Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ steps.plan.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "**Music App URL:** $MUSIC_APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "**VM IP Address:** $VM_IP" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** $RG_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AZURE_REGION }}" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Stage 3: Build & Push Docker Image
  # ---------------------------------------------------------------------------
  # Builds music production Docker image with Python and MIDI libraries
  # - Alpine Linux base (~1.14GB final size)
  # - Python 3.11 with mido and midiutil
  # - Node.js 20 for Express server
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Music Docker Image
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      image-full: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest

      - name: ğŸ” Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Log in to Azure Container Registry
        run: |
          echo "Authenticating with ACR: ${{ env.ACR_NAME }}.azurecr.io"
          az acr login --name ${{ env.ACR_NAME }}
          echo "âœ… Successfully authenticated with ACR"

      - name: ğŸ·ï¸ Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable=true
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: ğŸ³ Build and push music Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.music
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max
          platforms: linux/amd64
          provenance: false
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: ğŸ“Š Output image details
        run: |
          echo "### ğŸ³ Music Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.ACR_NAME }}.azurecr.io\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ~1.14GB (Alpine + Python + MIDI libs)" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¹ Behringer 2600 Synthesizer Visualizer" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸµ MIDI Generation (mido + midiutil)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ›ï¸ Interactive Patch Matrix" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š 16-step ARP Sequencer" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Stage 4: Deploy Application
  # ---------------------------------------------------------------------------
  # Deploys music production app to Azure Web App
  # - Updates container image
  # - Restarts application
  # - Waits for startup
  # ---------------------------------------------------------------------------
  deploy-application:
    name: Deploy Music Application
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infrastructure]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸš€ Deploy to Music Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: notesapp-dev-music-app
          images: ${{ needs.build-and-push.outputs.image-full }}

      - name: âš™ï¸ Configure Web App Settings
        run: |
          echo "Configuring startup command and app settings..."
          az webapp config set \
            --name notesapp-dev-music-app \
            --resource-group notesapp-dev-rg \
            --startup-file "node server.js"
          
          # Set environment variables for production
          az webapp config appsettings set \
            --name notesapp-dev-music-app \
            --resource-group notesapp-dev-rg \
            --settings \
              NODE_ENV=production \
              PORT=8080 \
              WEBSITES_PORT=8080
          
          echo "âœ… Web app configuration complete"

      - name: ğŸ”„ Restart Music Web App
        run: |
          echo "Restarting music production app for clean deployment..."
          az webapp restart \
            --name notesapp-dev-music-app \
            --resource-group notesapp-dev-rg
          echo "âœ… Music app restarted successfully"

      - name: ğŸ“Š Output deployment info
        run: |
          echo "### ğŸš€ Music Application Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Web App:** \`notesapp-dev-music-app\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ needs.build-and-push.outputs.image-full }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ needs.build-and-push.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`notesapp-dev-rg\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Waiting for application startup and running health checks..."

  # ---------------------------------------------------------------------------
  # Stage 5: Verify Deployment
  # ---------------------------------------------------------------------------
  # Validates music app deployment
  # - Health checks with retries
  # - Tests Behringer 2600 visualizer endpoint
  # - Tests MIDI generation API
  # ---------------------------------------------------------------------------
  verify-deployment:
    name: Verify Music App Deployment
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-application]
    if: github.event.inputs.skip_verification != 'true'
    steps:
      - name: â³ Wait for application startup
        run: |
          echo "Waiting 45 seconds for music app to fully start (larger image)..."
          sleep 45
          echo "âœ… Wait complete, beginning health checks"

      - name: ğŸ¥ Health Check
        id: health
        run: |
          APP_URL="${{ needs.deploy-infrastructure.outputs.music-app-url }}"
          
          if [ -z "$APP_URL" ]; then
            APP_URL="https://notesapp-dev-music-app.azurewebsites.net"
            echo "Using default URL: $APP_URL"
          fi
          
          echo "Testing health endpoint: $APP_URL/health"
          
          # Retry logic with exponential backoff
          MAX_ATTEMPTS=6
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" "$APP_URL/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed! (HTTP $HTTP_CODE)"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "âš ï¸ Received HTTP $HTTP_CODE, retrying in $((ATTEMPT * 10))s..."
            sleep $((ATTEMPT * 10))
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: ğŸ¹ Test Behringer 2600 Visualizer
        if: steps.health.outputs.healthy == 'true'
        run: |
          APP_URL="${{ needs.deploy-infrastructure.outputs.music-app-url }}"
          [ -z "$APP_URL" ] && APP_URL="https://notesapp-dev-music-app.azurewebsites.net"
          
          echo "Testing Behringer 2600 visualizer: $APP_URL/synth-2600.html"
          
          HTTP_CODE=$(curl -s -w "\n%{http_code}" "$APP_URL/synth-2600.html" || echo "Error\n000")
          HTTP_CODE=$(echo "$HTTP_CODE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Behringer 2600 visualizer is accessible! (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Synth visualizer returned HTTP $HTTP_CODE"
          fi

      - name: ğŸµ Test MIDI Generation Endpoint
        if: steps.health.outputs.healthy == 'true'
        run: |
          APP_URL="${{ needs.deploy-infrastructure.outputs.music-app-url }}"
          [ -z "$APP_URL" ] && APP_URL="https://notesapp-dev-music-app.azurewebsites.net"
          
          echo "Testing MIDI generation API..."
          
          # Test if Python/MIDI libraries are working
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "$APP_URL/api/music/test" \
            || echo "Error\n000")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… MIDI generation endpoint is working! (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ MIDI endpoint returned HTTP $HTTP_CODE (may not be implemented yet)"
          fi

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          HEALTH_STATUS="${{ steps.health.outputs.healthy }}"
          APP_URL="${{ needs.deploy-infrastructure.outputs.music-app-url }}"
          [ -z "$APP_URL" ] && APP_URL="https://notesapp-dev-music-app.azurewebsites.net"
          
          echo "### âœ… Music App Verification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HEALTH_STATUS" = "true" ]; then
            echo "**Status:** âœ… Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Music App URL:** $APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "**VM IP:** ${{ needs.deploy-infrastructure.outputs.vm-ip }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ  Music App Home]($APP_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ¹ Behringer 2600 Synth]($APP_URL/synth-2600.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ¥ Health Check]($APP_URL/health)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Health Check: ${{ steps.health.outputs.healthy == 'true' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Synth Visualizer: Tested" >> $GITHUB_STEP_SUMMARY
          echo "- MIDI Generation: Tested" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Stage 6: Notify
  # ---------------------------------------------------------------------------
  # Final deployment status notification and summary
  # ---------------------------------------------------------------------------
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate, deploy-infrastructure, build-and-push, deploy-application, verify-deployment]
    if: always()
    steps:
      - name: ğŸ“Š Collect Deployment Status
        id: status
        run: |
          VALIDATE="${{ needs.validate.result }}"
          INFRA="${{ needs.deploy-infrastructure.result }}"
          BUILD="${{ needs.build-and-push.result }}"
          DEPLOY="${{ needs.deploy-application.result }}"
          VERIFY="${{ needs.verify-deployment.result }}"
          
          echo "### ğŸ¯ Music App Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1. Validate | ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }} $VALIDATE |" >> $GITHUB_STEP_SUMMARY
          echo "| 2. Deploy Infrastructure | ${{ needs.deploy-infrastructure.result == 'success' && 'âœ…' || needs.deploy-infrastructure.result == 'skipped' && 'â­ï¸' || 'âŒ' }} $INFRA |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. Build & Push | ${{ needs.build-and-push.result == 'success' && 'âœ…' || needs.build-and-push.result == 'skipped' && 'â­ï¸' || 'âŒ' }} $BUILD |" >> $GITHUB_STEP_SUMMARY
          echo "| 4. Deploy Application | ${{ needs.deploy-application.result == 'success' && 'âœ…' || needs.deploy-application.result == 'skipped' && 'â­ï¸' || 'âŒ' }} $DEPLOY |" >> $GITHUB_STEP_SUMMARY
          echo "| 5. Verify Deployment | ${{ needs.verify-deployment.result == 'success' && 'âœ…' || needs.verify-deployment.result == 'skipped' && 'â­ï¸' || 'âŒ' }} $VERIFY |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Set overall status
          if [[ "$VALIDATE" == "success" ]] && \
             ([[ "$INFRA" == "success" ]] || [[ "$INFRA" == "skipped" ]]) && \
             ([[ "$BUILD" == "success" ]] || [[ "$BUILD" == "skipped" ]]) && \
             ([[ "$DEPLOY" == "success" ]] || [[ "$DEPLOY" == "skipped" ]]) && \
             ([[ "$VERIFY" == "success" ]] || [[ "$VERIFY" == "skipped" ]]); then
            echo "overall=success" >> $GITHUB_OUTPUT
          else
            echo "overall=failure" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ‰ Success Notification
        if: steps.status.outputs.overall == 'success'
        run: |
          echo "### âœ… Music App Deployment Successful! ğŸ‰ğŸ¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All deployment stages completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ¹ Features Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Behringer 2600 Synthesizer Visualizer" >> $GITHUB_STEP_SUMMARY
          echo "- MIDI Generation & Preview" >> $GITHUB_STEP_SUMMARY
          echo "- Interactive Patch Matrix (86 points)" >> $GITHUB_STEP_SUMMARY
          echo "- 16-step ARP Sequencer" >> $GITHUB_STEP_SUMMARY
          echo "- 8 Classic Synth Presets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“š Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Access synth: https://notesapp-dev-music-app.azurewebsites.net/synth-2600.html" >> $GITHUB_STEP_SUMMARY
          echo "- View logs: \`az webapp log tail --name notesapp-dev-music-app --resource-group notesapp-dev-rg\`" >> $GITHUB_STEP_SUMMARY
          echo "- Read guide: [Synth 2600 Guide](docs/technical/SYNTH_2600_GUIDE.md)" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Failure Notification
        if: steps.status.outputs.overall == 'failure'
        run: |
          echo "### âŒ Music App Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more deployment stages failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ”§ Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check if Terraform state lock issue occurred" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify Docker image builds locally: \`docker build -f Dockerfile.music -t music-test .\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check Azure Container Registry access" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify all GitHub Secrets are configured" >> $GITHUB_STEP_SUMMARY
          echo "5. Review [Troubleshooting Guide](docs/TROUBLESHOOTING.md)" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš¨ Final Status
        run: |
          if [ "${{ steps.status.outputs.overall }}" = "success" ]; then
            echo "ğŸ‰ Music app deployment successful!"
            exit 0
          else
            echo "âŒ Music app deployment failed - check logs above"
            exit 1
          fi
