# =============================================================================
# Feature Management & Configuration Workflow
# =============================================================================
#
# This workflow manages feature flags and configuration without rebuilding
# the Docker image. Use this for:
#   - Enabling/disabling features via environment variables
#   - Updating configuration settings
#   - Testing changes with dry-run mode
#   - Quick configuration updates without full deployment
#
# Benefits:
#   - âš¡ Fast: No Docker build (seconds vs minutes)
#   - ðŸ”§ Flexible: Toggle features on/off instantly
#   - ðŸ§ª Safe: Dry-run mode to preview changes
#   - ðŸ’° Cost-effective: No unnecessary rebuilds
#
# Usage:
#   1. Go to Actions tab: https://github.com/kozuchowskihubert/azure-psql-app/actions
#   2. Select "Feature Management & Configuration"
#   3. Click "Run workflow"
#   4. Choose operation and settings
#
# =============================================================================

name: Feature Management & Configuration

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        default: 'dry-run'
        options:
          - dry-run           # Preview changes without applying
          - enable-features   # Enable specific features
          - update-config     # Update configuration
          - restart-app       # Restart app with current settings
          - view-current      # View current configuration
      
      features:
        description: 'Features to enable (comma-separated: haos-platform,radio-247,trap-studio,sequencer)'
        required: false
        default: 'haos-platform,sequencer'
      
      environment:
        description: 'Target environment'
        required: true
        type: choice
        default: 'dev'
        options:
          - dev
          - staging
          - prod
      
      node_env:
        description: 'Node environment (production/development)'
        required: false
        type: choice
        default: 'production'
        options:
          - production
          - development
      
      log_level:
        description: 'Application log level'
        required: false
        type: choice
        default: 'info'
        options:
          - error
          - warn
          - info
          - debug
      
      restart_after:
        description: 'Restart app after changes'
        required: false
        type: boolean
        default: true

env:
  AZURE_REGION: westus2
  MUSIC_APP_NAME: notesapp-dev-music-app
  MUSIC_RG: notesapp-dev-rg

jobs:
  # =============================================================================
  # Dry Run: Preview Changes
  # =============================================================================
  dry-run:
    name: ðŸ” Dry Run - Preview Changes
    runs-on: ubuntu-latest
    if: inputs.operation == 'dry-run' || inputs.operation == 'view-current'
    
    steps:
      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸ“Š Get Current Configuration
        id: current
        run: |
          echo "ðŸ“‹ Current Azure Web App Configuration:"
          echo "========================================"
          
          # Get current app settings
          echo "ðŸ”§ App Settings:"
          az webapp config appsettings list \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }} \
            --query "[].{Name:name, Value:value}" \
            --output table
          
          echo ""
          echo "ðŸŒ General Settings:"
          az webapp show \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }} \
            --query "{State:state, DefaultHostName:defaultHostName, Kind:kind, RuntimeStack:siteConfig.linuxFxVersion}" \
            --output table
          
          echo ""
          echo "ðŸ’¾ Current Scale:"
          az appservice plan show \
            --name notesapp-dev-music-plan \
            --resource-group ${{ env.MUSIC_RG }} \
            --query "{Tier:sku.tier, Size:sku.name, Instances:sku.capacity}" \
            --output table
      
      - name: ðŸ”® Preview Proposed Changes
        if: inputs.operation == 'dry-run'
        run: |
          echo "ðŸ“ Proposed Changes (DRY RUN - Not Applied):"
          echo "============================================"
          echo ""
          echo "ðŸŽ¯ Features to enable: ${{ inputs.features }}"
          echo "ðŸŒ Environment: ${{ inputs.environment }}"
          echo "âš™ï¸  Node Environment: ${{ inputs.node_env }}"
          echo "ðŸ“Š Log Level: ${{ inputs.log_level }}"
          echo "ðŸ”„ Restart after: ${{ inputs.restart_after }}"
          echo ""
          echo "ðŸ“‹ Settings that would be updated:"
          echo "  ENABLED_FEATURES=${{ inputs.features }}"
          echo "  NODE_ENV=${{ inputs.node_env }}"
          echo "  LOG_LEVEL=${{ inputs.log_level }}"
          echo "  ENVIRONMENT=${{ inputs.environment }}"
          echo ""
          echo "âœ… To apply these changes, run with operation: 'enable-features' or 'update-config'"

  # =============================================================================
  # Enable Features: Update Feature Flags
  # =============================================================================
  enable-features:
    name: ðŸŽ¯ Enable Features
    runs-on: ubuntu-latest
    if: inputs.operation == 'enable-features'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸŽ¯ Update Feature Flags
        run: |
          echo "ðŸŽ¯ Enabling features: ${{ inputs.features }}"
          
          # Update app settings
          az webapp config appsettings set \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }} \
            --settings \
              ENABLED_FEATURES="${{ inputs.features }}" \
              NODE_ENV="${{ inputs.node_env }}" \
              LOG_LEVEL="${{ inputs.log_level }}" \
              ENVIRONMENT="${{ inputs.environment }}" \
              LAST_UPDATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              UPDATED_BY="GitHub Actions (Feature Management)"
          
          echo "âœ… Feature flags updated successfully"
      
      - name: ðŸ“Š Verify Settings
        run: |
          echo "ðŸ“‹ Verifying updated settings..."
          az webapp config appsettings list \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }} \
            --query "[?name=='ENABLED_FEATURES' || name=='NODE_ENV' || name=='LOG_LEVEL']" \
            --output table
      
      - name: ðŸ”„ Restart Application
        if: inputs.restart_after == true
        run: |
          echo "ðŸ”„ Restarting application to apply changes..."
          az webapp restart \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }}
          
          echo "â³ Waiting 30 seconds for app to restart..."
          sleep 30
      
      - name: âœ… Health Check
        if: inputs.restart_after == true
        run: |
          echo "ðŸ¥ Checking application health..."
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.MUSIC_APP_NAME }}.azurewebsites.net/health || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Application is healthy (HTTP $HTTP_CODE)"
              curl -s https://${{ env.MUSIC_APP_NAME }}.azurewebsites.net/health | jq '.' || true
              exit 0
            else
              echo "â³ Health check failed (HTTP $HTTP_CODE), retrying... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep 15
            fi
          done
          
          echo "âš ï¸  Health check did not pass after $MAX_RETRIES attempts"
          echo "â„¹ï¸  Check application logs for details"
          exit 1

  # =============================================================================
  # Update Configuration: Advanced Settings
  # =============================================================================
  update-config:
    name: ðŸ”§ Update Configuration
    runs-on: ubuntu-latest
    if: inputs.operation == 'update-config'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸ”§ Update Configuration
        run: |
          echo "ðŸ”§ Updating application configuration..."
          
          # Update all configuration settings
          az webapp config appsettings set \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }} \
            --settings \
              PORT="8080" \
              WEBSITES_PORT="8080" \
              NODE_ENV="${{ inputs.node_env }}" \
              LOG_LEVEL="${{ inputs.log_level }}" \
              ENABLED_FEATURES="${{ inputs.features }}" \
              ENVIRONMENT="${{ inputs.environment }}" \
              WEBSITES_CONTAINER_START_TIME_LIMIT="600" \
              WEBSITE_HTTPLOGGING_RETENTION_DAYS="7" \
              LAST_CONFIG_UPDATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          echo "âœ… Configuration updated successfully"
      
      - name: ðŸ”„ Restart if requested
        if: inputs.restart_after == true
        run: |
          echo "ðŸ”„ Restarting application..."
          az webapp restart \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }}
          
          sleep 30
          
          echo "âœ… Application restarted"

  # =============================================================================
  # Restart Application: Simple Restart
  # =============================================================================
  restart-app:
    name: ðŸ”„ Restart Application
    runs-on: ubuntu-latest
    if: inputs.operation == 'restart-app'
    
    steps:
      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ðŸ”„ Restart Application
        run: |
          echo "ðŸ”„ Restarting ${{ env.MUSIC_APP_NAME }}..."
          
          az webapp restart \
            --name ${{ env.MUSIC_APP_NAME }} \
            --resource-group ${{ env.MUSIC_RG }}
          
          echo "â³ Waiting 30 seconds for restart..."
          sleep 30
          
          echo "âœ… Application restarted"
      
      - name: ðŸ¥ Health Check
        run: |
          echo "ðŸ¥ Checking application health..."
          
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.MUSIC_APP_NAME }}.azurewebsites.net/health || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Application is healthy"
              exit 0
            fi
            
            echo "â³ Attempt $i/5 - HTTP $HTTP_CODE, waiting..."
            sleep 15
          done
          
          echo "âš ï¸  Application may not be fully healthy yet"

  # =============================================================================
  # Summary: Report Results
  # =============================================================================
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [dry-run, enable-features, update-config, restart-app]
    if: always()
    
    steps:
      - name: ðŸ“Š Report Summary
        run: |
          echo "# Feature Management Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Operation:** ${{ inputs.operation }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Features:** ${{ inputs.features }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Links ðŸ”—" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ [Application URL](https://${{ env.MUSIC_APP_NAME }}.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¥ [Health Endpoint](https://${{ env.MUSIC_APP_NAME }}.azurewebsites.net/health)" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸  [Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.MUSIC_RG }}/providers/Microsoft.Web/sites/${{ env.MUSIC_APP_NAME }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Updated: $(date -u +%Y-%m-%d\ %H:%M:%S) UTC*" >> $GITHUB_STEP_SUMMARY
