name: Try Run - Quick Deploy

on:
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip npm install and build steps'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      deploy_only_files:
        description: 'Deploy only specific files (comma-separated paths, e.g., app/public/haos-platform.html,app/public/js/haos-audio-engine.js)'
        required: false
        default: ''
        type: string

jobs:
  try-run-deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“ Display deployment info
        run: |
          echo "ğŸš€ Try Run Deployment Started"
          echo "Skip Build: ${{ github.event.inputs.skip_build }}"
          echo "Files to deploy: ${{ github.event.inputs.deploy_only_files }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸ”§ Setup Node.js (conditional)
        if: ${{ github.event.inputs.skip_build == 'false' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: ğŸ“¦ Install dependencies (conditional)
        if: ${{ github.event.inputs.skip_build == 'false' }}
        run: |
          cd app
          npm ci
      
      - name: ğŸ—ï¸ Build app (conditional)
        if: ${{ github.event.inputs.skip_build == 'false' }}
        run: |
          cd app
          npm run build --if-present
      
      - name: ğŸ“¤ Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'notesapp-dev-music-app'
          package: './app'
      
      - name: âš™ï¸ Configure Web App Settings
        run: |
          echo "Configuring app settings..."
          az webapp config appsettings set \
            --name notesapp-dev-music-app \
            --resource-group notesapp-dev-rg \
            --settings \
              NODE_ENV=production \
              PORT=8080 \
              WEBSITES_PORT=8080
          echo "âœ… Web app configuration complete"
      
      - name: ğŸ‰ Deployment Summary
        run: |
          echo "âœ… Try Run Deployment Complete!"
          echo ""
          echo "ğŸŒ App URL: https://notesapp-dev-music-app.azurewebsites.net"
          echo "ğŸ“» Radio Studio: https://notesapp-dev-music-app.azurewebsites.net/haos-platform.html"
          echo ""
          echo "â±ï¸ Deployment Type: ${{ github.event.inputs.skip_build == 'true' && 'Quick Deploy (no build)' || 'Full Deploy (with build)' }}"
          echo "ğŸ“ Files: ${{ github.event.inputs.deploy_only_files || 'All files' }}"
          echo ""
          echo "ğŸ”„ Changes should be live in ~2-3 minutes"
      
      - name: ğŸ’¬ Post deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "::notice::ğŸ‰ Try Run deployment succeeded! App is deploying to Azure."
          else
            echo "::error::âŒ Try Run deployment failed. Check the logs above."
          fi
