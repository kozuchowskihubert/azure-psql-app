# =============================================================================
# Quick Rebuild and Deploy Pipeline
# =============================================================================
# 
# Simple CI/CD pipeline that rebuilds the Docker image and deploys to Azure.
# NO infrastructure changes - just build and deploy the application.
#
# Use this workflow when:
#   - You've made code changes and want to deploy quickly
#   - You need to rebuild the image without touching Terraform
#   - Quick iterations on frontend/backend code
#
# For infrastructure changes, use: deploy-music-app.yml
# =============================================================================

name: ðŸš€ Rebuild & Deploy (Azure - DISABLED, using Vercel)

on:
  # Disabled automatic triggers - using Vercel for deployments
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'app/**'
  #     - 'Dockerfile*'
  #     - 'package.json'
  #     - '!app/**/*.md'
  #     - '!**/*.test.js'
  workflow_dispatch:
    inputs:
      force_no_cache:
        description: 'Build without Docker cache'
        required: false
        default: false
        type: boolean

env:
  ACR_NAME: notesappdevacr14363
  IMAGE_NAME: notesapp-music
  AZURE_WEBAPP_NAME: notesapp-music-dev
  RESOURCE_GROUP: notes-app-dev-music-rg

jobs:
  # ---------------------------------------------------------------------------
  # Build Docker Image
  # ---------------------------------------------------------------------------
  build:
    name: ðŸ³ Build Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Log in to Azure Container Registry
        run: |
          echo "Authenticating with ACR: ${{ env.ACR_NAME }}.azurecr.io"
          echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ env.ACR_NAME }}.azurecr.io \
            --username ${{ secrets.ACR_USERNAME }} \
            --password-stdin
          echo "âœ… Successfully authenticated with ACR"

      - name: ðŸ·ï¸ Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.music
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max
          no-cache: ${{ github.event.inputs.force_no_cache == 'true' }}

      - name: ðŸ“Š Build Summary
        run: |
          echo "### ðŸ³ Docker Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | \`${{ steps.meta.outputs.tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Deploy to Azure Web App
  # ---------------------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build
    environment: dev
    steps:
      - name: ðŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸš€ Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

      - name: ðŸ”„ Restart Web App
        run: |
          echo "ðŸ”„ Restarting web app to pull new image..."
          az webapp restart --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}
          echo "âœ… Web app restarted"

      - name: â³ Wait for Deployment
        run: |
          echo "â³ Waiting 30s for container to start..."
          sleep 30

      - name: ðŸ¥ Health Check
        run: |
          echo "ðŸ¥ Checking application health..."
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed!"
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES - HTTP $HTTP_CODE, waiting 15s..."
            sleep 15
          done
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ Health check did not return 200, but deployment completed"
          fi

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | \`${{ env.AZURE_WEBAPP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Open Application](https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
