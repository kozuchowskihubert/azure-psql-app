# =============================================================================
# Azure Infrastructure Deployment & Application CI/CD Pipeline
# =============================================================================
# 
# This workflow provides complete infrastructure provisioning and application
# deployment for the Azure PostgreSQL Notes Application.
#
# Workflow Stages:
#   1. Validate    - Code linting, tests, Terraform validation
#   2. Build       - Docker image build and push to ACR
#   3. Provision   - Infrastructure deployment with Terraform
#   4. Deploy      - Application deployment to Azure Web App
#   5. Verify      - Health checks and endpoint testing
#   6. Notify      - Deployment status reporting
#
# Prerequisites:
#   - GitHub Secrets configured (see .github/SECRETS_SETUP.md)
#   - Azure Service Principal with Contributor access
#   - Azure Container Registry created
#   - Terraform backend storage configured
#
# Local Testing:
#   - Fast: ./scripts/deploy.sh [all|infra|image|verify]
#   - Simulate: ./scripts/test-cicd-local.sh [validate|build|infra|deploy|all]
#   - Accurate: ./scripts/run-act.sh [validate|build|infra|all]
#
# Documentation:
#   - Architecture: docs/ARCHITECTURE.md
#   - Deployment Guide: docs/DEPLOYMENT.md
#   - Troubleshooting: docs/TROUBLESHOOTING.md
#   - Act Usage: docs/ACT_USAGE.md
# =============================================================================

name: Deploy Azure Infrastructure & Application

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'azure-psql-app/docs/**'
      - '**.md'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_verification:
        description: 'Skip health checks and verification'
        required: false
        default: false
        type: boolean

# Global environment variables
env:
  ACR_NAME: notesappdevacr14363
  IMAGE_NAME: notesapp
  AZURE_REGION: westus2
  TERRAFORM_VERSION: '~1.5'
  NODE_VERSION: '20'

# =============================================================================
# Jobs
# =============================================================================

jobs:
  # ---------------------------------------------------------------------------
  # Stage 1: Validation
  # ---------------------------------------------------------------------------
  # Validates code quality, tests, and infrastructure configuration
  # - Runs on all pushes and pull requests
  # - Gates all subsequent deployment stages
  # ----------------------------------xx-----------------------------------------
  validate:
    name: Validate Code & Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: azure-psql-app/app/package-lock.json

      - name: üîß Install dependencies
        working-directory: ./azure-psql-app/app
        run: |
          echo "Installing npm packages..."
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      - name: üîç Run linting
        working-directory: ./azure-psql-app/app
        run: |
          if npm run lint 2>/dev/null; then
            echo "‚úÖ Linting passed"
          else
            echo "‚ö†Ô∏è No lint script found, skipping..."
          fi

      - name: üß™ Run tests
        working-directory: ./azure-psql-app/app
        run: |
          if npm test 2>/dev/null; then
            echo "‚úÖ Tests passed"
          else
            echo "‚ö†Ô∏è No tests found, skipping..."
          fi

      - name: üèóÔ∏è Setup Terraform ${{ env.TERRAFORM_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: üìù Terraform Format Check
        working-directory: ./azure-psql-app/infra
        run: |
          echo "Checking Terraform formatting..."
          terraform fmt -check -recursive
          echo "‚úÖ Terraform formatting is correct"

      - name: üîß Terraform Init (validation only)
        working-directory: ./azure-psql-app/infra
        run: |
          echo "Initializing Terraform (no backend)..."
          terraform init -backend=false
          echo "‚úÖ Terraform initialized successfully"

      - name: ‚úÖ Terraform Validate
        working-directory: ./azure-psql-app/infra
        run: |
          echo "Validating Terraform configuration..."
          terraform validate
          echo "‚úÖ Terraform configuration is valid"
      
      - name: üìä Validation Summary
        if: always()
        run: |
          echo "### ‚úÖ Validation Stage Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Setup | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Format | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Stage 2: Build & Push
  # ---------------------------------------------------------------------------
  # Builds Docker image and pushes to Azure Container Registry
  # - Only runs on push to main (not pull requests)
  # - Uses BuildKit with layer caching for faster builds
  # - Generates multiple tags (latest, branch, sha)
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: github.event_name != 'pull_request'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      image-full: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest

      - name: üîê Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üîê Log in to Azure Container Registry
        run: |
          echo "Authenticating with ACR: ${{ env.ACR_NAME }}.azurecr.io"
          az acr login --name ${{ env.ACR_NAME }}
          echo "‚úÖ Successfully authenticated with ACR"

      - name: üè∑Ô∏è Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: üê≥ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./azure-psql-app
          file: ./azure-psql-app/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:buildcache,mode=max
          platforms: linux/amd64
          provenance: false
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: üìä Output image details
        run: |
          echo "### üê≥ Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.ACR_NAME }}.azurecr.io\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Stage 3: Deploy Infrastructure
  # ---------------------------------------------------------------------------
  # Provisions Azure infrastructure using Terraform
  # - Creates/updates: VNet, subnets, PostgreSQL, App Service, ACR
  # - Uses Azure backend for state management
  # - Outputs infrastructure details for subsequent stages
  # ---------------------------------------------------------------------------
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      app-url: ${{ steps.output.outputs.app-url }}
      db-host: ${{ steps.output.outputs.db-host }}
      rg-name: ${{ steps.output.outputs.rg-name }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Terraform ${{ env.TERRAFORM_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üîß Terraform Init
        working-directory: ./azure-psql-app/infra
        run: |
          echo "Initializing Terraform with Azure backend..."
          terraform init
          echo "‚úÖ Terraform initialized successfully"
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}

      - name: üìã Terraform Plan
        id: plan
        working-directory: ./azure-psql-app/infra
        run: |
          echo "Planning infrastructure changes..."
          terraform plan \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="location=${{ env.AZURE_REGION }}" \
            -out=tfplan \
            -no-color | tee plan.txt
          
          # Count resource changes
          CHANGES=$(grep -E "Plan:|No changes" plan.txt || echo "Unknown")
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
          echo "‚úÖ Terraform plan complete"
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}

      - name: üöÄ Terraform Apply
        working-directory: ./azure-psql-app/infra
        run: |
          echo "Applying infrastructure changes..."
          terraform apply -auto-approve tfplan
          echo "‚úÖ Infrastructure deployed successfully"
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}

      - name: üì§ Get Terraform Outputs
        id: output
        working-directory: ./azure-psql-app/infra
        run: |
          echo "Extracting Terraform outputs..."
          
          APP_URL=$(terraform output -raw app_url 2>/dev/null || echo "")
          DB_HOST=$(terraform output -raw database_fqdn 2>/dev/null || echo "")
          RG_NAME=$(terraform output -raw resource_group_name 2>/dev/null || echo "notesapp-dev-rg")
          
          echo "app-url=$APP_URL" >> $GITHUB_OUTPUT
          echo "db-host=$DB_HOST" >> $GITHUB_OUTPUT
          echo "rg-name=$RG_NAME" >> $GITHUB_OUTPUT
          
          echo "### üèóÔ∏è Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes:** ${{ steps.plan.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** $APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Database Host:** $DB_HOST" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AZURE_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** $RG_NAME" >> $GITHUB_STEP_SUMMARY
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_ACCESS_KEY: ${{ secrets.ARM_ACCESS_KEY }}

  # ---------------------------------------------------------------------------
  # Stage 4: Deploy Application
  # ---------------------------------------------------------------------------
  # Deploys containerized application to Azure Web App
  # - Pulls latest image from ACR
  # - Updates Web App configuration
  # - Restarts application for clean deployment
  # ---------------------------------------------------------------------------
  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-infrastructure]
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üîç Get Web App Name
        id: webapp
        run: |
          echo "Fetching Web App name from resource group..."
          WEBAPP_NAME=$(az webapp list \
            --resource-group notesapp-dev-rg \
            --query "[0].name" \
            --output tsv)
          
          if [ -z "$WEBAPP_NAME" ]; then
            echo "‚ùå Error: No Web App found in resource group"
            exit 1
          fi
          
          echo "name=$WEBAPP_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Found Web App: $WEBAPP_NAME"

      - name: üöÄ Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.webapp.outputs.name }}
          images: ${{ needs.build-and-push.outputs.image-full }}

      - name: üîÑ Restart Web App
        run: |
          echo "Restarting Web App for clean deployment..."
          az webapp restart \
            --name ${{ steps.webapp.outputs.name }} \
            --resource-group notesapp-dev-rg
          echo "‚úÖ Web App restarted successfully"

      - name: üìä Output deployment info
        run: |
          echo "### üöÄ Application Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Web App:** \`${{ steps.webapp.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ needs.build-and-push.outputs.image-full }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ needs.build-and-push.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`notesapp-dev-rg\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Waiting for application startup and running health checks..."

  # ---------------------------------------------------------------------------
  # Stage 5: Verify Deployment
  # ---------------------------------------------------------------------------
  # Validates deployment health and functionality
  # - Waits for application startup (30 seconds)
  # - Performs health checks with retries
  # - Tests API endpoints
  # - Can be skipped with workflow_dispatch input
  # ---------------------------------------------------------------------------
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-application]
    if: github.event.inputs.skip_verification != 'true'
    steps:
      - name: ‚è≥ Wait for application startup
        run: |
          echo "Waiting 30 seconds for application to fully start..."
          sleep 30
          echo "‚úÖ Wait complete, beginning health checks"

      - name: üè• Health Check
        id: health
        run: |
          APP_URL="${{ needs.deploy-infrastructure.outputs.app-url }}"
          
          if [ -z "$APP_URL" ]; then
            echo "‚ùå Error: App URL is empty"
            exit 1
          fi
          
          echo "Testing health endpoint: $APP_URL/health"
          
          # Retry logic with exponential backoff
          MAX_ATTEMPTS=5
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" "$APP_URL/health" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed! (HTTP $HTTP_CODE)"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "‚ö†Ô∏è Received HTTP $HTTP_CODE, retrying in $((ATTEMPT * 10))s..."
            sleep $((ATTEMPT * 10))
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: üß™ Test Notes Endpoint
        if: steps.health.outputs.healthy == 'true'
        run: |
          APP_URL="${{ needs.deploy-infrastructure.outputs.app-url }}"
          
          echo "Testing notes endpoint: $APP_URL/notes"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$APP_URL/notes" || echo "Error\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Notes endpoint is working! (HTTP $HTTP_CODE)"
            if command -v jq &> /dev/null; then
              echo "$BODY" | jq '.' || echo "$BODY"
            else
              echo "$BODY"
            fi
          else
            echo "‚ö†Ô∏è Notes endpoint returned HTTP $HTTP_CODE"
            echo "$BODY"
          fi

      - name: üîç Test Database Connection
        if: steps.health.outputs.healthy == 'true'
        run: |
          APP_URL="${{ needs.deploy-infrastructure.outputs.app-url }}"
          
          echo "Testing database connectivity through app..."
          
          # Try to create a test note
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "$APP_URL/notes" \
            -H "Content-Type: application/json" \
            -d '{"title":"CI/CD Test","content":"Automated deployment verification"}' \
            || echo "Error\n000")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Database connection is working! (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Database test returned HTTP $HTTP_CODE (this may be expected if DB is not fully ready)"
          fi

      - name: üìä Deployment Summary
        if: always()
        run: |
          HEALTH_STATUS="${{ steps.health.outputs.healthy }}"
          
          echo "### ‚úÖ Deployment Verification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HEALTH_STATUS" = "true" ]; then
            echo "**Status:** ‚úÖ Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ‚ùå Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**URL:** ${{ needs.deploy-infrastructure.outputs.app-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database:** ${{ needs.deploy-infrastructure.outputs.db-host }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Application Home](${{ needs.deploy-infrastructure.outputs.app-url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Health Check](${{ needs.deploy-infrastructure.outputs.app-url }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Notes API](${{ needs.deploy-infrastructure.outputs.app-url }}/notes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üìù Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Health Check: ${{ steps.health.outputs.healthy == 'true' && '‚úÖ Passed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Notes Endpoint: Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Database Connection: Tested" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Stage 6: Notify
  # ---------------------------------------------------------------------------
  # Final deployment status notification
  # - Summarizes deployment results
  # - Provides rollback instructions if needed
  # - Always runs regardless of previous stage results
  # ---------------------------------------------------------------------------
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate, build-and-push, deploy-infrastructure, deploy-application, verify-deployment]
    if: always()
    steps:
      - name: üìä Collect Deployment Status
        id: status
        run: |
          # Determine overall status
          VALIDATE="${{ needs.validate.result }}"
          BUILD="${{ needs.build-and-push.result }}"
          INFRA="${{ needs.deploy-infrastructure.result }}"
          DEPLOY="${{ needs.deploy-application.result }}"
          VERIFY="${{ needs.verify-deployment.result }}"
          
          echo "### üéØ Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1. Validate | ${{ needs.validate.result == 'success' && '‚úÖ' || '‚ùå' }} $VALIDATE |" >> $GITHUB_STEP_SUMMARY
          echo "| 2. Build & Push | ${{ needs.build-and-push.result == 'success' && '‚úÖ' || needs.build-and-push.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} $BUILD |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. Deploy Infrastructure | ${{ needs.deploy-infrastructure.result == 'success' && '‚úÖ' || needs.deploy-infrastructure.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} $INFRA |" >> $GITHUB_STEP_SUMMARY
          echo "| 4. Deploy Application | ${{ needs.deploy-application.result == 'success' && '‚úÖ' || needs.deploy-application.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} $DEPLOY |" >> $GITHUB_STEP_SUMMARY
          echo "| 5. Verify Deployment | ${{ needs.verify-deployment.result == 'success' && '‚úÖ' || needs.verify-deployment.result == 'skipped' && '‚è≠Ô∏è' || '‚ùå' }} $VERIFY |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Set overall status
          if [[ "$VALIDATE" == "success" ]] && \
             ([[ "$BUILD" == "success" ]] || [[ "$BUILD" == "skipped" ]]) && \
             ([[ "$INFRA" == "success" ]] || [[ "$INFRA" == "skipped" ]]) && \
             ([[ "$DEPLOY" == "success" ]] || [[ "$DEPLOY" == "skipped" ]]) && \
             ([[ "$VERIFY" == "success" ]] || [[ "$VERIFY" == "skipped" ]]); then
            echo "overall=success" >> $GITHUB_OUTPUT
          else
            echo "overall=failure" >> $GITHUB_OUTPUT
          fi

      - name: üéâ Success Notification
        if: steps.status.outputs.overall == 'success'
        run: |
          echo "### ‚úÖ Deployment Successful! üéâ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All deployment stages completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üìö Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor application: [Azure Portal](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY
          echo "- View logs: \`az webapp log tail --name <webapp-name> --resource-group notesapp-dev-rg\`" >> $GITHUB_STEP_SUMMARY
          echo "- Check metrics: [Application Insights](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Failure Notification
        if: steps.status.outputs.overall == 'failure'
        run: |
          echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more deployment stages failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üîß Troubleshooting Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review error messages in failed stages above" >> $GITHUB_STEP_SUMMARY
          echo "2. Check [Troubleshooting Guide](../blob/main/docs/TROUBLESHOOTING.md)" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify GitHub Secrets are configured: [Secrets Setup](../blob/main/.github/SECRETS_SETUP.md)" >> $GITHUB_STEP_SUMMARY
          echo "4. Test locally using:" >> $GITHUB_STEP_SUMMARY
          echo "   - \`./scripts/deploy.sh all\` (fastest)" >> $GITHUB_STEP_SUMMARY
          echo "   - \`./scripts/test-cicd-local.sh all\` (simulation)" >> $GITHUB_STEP_SUMMARY
          echo "   - \`./scripts/run-act.sh all\` (accurate)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### üîÑ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
          echo "If needed, rollback to previous version:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Find previous working commit" >> $GITHUB_STEP_SUMMARY
          echo "git log --oneline -n 10" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Deploy specific commit" >> $GITHUB_STEP_SUMMARY
          echo "git checkout <commit-sha>" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/deploy.sh all" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: üö® Final Status
        run: |
          if [ "${{ steps.status.outputs.overall }}" = "success" ]; then
            echo "üéâ All stages completed successfully!"
            exit 0
          else
            echo "‚ùå Deployment pipeline failed - check logs above for details"
            exit 1
          fi
