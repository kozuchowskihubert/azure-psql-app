name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'README.md'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  validate-documentation:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          folder-path: 'docs'
        continue-on-error: true

      - name: Validate Mermaid diagrams
        run: |
          echo "Checking for Mermaid diagram syntax..."
          # Check if Mermaid diagrams are properly formatted
          grep -r '```mermaid' docs/ || echo "No Mermaid diagrams found"
          echo "‚úì Mermaid diagram check complete"

      - name: Check documentation structure
        run: |
          echo "Validating documentation structure..."
          
          # Check required files exist
          required_files=(
            "docs/technical/ARCHITECTURE.md" 
            "docs/technical/DEPLOYMENT.md" 
            "docs/technical/TROUBLESHOOTING.md" 
            "docs/business/EXECUTIVE_SUMMARY.md"
            "docs/business/ROADMAP.md"
            "docs/user-guides/EXCEL_GUIDE.md"
            "README.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úì Found: $file"
            else
              echo "‚úó Missing: $file"
              exit 1
            fi
          done
          
          echo "‚úì All required documentation files present"

      - name: Count documentation metrics
        run: |
          echo "üìä Documentation Metrics"
          echo "========================"
          
          # Count total lines of documentation
          total_lines=$(find docs -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}')
          echo "Total documentation lines: $total_lines"
          
          # Count Mermaid diagrams
          mermaid_count=$(grep -r "```mermaid" docs/ | wc -l)
          echo "Mermaid diagrams: $mermaid_count"
          
          # Count sections (## headers)
          section_count=$(grep -r "^## " docs/ | wc -l)
          echo "Total sections: $section_count"
          
          echo ""
          echo "üìÑ Documentation by file:"
          find docs -name "*.md" -exec wc -l {} + | sort -nr

  generate-docs-site:
    name: Generate Documentation Site
    runs-on: ubuntu-latest
    needs: validate-documentation
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install markdown-to-html converter
        run: |
          npm install -g markdown-html

      - name: Create documentation index
        run: |
          mkdir -p docs-site
          
          cat > docs-site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Azure PostgreSQL App - Documentation</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 10px;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                      padding: 40px;
                  }
                  h1 {
                      color: #667eea;
                      margin-bottom: 10px;
                      font-size: 2.5em;
                  }
                  .subtitle {
                      color: #666;
                      margin-bottom: 30px;
                      font-size: 1.2em;
                  }
                  .doc-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                      margin-top: 30px;
                  }
                  .doc-card {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 25px;
                      border-left: 4px solid #667eea;
                      transition: transform 0.2s, box-shadow 0.2s;
                  }
                  .doc-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
                  }
                  .doc-card h2 {
                      color: #667eea;
                      margin-bottom: 10px;
                      font-size: 1.5em;
                  }
                  .doc-card p {
                      color: #666;
                      margin-bottom: 15px;
                  }
                  .doc-card a {
                      display: inline-block;
                      color: #667eea;
                      text-decoration: none;
                      font-weight: 600;
                      transition: color 0.2s;
                  }
                  .doc-card a:hover {
                      color: #764ba2;
                  }
                  .metrics {
                      background: #e3f2fd;
                      border-radius: 8px;
                      padding: 20px;
                      margin: 30px 0;
                      display: flex;
                      justify-content: space-around;
                      flex-wrap: wrap;
                  }
                  .metric {
                      text-align: center;
                      padding: 10px;
                  }
                  .metric-value {
                      font-size: 2em;
                      font-weight: bold;
                      color: #667eea;
                  }
                  .metric-label {
                      color: #666;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ Azure PostgreSQL App</h1>
                  <p class="subtitle">Comprehensive Documentation for Cloud-Native Deployment</p>
                  
                  <div class="metrics">
                      <div class="metric">
                          <div class="metric-value">3</div>
                          <div class="metric-label">Documentation Guides</div>
                      </div>
                      <div class="metric">
                          <div class="metric-value">25+</div>
                          <div class="metric-label">Mermaid Diagrams</div>
                      </div>
                      <div class="metric">
                          <div class="metric-value">100%</div>
                          <div class="metric-label">CI/CD Coverage</div>
                      </div>
                  </div>
                  
                  <div class="doc-grid">
                      <div class="doc-card">
                          <h2>üèóÔ∏è Architecture</h2>
                          <p>Complete system architecture, component descriptions, network design, and infrastructure diagrams.</p>
                          <a href="https://github.com/kozuchowskihubert/azure-psql-app/blob/main/docs/ARCHITECTURE.md">View Architecture ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h2>üöÄ Deployment Guide</h2>
                          <p>Step-by-step deployment instructions, CI/CD pipeline setup, and infrastructure provisioning.</p>
                          <a href="https://github.com/kozuchowskihubert/azure-psql-app/blob/main/docs/DEPLOYMENT.md">View Deployment ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h2>üîß Troubleshooting</h2>
                          <p>Common issues, solutions, debugging tips, and lessons learned from production deployment.</p>
                          <a href="https://github.com/kozuchowskihubert/azure-psql-app/blob/main/docs/TROUBLESHOOTING.md">View Troubleshooting ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h2>üìñ README</h2>
                          <p>Quick start guide, project overview, and links to all documentation resources.</p>
                          <a href="https://github.com/kozuchowskihubert/azure-psql-app/blob/main/README.md">View README ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h2>üîÑ Automation Scripts</h2>
                          <p>Infrastructure recreation scripts and automation tools for deployment management.</p>
                          <a href="https://github.com/kozuchowskihubert/azure-psql-app/tree/main/scripts">View Scripts ‚Üí</a>
                      </div>
                      
                      <div class="doc-card">
                          <h2>‚öôÔ∏è Terraform Configuration</h2>
                          <p>Infrastructure as Code configurations, variables, and resource definitions.</p>
                          <a href="https://github.com/kozuchowskihubert/azure-psql-app/tree/main/infra">View IaC ‚Üí</a>
                      </div>
                  </div>
                  
                  <div style="margin-top: 40px; text-align: center; color: #666;">
                      <p>Generated automatically by GitHub Actions</p>
                      <p>Last updated: <span id="timestamp"></span></p>
                  </div>
              </div>
              
              <script>
                  document.getElementById('timestamp').textContent = new Date().toLocaleString();
              </script>
          </body>
          </html>
          EOF

      - name: Create Mermaid viewer page
        run: |
          cat > docs-site/diagrams.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Architecture Diagrams - Azure PostgreSQL App</title>
              <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 1400px;
                      margin: 0 auto;
                      padding: 20px;
                      background: #f5f5f5;
                  }
                  h1 { color: #667eea; }
                  .diagram {
                      background: white;
                      padding: 30px;
                      margin: 20px 0;
                      border-radius: 8px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
              </style>
          </head>
          <body>
              <h1>üìä Architecture Diagrams</h1>
              <p>Interactive Mermaid diagrams from the documentation</p>
              
              <div class="diagram">
                  <h2>System Architecture Overview</h2>
                  <p>See <a href="https://github.com/kozuchowskihubert/azure-psql-app/blob/main/docs/ARCHITECTURE.md">ARCHITECTURE.md</a> for all diagrams</p>
              </div>
              
              <script>
                  mermaid.initialize({ startOnLoad: true, theme: 'default' });
              </script>
          </body>
          </html>
          EOF

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v3
        with:
          name: documentation-site
          path: docs-site/

      - name: Documentation summary
        run: |
          echo "‚úÖ Documentation validation and generation complete!"
          echo ""
          echo "üìö Documentation available at:"
          echo "- Architecture: docs/ARCHITECTURE.md"
          echo "- Deployment: docs/DEPLOYMENT.md"
          echo "- Troubleshooting: docs/TROUBLESHOOTING.md"
          echo ""
          echo "View the generated site in the artifacts."
