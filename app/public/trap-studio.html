<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Professional Trap & Hip-Hop Production Studio - Beat maker, chord progression generator, 808 designer">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trap Studio">
    
    <title>üî• Trap & Hip-Hop Production Studio üî•</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Trap Theme */
            --bg-primary: #0f0f1e;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --accent-primary: #ff2e63;
            --accent-secondary: #08d9d6;
            --accent-gold: #ffd700;
            --text-primary: #eee;
            --text-secondary: #a8a8a8;
            --success: #00ff41;
            --warning: #ff9800;
            --border: #2d2d44;
            --glow: rgba(255, 46, 99, 0.5);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 46, 99, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(8, 217, 214, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-bottom: 2px solid var(--accent-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px var(--glow);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px var(--glow)); }
            50% { filter: drop-shadow(0 0 20px var(--glow)); }
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tool Cards */
        .tool-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .tool-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(255, 46, 99, 0.2);
        }

        .tool-section h2 {
            color: var(--accent-primary);
            font-size: 2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-section h3 {
            color: var(--accent-secondary);
            font-size: 1.4em;
            margin: 20px 0 10px 0;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--accent-primary), #d91e4e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 46, 99, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(255, 46, 99, 0.5);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-secondary), #06b8b5);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 25px rgba(8, 217, 214, 0.5);
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--accent-gold), #ffed4e);
            color: var(--bg-primary);
        }

        /* Input Controls */
        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        select, input[type="range"], input[type="number"] {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1em;
        }

        input[type="range"] {
            padding: 0;
            height: 40px;
        }

        /* Chord Display */
        .chord-display {
            background: var(--bg-tertiary);
            border: 2px solid var(--accent-primary);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
        }

        .chord-item {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-left: 4px solid var(--accent-gold);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .chord-item:hover {
            transform: translateX(10px);
            border-left-color: var(--accent-primary);
        }

        .chord-name {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .chord-notes {
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        /* Beat Grid */
        .beat-grid {
            display: grid;
            grid-template-columns: auto repeat(16, 1fr);
            gap: 4px;
            margin: 20px 0;
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
        }

        .beat-label {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: var(--text-secondary);
            padding: 8px;
            font-weight: 600;
        }

        .beat-step {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .beat-step:hover {
            border-color: var(--accent-secondary);
            transform: scale(1.1);
        }

        .beat-step.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px var(--glow);
        }

        .beat-step.bar-marker {
            border-left: 3px solid var(--accent-gold);
        }

        /* ============================================ */
        /* DAW ARRANGEMENT TIMELINE STYLES */
        /* ============================================ */
        
        .pattern-block {
            padding: 12px 8px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 2px solid var(--accent-secondary);
            border-radius: 8px;
            text-align: center;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .pattern-block:hover {
            border-color: var(--accent-gold);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px var(--glow);
        }
        
        .pattern-block:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        
        .pattern-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .pattern-name {
            font-size: 0.75em;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .timeline-track {
            display: flex;
            margin-bottom: 8px;
            min-height: 60px;
            position: relative;
        }
        
        .track-label {
            width: 120px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px 0 0 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .track-icon {
            font-size: 1.2em;
        }
        
        .track-content {
            flex: 1;
            background: linear-gradient(90deg, 
                rgba(255, 46, 99, 0.05) 0%, 
                rgba(255, 46, 99, 0.05) 25%, 
                transparent 25%, 
                transparent 50%,
                rgba(255, 46, 99, 0.05) 50%,
                rgba(255, 46, 99, 0.05) 75%,
                transparent 75%,
                transparent 100%
            );
            background-size: 25% 100%;
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 8px 8px 0;
            position: relative;
            min-height: 60px;
        }
        
        .track-content.drag-over {
            background-color: rgba(0, 255, 0, 0.1);
            border-color: var(--accent-gold);
        }
        
        .arrangement-block {
            position: absolute;
            top: 5px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: 2px solid var(--accent-gold);
            border-radius: 6px;
            padding: 5px 10px;
            cursor: move;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .arrangement-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--glow);
            z-index: 10;
        }
        
        .arrangement-block-icon {
            font-size: 1.2em;
            margin-bottom: 2px;
        }
        
        .arrangement-block-name {
            font-size: 0.7em;
            color: #000;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        .arrangement-block.kick {
            background: linear-gradient(135deg, #ff2e63, #ff6b9d);
        }
        
        .arrangement-block.snare {
            background: linear-gradient(135deg, #08d9d6, #5ce1e6);
        }
        
        .arrangement-block.hihat {
            background: linear-gradient(135deg, #ffbd39, #ffd66b);
        }
        
        .arrangement-block.bass-808 {
            background: linear-gradient(135deg, #9d4edd, #c77dff);
        }
        
        .arrangement-block.melody {
            background: linear-gradient(135deg, #06ffa5, #38ffb3);
        }
        
        .arrangement-block.fx {
            background: linear-gradient(135deg, #ff006e, #ff4d8f);
        }

        /* 808 Designer */
        .waveform-display {
            width: 100%;
            height: 150px;
            background: var(--bg-tertiary);
            border: 2px solid var(--accent-secondary);
            border-radius: 10px;
            margin: 15px 0;
        }

        /* Preset Cards */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .preset-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .preset-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 46, 99, 0.3);
        }

        .preset-card.selected {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
        }

        .preset-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .preset-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .preset-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Output Display */
        .output-box {
            background: var(--bg-primary);
            border: 2px solid var(--accent-secondary);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            color: var(--success);
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .output-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* BPM Display */
        .bpm-display {
            font-size: 3em;
            font-weight: 700;
            color: var(--accent-gold);
            text-align: center;
            margin: 15px 0;
            text-shadow: 0 0 20px var(--glow);
        }

        /* Grid Layout */
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge.active {
            background: var(--success);
            color: var(--bg-primary);
        }

        .status-badge.inactive {
            background: var(--text-secondary);
            color: var(--bg-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .tool-section h2 {
                font-size: 1.5em;
            }

            .beat-grid {
                grid-template-columns: auto repeat(8, 1fr);
            }

            .beat-step {
                width: 32px;
                height: 32px;
            }

            .tool-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Animation for new elements */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animated {
            animation: slideIn 0.5s ease-out;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            white-space: nowrap;
            border: 1px solid var(--accent-primary);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Key Display */
        .key-display {
            display: inline-block;
            background: var(--bg-tertiary);
            border: 2px solid var(--accent-gold);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.2em;
            color: var(--accent-gold);
            margin: 10px 5px;
        }

        /* Export Button */
        .export-btn {
            background: linear-gradient(135deg, var(--accent-gold), #ffed4e);
            color: var(--bg-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .export-btn:hover {
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.5);
        }

        /* ============================================
           LIVE GUIDANCE SYSTEM
           ============================================ */
        
        .guidance-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
            border: 2px solid var(--accent-primary);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(255, 46, 99, 0.4);
            z-index: 1000;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .guidance-panel.minimized {
            width: 60px;
            height: 60px;
            border-radius: 50%;
        }

        .guidance-header {
            background: linear-gradient(135deg, var(--accent-primary), #d91e4e);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .guidance-header h3 {
            margin: 0;
            font-size: 1em;
            color: white;
        }

        .guidance-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .guidance-panel.minimized .guidance-content {
            display: none;
        }

        .guidance-tip {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-secondary);
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
        }

        .guidance-tip-title {
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        .guidance-tip-text {
            color: var(--text-secondary);
            font-size: 0.85em;
            line-height: 1.4;
        }

        .guidance-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 46, 99, 0.1);
            border-radius: 8px;
        }

        .guidance-step-number {
            background: var(--accent-primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .guidance-step-text {
            font-size: 0.9em;
            color: var(--text-primary);
        }

        /* Enhanced Tooltips */
        .info-tooltip {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: var(--accent-secondary);
            color: var(--bg-primary);
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.75em;
            font-weight: bold;
            cursor: help;
            margin-left: 5px;
            position: relative;
        }

        .info-tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid var(--accent-secondary);
            width: max-content;
            max-width: 250px;
            font-size: 0.85rem;
            font-weight: normal;
            z-index: 1000;
            white-space: normal;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .info-tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--accent-secondary);
        }

        /* Live Feedback Indicators */
        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse-indicator 2s infinite;
        }

        @keyframes pulse-indicator {
            0%, 100% { opacity: 1; box-shadow: 0 0 5px var(--success); }
            50% { opacity: 0.5; box-shadow: 0 0 15px var(--success); }
        }

        .value-display {
            display: inline-block;
            background: rgba(255, 46, 99, 0.2);
            border: 1px solid var(--accent-primary);
            padding: 4px 12px;
            border-radius: 5px;
            font-weight: bold;
            color: var(--accent-gold);
            margin-left: 10px;
            min-width: 60px;
            text-align: center;
        }

        .control-label-enhanced {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .control-description {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 4px;
        }

        /* Section Headers with Icons */
        .section-header-enhanced {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .section-icon {
            font-size: 2.5em;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .section-info {
            flex: 1;
        }

        .section-title {
            font-size: 1.8em;
            color: var(--accent-primary);
            margin: 0;
        }

        .section-subtitle {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-top: 5px;
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .quick-action-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quick-action-btn:hover {
            border-color: var(--accent-secondary);
            background: rgba(8, 217, 214, 0.1);
            transform: translateY(-2px);
        }

        .quick-action-btn.active {
            border-color: var(--accent-primary);
            background: rgba(255, 46, 99, 0.2);
        }

        /* Progress Indicators */
        .progress-tracker {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .progress-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--accent-secondary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--success);
            font-weight: bold;
        }

        .progress-checkbox.completed {
            background: var(--success);
            color: var(--bg-primary);
        }

        .progress-label {
            flex: 1;
            color: var(--text-primary);
        }

        .progress-label.completed {
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        /* ============================================
           LIVE INTERACTIVE FEATURES
           ============================================ */
        
        /* Interactive Tutorial Overlay */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-spotlight {
            position: fixed;
            border: 3px solid var(--accent-gold);
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85), 0 0 30px var(--accent-gold);
            pointer-events: none;
            z-index: 10001;
            transition: all 0.5s ease;
            animation: spotlight-pulse 2s infinite;
        }

        @keyframes spotlight-pulse {
            0%, 100% { 
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85), 0 0 30px var(--accent-gold);
            }
            50% { 
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85), 0 0 50px var(--accent-gold);
            }
        }

        .tutorial-card {
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            border: 2px solid var(--accent-gold);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(255, 215, 0, 0.3);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .tutorial-title {
            font-size: 1.8em;
            color: var(--accent-gold);
            margin-bottom: 15px;
        }

        .tutorial-text {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .tutorial-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .tutorial-btn {
            padding: 12px 24px;
            border: 2px solid var(--accent-gold);
            background: transparent;
            color: var(--accent-gold);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tutorial-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-primary);
            transform: scale(1.05);
        }

        .tutorial-btn.primary {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .tutorial-btn.primary:hover {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        /* Live Parameter Preview */
        .param-preview {
            position: absolute;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 2px solid var(--accent-secondary);
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            box-shadow: 0 5px 20px rgba(8, 217, 214, 0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .param-preview.active {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .param-preview-title {
            color: var(--accent-secondary);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .param-preview-visual {
            width: 100%;
            height: 60px;
            background: var(--bg-secondary);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .param-preview-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
        }

        .param-preview-wave {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Interactive Tooltip Enhancement */
        .info-tooltip.interactive {
            cursor: pointer;
        }

        .info-tooltip.interactive:hover {
            background: var(--accent-gold);
            transform: scale(1.2);
        }

        .tooltip-demo {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 2px solid var(--accent-gold);
            border-radius: 10px;
            padding: 15px;
            min-width: 300px;
            margin-bottom: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 2000;
        }

        .tooltip-demo.active {
            opacity: 1;
            pointer-events: all;
        }

        .tooltip-demo-title {
            color: var(--accent-gold);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tooltip-demo-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .tooltip-demo-btn {
            flex: 1;
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-secondary);
            color: var(--text-primary);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .tooltip-demo-btn:hover {
            background: var(--accent-secondary);
            color: var(--bg-primary);
        }

        /* Welcome Tour Button */
        .tour-button {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-secondary));
            color: var(--bg-primary);
            padding: 15px 25px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
            z-index: 999;
            animation: tour-bounce 2s infinite;
            transition: all 0.3s ease;
        }

        .tour-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.7);
        }

        @keyframes tour-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Toast Notifications */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast {
            animation: slideIn 0.3s ease;
        }

        /* Shortcuts Panel */
        .shortcuts-panel {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 2px solid var(--accent-secondary);
            border-radius: 12px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .shortcuts-panel.minimized {
            height: 50px;
            overflow: hidden;
        }

        .shortcuts-panel h3 {
            color: var(--accent-secondary);
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .shortcuts-panel .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9em;
            border-bottom: 1px solid var(--border);
        }

        .shortcuts-panel .shortcut-key {
            background: var(--bg-primary);
            color: var(--accent-gold);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .shortcuts-panel .shortcut-desc {
            color: var(--text-secondary);
        }

        /* Mode Selector Tabs */
        .mode-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .mode-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .mode-tab:hover::before {
            left: 100%;
        }

        .mode-tab:hover {
            transform: translateY(-2px);
            border-color: var(--accent-secondary);
            box-shadow: 0 5px 15px rgba(8, 217, 214, 0.3);
        }

        .mode-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: var(--accent-gold);
            color: var(--text-primary);
            box-shadow: 0 5px 20px rgba(255, 46, 99, 0.5);
            transform: translateY(-3px);
        }

        .mode-tab .mode-icon {
            font-size: 1.5em;
            display: block;
            margin-bottom: 5px;
        }

        .mode-tab .mode-name {
            font-size: 0.95em;
            display: block;
        }

        .mode-tab .mode-desc {
            font-size: 0.75em;
            opacity: 0.7;
            display: block;
            margin-top: 3px;
        }

        /* Control Visibility by Mode */
        .control-group[data-mode="pro"],
        .control-group[data-mode="advanced"] {
            display: none;
        }

        .mode-basic .control-group[data-mode="basic"] {
            display: block;
        }

        .mode-pro .control-group[data-mode="basic"],
        .mode-pro .control-group[data-mode="pro"] {
            display: block;
        }

        .mode-advanced .control-group {
            display: block;
        }

        /* Mode Indicator Badge */
        .mode-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-badge .badge-icon {
            font-size: 1.2em;
        }

        /* Preset Manager Panel */
        .preset-manager {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 3px solid var(--accent-primary);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
            z-index: 10001;
            display: none;
        }

        .preset-manager.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .preset-slot {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .preset-slot:hover {
            border-color: var(--accent-secondary);
            transform: translateX(5px);
        }

        .preset-slot.has-preset {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, var(--bg-tertiary), rgba(255, 215, 0, 0.1));
        }

        .preset-slot-info {
            flex-grow: 1;
        }

        .preset-slot-name {
            color: var(--accent-gold);
            font-weight: bold;
            font-size: 1.1em;
        }

        .preset-slot-time {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .preset-slot-buttons {
            display: flex;
            gap: 10px;
        }

        .preset-slot-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .preset-slot-buttons .load-btn {
            background: var(--accent-secondary);
            color: #000;
        }

        .preset-slot-buttons .load-btn:hover {
            background: var(--accent-gold);
            transform: scale(1.05);
        }

        .preset-slot-buttons .delete-btn {
            background: var(--accent-primary);
            color: #fff;
        }

        .preset-slot-buttons .delete-btn:hover {
            background: #ff0040;
            transform: scale(1.05);
        }

        /* Live Feedback Visualizer */
        .live-visualizer {
            position: relative;
            height: 80px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .visualizer-bars {
            display: flex;
            align-items: flex-end;
            height: 100%;
            gap: 2px;
            padding: 5px;
        }

        .visualizer-bar {
            flex: 1;
            background: linear-gradient(0deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px 3px 0 0;
            transition: height 0.1s ease;
            min-height: 5px;
        }

        /* Achievement Notifications */
        .achievement {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent-gold), #ffa500);
            color: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(255, 215, 0, 0.5);
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.5s ease;
            min-width: 300px;
        }

        .achievement.show {
            transform: translateX(0);
        }

        .achievement-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-text {
            font-size: 0.9em;
        }

        /* Interactive Waveform Display */
        .waveform-interactive {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .waveform-interactive:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px var(--accent-secondary);
        }
    </style>
</head>
<body>
    <!-- Mode Indicator Badge -->
    <div class="mode-badge" id="modeBadge">
        <span class="badge-icon">üéöÔ∏è</span>
        <span id="modeText">Basic Mode</span>
    </div>

    <div class="header">
        <h1>üî• TRAP & HIP-HOP PRODUCTION STUDIO üî•</h1>
        <p>Professional Beat Making Tools | Chord Generator | 808 Designer | Pattern Sequencer</p>
        
        <!-- Navigation -->
        <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; align-items: center;">
            <a href="/" style="color: var(--text-primary); text-decoration: none; padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--accent-secondary); border-radius: 5px; transition: all 0.3s;">
                üè† Home
            </a>
            <a href="/trap-studio.html" style="color: var(--bg-primary); background: var(--accent-primary); text-decoration: none; padding: 8px 16px; border: 1px solid var(--accent-primary); border-radius: 5px; font-weight: bold; box-shadow: 0 0 15px var(--glow);">
                üî• Trap Studio
            </a>
            <a href="/techno-creator.html" style="color: var(--text-primary); text-decoration: none; padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--accent-secondary); border-radius: 5px; transition: all 0.3s;">
                ‚ö° Techno Creator
            </a>
            <a href="/radio.html" style="color: var(--text-primary); text-decoration: none; padding: 8px 16px; background: linear-gradient(135deg, #ff00ff, #00ff00); color: #000; font-weight: bold; border-radius: 5px; transition: all 0.3s;">
                üìª Radio 24/7
            </a>
            
            <!-- Mode Toggle -->
            <button id="modeToggle" onclick="toggleAdvancedMode()" style="color: var(--text-primary); text-decoration: none; padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); border: 1px solid var(--accent-secondary); border-radius: 5px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-left: 10px;">
                ‚öôÔ∏è <span id="modeText">Basic Mode</span>
            </button>
        </div>
    </div>

    <!-- Live Guidance Panel -->
    <div class="guidance-panel" id="guidancePanel">
        <div class="guidance-header" onclick="toggleGuidance()">
            <h3>üí° Live Guide</h3>
            <span id="guidanceToggle">‚àí</span>
        </div>
        <div class="guidance-content" id="guidanceContent">
            <div class="guidance-tip">
                <div class="guidance-tip-title">üéØ Getting Started</div>
                <div class="guidance-tip-text">Follow these steps to create your first trap beat!</div>
            </div>
            
            <div class="guidance-step">
                <div class="guidance-step-number">1</div>
                <div class="guidance-step-text">Choose a <strong>key</strong> and <strong>progression type</strong> to match your mood</div>
            </div>
            
            <div class="guidance-step">
                <div class="guidance-step-number">2</div>
                <div class="guidance-step-text">Click <strong>"Generate Progression"</strong> to create chords</div>
            </div>
            
            <div class="guidance-step">
                <div class="guidance-step-number">3</div>
                <div class="guidance-step-text">Add <strong>drum patterns</strong> by clicking grid cells</div>
            </div>
            
            <div class="guidance-step">
                <div class="guidance-step-number">4</div>
                <div class="guidance-step-text">Adjust <strong>BPM</strong> to set the tempo (slower = chill, faster = hype)</div>
            </div>
            
            <div class="guidance-step">
                <div class="guidance-step-number">5</div>
                <div class="guidance-step-text">Customize <strong>808 bass</strong> for that signature trap sound</div>
            </div>
            
            <div class="guidance-step">
                <div class="guidance-step-number">6</div>
                <div class="guidance-step-text">Click <strong>"Play Beat"</strong> to hear your creation!</div>
            </div>
            
            <div class="guidance-step">
                <div class="guidance-step-number">7</div>
                <div class="guidance-step-text">Use <strong>"Send to Radio"</strong> to broadcast your beat instantly!</div>
            </div>
            
            <div class="guidance-tip" style="background: rgba(255, 215, 0, 0.1); border-left-color: var(--accent-gold);">
                <div class="guidance-tip-title">‚ö° Pro Tips</div>
                <div class="guidance-tip-text">
                    ‚Ä¢ Minor keys = Dark trap vibes<br>
                    ‚Ä¢ 140 BPM = Classic trap speed<br>
                    ‚Ä¢ Kick on 1 & 3, snare on 2 & 4<br>
                    ‚Ä¢ Hi-hats on every step for rolls<br>
                    ‚Ä¢ 808 glide = smooth bass slides
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Mode Selector -->
        <div class="mode-selector" id="modeSelector">
            <div class="mode-tab active" data-mode="basic" onclick="switchMode('basic')">
                <span class="mode-icon">üéØ</span>
                <span class="mode-name">Basic</span>
                <span class="mode-desc">Essential controls only</span>
            </div>
            <div class="mode-tab" data-mode="pro" onclick="switchMode('pro')">
                <span class="mode-icon">üéõÔ∏è</span>
                <span class="mode-name">Pro</span>
                <span class="mode-desc">Common production tools</span>
            </div>
            <div class="mode-tab" data-mode="advanced" onclick="switchMode('advanced')">
                <span class="mode-icon">‚ö°</span>
                <span class="mode-name">Advanced</span>
                <span class="mode-desc">Full control & precision</span>
            </div>
        </div>

        <!-- Chord Progression Generator -->
        <div class="tool-section animated">
            <div class="section-header-enhanced">
                <div class="section-icon">üéπ</div>
                <div class="section-info">
                    <h2 class="section-title">Chord Progression Generator</h2>
                    <p class="section-subtitle">Generate professional trap and hip-hop chord progressions in any key</p>
                </div>
            </div>

            <!-- Quick Presets -->
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="loadChordPreset('dark-trap')">
                    üåë Dark Trap
                </div>
                <div class="quick-action-btn" onclick="loadChordPreset('melodic')">
                    üéµ Melodic
                </div>
                <div class="quick-action-btn" onclick="loadChordPreset('drill')">
                    üî´ Drill
                </div>
                <div class="quick-action-btn" onclick="randomizeChordProgression()">
                    üé≤ Random
                </div>
            </div>

            <div class="tool-grid">
                <div class="control-group" data-mode="basic">
                    <div class="control-label-enhanced">
                        <span>
                            üéº Key
                            <span class="info-tooltip" data-tip="Sets the musical key. Minor keys sound darker and more aggressive (perfect for trap). Major keys are brighter and more melodic. Popular trap keys: F# minor, A minor, D minor">‚Ñπ</span>
                        </span>
                    </div>
                    <select id="chordKey" onchange="updateGuidance('key', this.value)">
                        <option value="C">C Major / A Minor</option>
                        <option value="Db">C# Major / Bb Minor</option>
                        <option value="D">D Major / B Minor</option>
                        <option value="Eb">Eb Major / C Minor</option>
                        <option value="E">E Major / C# Minor</option>
                        <option value="F">F Major / D Minor</option>
                        <option value="F#">F# Major / Eb Minor</option>
                        <option value="G">G Major / E Minor</option>
                        <option value="Ab">Ab Major / F Minor</option>
                        <option value="A" selected>A Major / F# Minor</option>
                        <option value="Bb">Bb Major / G Minor</option>
                        <option value="B">B Major / G# Minor</option>
                    </select>
                </div>

                <div class="control-group" data-mode="basic">
                    <div class="control-label-enhanced">
                        <span>
                            üé≠ Mode
                            <span class="info-tooltip" data-tip="Minor = Dark, aggressive, emotional (classic trap sound). Major = Bright, uplifting, melodic (modern melodic trap)">‚Ñπ</span>
                        </span>
                    </div>
                    <select id="chordMode" onchange="updateGuidance('mode', this.value)">
                        <option value="minor" selected>Minor (Dark Trap)</option>
                        <option value="major">Major (Melodic Trap)</option>
                    </select>
                </div>

                <div class="control-group" data-mode="basic">
                    <div class="control-label-enhanced">
                        <span>
                            üéµ Progression Type
                            <span class="info-tooltip" data-tip="Different chord progressions create different moods. Dark Trap = aggressive, Melodic = emotional, Drill = hard-hitting, Cloud Rap = dreamy">‚Ñπ</span>
                        </span>
                    </div>
                    <select id="progressionType" onchange="updateGuidance('progression', this.value)">
                        <option value="dark_trap" selected>Dark Trap (i-VI-III-VII)</option>
                        <option value="melodic_trap">Melodic Trap (i-iv-VII-VI)</option>
                        <option value="drill">Drill (i-III-VII-VI)</option>
                        <option value="cloud_rap">Cloud Rap (vi-IV-I-V)</option>
                        <option value="boom_bap">Boom-Bap (i-VII-VI-V)</option>
                        <option value="emotional">Emotional (i-v-VI-III)</option>
                        <option value="custom">Custom Progression</option>
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="generateChordProgression()">
                    ‚ú® Generate Progression
                </button>
                <button class="btn btn-secondary" onclick="playChordProgression()">
                    ‚ñ∂Ô∏è Play Preview
                </button>
                <button class="btn btn-gold" onclick="randomizeChordProgression()">
                    üé≤ Randomize
                </button>
            </div>

            <!-- Instrument Selection for Playback -->
            <div style="margin: 15px 0; padding: 15px; background: var(--bg-tertiary); border-radius: 10px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.9em;">
                    üéπ Select Instrument Sound:
                </p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <button class="btn btn-secondary" onclick="setChordInstrument('enhanced')" id="inst-enhanced" style="padding: 8px 12px; font-size: 0.85em; background: linear-gradient(135deg, var(--accent-gold), var(--accent-secondary));">
                        ‚öôÔ∏è Enhanced
                    </button>
                    <button class="btn btn-secondary" onclick="setChordInstrument('piano')" id="inst-piano" style="padding: 8px 12px; font-size: 0.85em;">
                        üéπ Piano
                    </button>
                    <button class="btn btn-secondary" onclick="setChordInstrument('bells')" id="inst-bells" style="padding: 8px 12px; font-size: 0.85em;">
                        üîî Bells
                    </button>
                    <button class="btn btn-secondary" onclick="setChordInstrument('pad')" id="inst-pad" style="padding: 8px 12px; font-size: 0.85em;">
                        üåä Pad
                    </button>
                    <button class="btn btn-secondary" onclick="setChordInstrument('pluck')" id="inst-pluck" style="padding: 8px 12px; font-size: 0.85em;">
                        üé∏ Pluck
                    </button>
                    <button class="btn btn-secondary" onclick="setChordInstrument('brass')" id="inst-brass" style="padding: 8px 12px; font-size: 0.85em;">
                        üé∫ Brass
                    </button>
                    <button class="btn btn-secondary" onclick="setChordInstrument('lead')" id="inst-lead" style="padding: 8px 12px; font-size: 0.85em;">
                        ‚ö° Lead
                    </button>
                </div>
            </div>

            <!-- Advanced Playback Controls -->
            <div style="margin: 15px 0; padding: 15px; background: var(--bg-tertiary); border-radius: 10px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.9em;">
                    ‚öôÔ∏è Playback Options:
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- Arpeggiator -->
                    <div>
                        <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                            üéµ Arpeggio Pattern:
                        </label>
                        <select id="arpeggioPattern" class="form-control" style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent-secondary); border-radius: 5px;">
                            <option value="none">Chord (All Together)</option>
                            <option value="up">Up ‚Üë</option>
                            <option value="down">Down ‚Üì</option>
                            <option value="updown">Up-Down ‚Üï</option>
                            <option value="random">Random üé≤</option>
                        </select>
                    </div>

                    <!-- Rhythm Pattern -->
                    <div>
                        <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                            üéº Rhythm Pattern:
                        </label>
                        <select id="rhythmPattern" class="form-control" style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--accent-secondary); border-radius: 5px;">
                            <option value="whole">Whole Notes (Sustain)</option>
                            <option value="quarter">Quarter Notes (Staccato)</option>
                            <option value="syncopated">Syncopated</option>
                            <option value="triplet">Triplets</option>
                        </select>
                    </div>

                    <!-- Octave -->
                    <div>
                        <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                            üéπ Octave: <span id="octaveValue">4</span>
                        </label>
                        <input type="range" id="octaveControl" min="2" max="6" value="4" 
                               oninput="document.getElementById('octaveValue').textContent = this.value"
                               style="width: 100%;">
                    </div>

                    <!-- Velocity -->
                    <div>
                        <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                            üí™ Velocity: <span id="velocityValue">80</span>%
                        </label>
                        <input type="range" id="velocityControl" min="30" max="100" value="80" 
                               oninput="document.getElementById('velocityValue').textContent = this.value"
                               style="width: 100%;">
                    </div>
                </div>

                <!-- Effects and Humanization -->
                <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <label style="display: flex; align-items: center; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                        <input type="checkbox" id="humanizeToggle" style="margin-right: 8px;">
                        üé≠ Humanize (Timing & Velocity)
                    </label>
                    <label style="display: flex; align-items: center; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                        <input type="checkbox" id="reverbToggle" style="margin-right: 8px;">
                        üåä Reverb
                    </label>
                    <label style="display: flex; align-items: center; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                        <input type="checkbox" id="delayToggle" style="margin-right: 8px;">
                        ‚è±Ô∏è Delay
                    </label>
                </div>

                <!-- Preset System -->
                <div style="margin-top: 15px;">
                    <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                        üíæ Presets:
                    </label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="loadPreset('dark_piano')" style="padding: 6px 12px; font-size: 0.8em;">
                            üåô Dark Piano
                        </button>
                        <button class="btn btn-secondary" onclick="loadPreset('bright_bells')" style="padding: 6px 12px; font-size: 0.8em;">
                            ‚ú® Bright Bells
                        </button>
                        <button class="btn btn-secondary" onclick="loadPreset('ambient_pad')" style="padding: 6px 12px; font-size: 0.8em;">
                            üåå Ambient Pad
                        </button>
                        <button class="btn btn-secondary" onclick="loadPreset('trap_pluck')" style="padding: 6px 12px; font-size: 0.8em;">
                            üé∏ Trap Pluck
                        </button>
                        <button class="btn btn-secondary" onclick="loadPreset('drill_brass')" style="padding: 6px 12px; font-size: 0.8em;">
                            üé∫ Drill Brass
                        </button>
                        <button class="btn btn-secondary" onclick="loadPreset('hyperpop_lead')" style="padding: 6px 12px; font-size: 0.8em;">
                            ‚ö° Hyperpop Lead
                        </button>
                    </div>
                </div>

                <!-- Advanced Synthesis Controls -->
                <div id="advancedSynthControls" class="advanced-section" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(255, 46, 99, 0.1), rgba(8, 217, 214, 0.1)); border: 1px solid var(--accent-secondary); border-radius: 10px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--accent-gold); font-size: 1.1em; margin: 0;">
                            ‚öôÔ∏è Advanced Synthesis Controls
                        </h3>
                        <span style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">
                            EXPERT MODE
                        </span>
                    </div>
                    
                    <!-- Oscillator Section -->
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <p style="color: var(--accent-secondary); margin-bottom: 10px; font-size: 0.95em; font-weight: bold;">
                            üéõÔ∏è Oscillator
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Waveform:
                                </label>
                                <select id="waveform" class="form-control" style="width: 100%; padding: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 5px;">
                                    <option value="sine">Sine (Clean)</option>
                                    <option value="triangle">Triangle (Warm)</option>
                                    <option value="sawtooth" selected>Sawtooth (Bright)</option>
                                    <option value="square">Square (Hollow)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Unison Voices: <span id="unisonValue">1</span>
                                </label>
                                <input type="range" id="unisonVoices" min="1" max="7" value="1" step="2"
                                       oninput="document.getElementById('unisonValue').textContent = this.value"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Detune: <span id="detuneValue">5</span> cents
                                </label>
                                <input type="range" id="detuneAmount" min="0" max="50" value="5"
                                       oninput="document.getElementById('detuneValue').textContent = this.value"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Harmonics: <span id="harmonicsValue">2</span>
                                </label>
                                <input type="range" id="harmonicCount" min="0" max="5" value="2"
                                       oninput="document.getElementById('harmonicsValue').textContent = this.value"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <p style="color: var(--accent-secondary); margin-bottom: 10px; font-size: 0.95em; font-weight: bold;">
                            üéöÔ∏è Filter
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Filter Type:
                                </label>
                                <select id="filterType" class="form-control" style="width: 100%; padding: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 5px;">
                                    <option value="lowpass" selected>Low-Pass</option>
                                    <option value="highpass">High-Pass</option>
                                    <option value="bandpass">Band-Pass</option>
                                    <option value="notch">Notch</option>
                                    <option value="allpass">All-Pass</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Cutoff: <span id="filterCutoffValue">2000</span> Hz
                                </label>
                                <input type="range" id="filterCutoff" min="100" max="8000" value="2000"
                                       oninput="document.getElementById('filterCutoffValue').textContent = this.value"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Resonance: <span id="filterResValue">1</span>
                                </label>
                                <input type="range" id="filterResonance" min="0.1" max="20" value="1" step="0.1"
                                       oninput="document.getElementById('filterResValue').textContent = parseFloat(this.value).toFixed(1)"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Envelope: <span id="filterEnvValue">50</span>%
                                </label>
                                <input type="range" id="filterEnvelope" min="0" max="100" value="50"
                                       oninput="document.getElementById('filterEnvValue').textContent = this.value"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Envelope Section -->
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <p style="color: var(--accent-secondary); margin-bottom: 10px; font-size: 0.95em; font-weight: bold;">
                            üìä Envelope (ADSR)
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Attack: <span id="attackValue">0.01</span>s
                                </label>
                                <input type="range" id="attackTime" min="0.001" max="2" value="0.01" step="0.001"
                                       oninput="document.getElementById('attackValue').textContent = parseFloat(this.value).toFixed(3)"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Decay: <span id="decayValue">0.3</span>s
                                </label>
                                <input type="range" id="decayTime" min="0.001" max="2" value="0.3" step="0.01"
                                       oninput="document.getElementById('decayValue').textContent = parseFloat(this.value).toFixed(2)"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Sustain: <span id="sustainValue">70</span>%
                                </label>
                                <input type="range" id="sustainLevel" min="0" max="100" value="70"
                                       oninput="document.getElementById('sustainValue').textContent = this.value"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    Release: <span id="releaseValue">0.5</span>s
                                </label>
                                <input type="range" id="releaseTime" min="0.01" max="5" value="0.5" step="0.01"
                                       oninput="document.getElementById('releaseValue').textContent = parseFloat(this.value).toFixed(2)"
                                       style="width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- LFO Section -->
                    <div style="margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <p style="color: var(--accent-secondary); margin-bottom: 10px; font-size: 0.95em; font-weight: bold;">
                            üåä LFO (Low Frequency Oscillator)
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                            <div>
                                <label style="display: flex; align-items: center; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                                    <input type="checkbox" id="lfoEnabled" style="margin-right: 8px;">
                                    Enable LFO
                                </label>
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    LFO Rate: <span id="lfoRateValue">4</span> Hz
                                </label>
                                <input type="range" id="lfoRate" min="0.1" max="20" value="4" step="0.1"
                                       oninput="document.getElementById('lfoRateValue').textContent = parseFloat(this.value).toFixed(1)"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    LFO Depth: <span id="lfoDepthValue">30</span>%
                                </label>
                                <input type="range" id="lfoDepth" min="0" max="100" value="30"
                                       oninput="document.getElementById('lfoDepthValue').textContent = this.value"
                                       style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: var(--text-secondary); font-size: 0.85em; margin-bottom: 5px;">
                                    LFO Target:
                                </label>
                                <select id="lfoTarget" class="form-control" style="width: 100%; padding: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 5px;">
                                    <option value="pitch">Pitch (Vibrato)</option>
                                    <option value="filter" selected>Filter (Wah)</option>
                                    <option value="volume">Volume (Tremolo)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Automation Section -->
                    <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <p style="color: var(--accent-secondary); margin-bottom: 10px; font-size: 0.95em; font-weight: bold;">
                            üé¨ Automation
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <div>
                                <label style="display: flex; align-items: center; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                                    <input type="checkbox" id="autoFilterEnabled" style="margin-right: 8px;">
                                    Filter Sweep
                                </label>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                                    <input type="checkbox" id="autoVolumeEnabled" style="margin-right: 8px;">
                                    Volume Fade
                                </label>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; color: var(--text-secondary); font-size: 0.85em; cursor: pointer;">
                                    <input type="checkbox" id="autoPanEnabled" style="margin-right: 8px;">
                                    Auto-Pan
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chordDisplay" class="chord-display">
                <p style="text-align: center; color: var(--text-secondary);">
                    Click "Generate Progression" to create chords
                </p>
            </div>

            <div id="chordOutput" class="output-box" style="display: none;">
                <pre id="chordCode"></pre>
            </div>
        </div>

        <!-- Beat Pattern Sequencer -->
        <div class="tool-section animated">
            <div class="section-header-enhanced">
                <div class="section-icon">ü•Å</div>
                <div class="section-info">
                    <h2 class="section-title">Trap Beat Sequencer</h2>
                    <p class="section-subtitle">Create professional drum patterns with 808s, kicks, snares, and hi-hats</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="loadPresetPattern('classic-trap'); this.classList.add('active');">
                    üî• Classic Trap
                </div>
                <div class="quick-action-btn" onclick="loadPresetPattern('drill'); this.classList.add('active');">
                    üî´ UK Drill
                </div>
                <div class="quick-action-btn" onclick="loadPresetPattern('boom-bap'); this.classList.add('active');">
                    üíø Boom Bap
                </div>
            </div>

            <!-- Kick Pattern Variations (Pro Mode) -->
            <div class="control-group" data-mode="pro" style="margin: 20px 0; padding: 15px; background: var(--bg-tertiary); border-radius: 10px;">
                <div class="control-label-enhanced">
                    <span>
                        ü•Å Kick Pattern Variations
                        <span class="info-tooltip" data-tip="Different kick patterns for various trap styles. Hard hitting = Classic trap, Rolling = Drill, Syncopated = Modern trap">‚Ñπ</span>
                    </span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="loadKickPattern('classic')" style="padding: 8px 12px; font-size: 0.85em;">
                        üî• Classic
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('hard')" style="padding: 8px 12px; font-size: 0.85em;">
                        üí™ Hard Hit
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('rolling')" style="padding: 8px 12px; font-size: 0.85em;">
                        üåÄ Rolling
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('double')" style="padding: 8px 12px; font-size: 0.85em;">
                        ‚úåÔ∏è Double
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('triplet')" style="padding: 8px 12px; font-size: 0.85em;">
                        3Ô∏è‚É£ Triplet
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('offbeat')" style="padding: 8px 12px; font-size: 0.85em;">
                        ‚ö° Offbeat
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('syncopated')" style="padding: 8px 12px; font-size: 0.85em;">
                        üéµ Syncopated
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('drill')" style="padding: 8px 12px; font-size: 0.85em;">
                        üî´ Drill
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('sparse')" style="padding: 8px 12px; font-size: 0.85em;">
                        ‚óΩ Sparse
                    </button>
                    <button class="btn btn-secondary" onclick="loadKickPattern('breakbeat')" style="padding: 8px 12px; font-size: 0.85em;">
                        üí• Breakbeat
                    </button>
                </div>
            </div>

            <!-- Hi-Hat Pattern Variations (Pro Mode) -->
            <div class="control-group" data-mode="pro" style="margin: 20px 0; padding: 15px; background: var(--bg-tertiary); border-radius: 10px;">
                <div class="control-label-enhanced">
                    <span>
                        üé© Hi-Hat Pattern Variations
                        <span class="info-tooltip" data-tip="Different hi-hat patterns. Trap Roll = Signature hi-hat rolls, Open = Open hat hits, Double Time = Twice as fast">‚Ñπ</span>
                    </span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('closed')" style="padding: 8px 12px; font-size: 0.85em;">
                        üîí Closed
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('open')" style="padding: 8px 12px; font-size: 0.85em;">
                        üîì Open
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('trap-roll')" style="padding: 8px 12px; font-size: 0.85em;">
                        üî• Trap Roll
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('drill-roll')" style="padding: 8px 12px; font-size: 0.85em;">
                        üî´ Drill Roll
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('double-time')" style="padding: 8px 12px; font-size: 0.85em;">
                        ‚ö° Double Time
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('half-time')" style="padding: 8px 12px; font-size: 0.85em;">
                        üêå Half Time
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('triplets')" style="padding: 8px 12px; font-size: 0.85em;">
                        3Ô∏è‚É£ Triplets
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('shuffled')" style="padding: 8px 12px; font-size: 0.85em;">
                        üé≤ Shuffled
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('syncopated')" style="padding: 8px 12px; font-size: 0.85em;">
                        üéµ Syncopated
                    </button>
                    <button class="btn btn-secondary" onclick="loadHiHatPattern('minimal')" style="padding: 8px 12px; font-size: 0.85em;">
                        ‚óΩ Minimal
                    </button>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- EXPERT MODE: PATTERN COMBINATOR & INTELLIGENT BEAT GENERATOR -->
            <!-- ============================================ -->
            <div class="control-group" data-mode="advanced" style="margin: 30px 0; padding: 25px; background: linear-gradient(135deg, rgba(255, 46, 99, 0.15), rgba(138, 43, 226, 0.15)); border: 2px solid var(--accent-gold); border-radius: 15px;">
                <h3 style="color: var(--accent-gold); margin-bottom: 20px; font-size: 1.3em; text-align: center;">
                    üß† Intelligent Beat Generator - Expert Mode
                </h3>
                
                <p style="color: var(--text-secondary); text-align: center; margin-bottom: 25px; font-size: 0.95em;">
                    Combine patterns automatically and generate complete beats based on style, instruments, and complexity!
                </p>

                <!-- Style-Based Beat Generation -->
                <div style="margin-bottom: 25px; padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                    <h4 style="color: var(--accent-secondary); margin-bottom: 15px; font-size: 1.1em;">
                        üéØ Style-Based Auto-Generation
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Genre Selection -->
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px;">
                                üéº Genre Style:
                            </label>
                            <select id="genreStyle" class="form-control" style="width: 100%; padding: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; font-size: 0.95em;">
                                <option value="trap">üî• Trap</option>
                                <option value="drill">üî´ Drill</option>
                                <option value="boom-bap">üíø Boom-Bap</option>
                                <option value="lo-fi">üåô Lo-Fi</option>
                                <option value="hyperpop">‚ö° Hyperpop</option>
                                <option value="phonk">üëª Phonk</option>
                                <option value="jersey-club">üé™ Jersey Club</option>
                            </select>
                        </div>
                        
                        <!-- Complexity Level -->
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px;">
                                ‚öôÔ∏è Complexity:
                            </label>
                            <select id="complexityLevel" class="form-control" style="width: 100%; padding: 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; font-size: 0.95em;">
                                <option value="minimal">‚óΩ Minimal (Sparse)</option>
                                <option value="simple">üü¢ Simple (Clean)</option>
                                <option value="moderate" selected>üü° Moderate (Balanced)</option>
                                <option value="complex">üü† Complex (Layered)</option>
                                <option value="chaotic">üî¥ Chaotic (Maximal)</option>
                            </select>
                        </div>
                        
                        <!-- Energy Level -->
                        <div>
                            <label style="display: block; color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px;">
                                ‚ö° Energy Level:
                            </label>
                            <input type="range" id="energyLevel" min="1" max="10" value="7" 
                                   style="width: 100%; margin-top: 10px;"
                                   oninput="document.getElementById('energyValue').textContent = this.value">
                            <div style="text-align: center; color: var(--accent-gold); font-weight: bold; margin-top: 5px;">
                                <span id="energyValue">7</span> / 10
                            </div>
                        </div>
                    </div>

                    <!-- Instrument Selection -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: var(--text-secondary); font-size: 0.9em; margin-bottom: 10px;">
                            üéπ Select Active Instruments:
                        </label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" id="inst_kick" checked style="margin-right: 10px;">
                                <span>ü•Å Kick</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" id="inst_snare" checked style="margin-right: 10px;">
                                <span>üëè Snare</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" id="inst_hihat" checked style="margin-right: 10px;">
                                <span>üé© Hi-Hat</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" id="inst_808" checked style="margin-right: 10px;">
                                <span>üîä 808</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" id="inst_perc" style="margin-right: 10px;">
                                <span>üéµ Percussion</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" id="inst_melody" style="margin-right: 10px;">
                                <span>üéπ Melody</span>
                            </label>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div style="text-align: center;">
                        <button class="btn" onclick="generateIntelligentBeat()" style="font-size: 1.1em; padding: 15px 40px; background: linear-gradient(135deg, var(--accent-gold), #ffd700); color: #000; font-weight: bold; box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);">
                            üß† Generate Beat
                        </button>
                    </div>
                </div>

                <!-- Pattern Combination Library -->
                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                    <h4 style="color: var(--accent-secondary); margin-bottom: 15px; font-size: 1.1em;">
                        üé® Pattern Combination Presets
                    </h4>
                    <p style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 15px;">
                        Pre-made combinations that work great together. Click to apply!
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <button class="btn btn-secondary" onclick="loadPatternCombo('trap-banger')" style="padding: 12px;">
                            üî• Trap Banger
                            <div style="font-size: 0.75em; opacity: 0.8;">Hard Kick + Trap Roll</div>
                        </button>
                        <button class="btn btn-secondary" onclick="loadPatternCombo('drill-attack')" style="padding: 12px;">
                            üî´ Drill Attack
                            <div style="font-size: 0.75em; opacity: 0.8;">Drill Kick + Roll Hats</div>
                        </button>
                        <button class="btn btn-secondary" onclick="loadPatternCombo('minimalist')" style="padding: 12px;">
                            ‚óΩ Minimalist
                            <div style="font-size: 0.75em; opacity: 0.8;">Sparse + Minimal</div>
                        </button>
                        <button class="btn btn-secondary" onclick="loadPatternCombo('hyperpop-chaos')" style="padding: 12px;">
                            ‚ö° Hyperpop Chaos
                            <div style="font-size: 0.75em; opacity: 0.8;">Double Time + Syncopated</div>
                        </button>
                        <button class="btn btn-secondary" onclick="loadPatternCombo('boom-bap-classic')" style="padding: 12px;">
                            üíø Boom-Bap Classic
                            <div style="font-size: 0.75em; opacity: 0.8;">Classic + Half-Time</div>
                        </button>
                        <button class="btn btn-secondary" onclick="loadPatternCombo('lo-fi-chill')" style="padding: 12px;">
                            üåô Lo-Fi Chill
                            <div style="font-size: 0.75em; opacity: 0.8;">Offbeat + Shuffled</div>
                        </button>
                        <button class="btn btn-secondary" onclick="loadPatternCombo('jersey-bounce')" style="padding: 12px;">
                            üé™ Jersey Bounce
                            <div style="font-size: 0.75em; opacity: 0.8;">Triplet + Double Time</div>
                        </button>
                        <button class="btn btn-secondary" onclick="loadPatternCombo('phonk-drift')" style="padding: 12px;">
                            üëª Phonk Drift
                            <div style="font-size: 0.75em; opacity: 0.8;">Rolling + Syncopated</div>
                        </button>
                    </div>
                </div>

                <!-- Pattern Randomizer -->
                <div style="margin-top: 20px; padding: 20px; background: var(--bg-tertiary); border-radius: 10px; text-align: center;">
                    <h4 style="color: var(--accent-secondary); margin-bottom: 15px; font-size: 1em;">
                        üé≤ Pattern Randomizer
                    </h4>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="randomizeKickPattern()">
                            ü•Å Random Kick
                        </button>
                        <button class="btn btn-secondary" onclick="randomizeHiHatPattern()">
                            üé© Random Hi-Hat
                        </button>
                        <button class="btn btn-secondary" onclick="randomizeAllPatterns()">
                            üé≤ Randomize All
                        </button>
                        <button class="btn btn-secondary" onclick="mutateCurrentPattern()">
                            üß¨ Mutate Current
                        </button>
                    </div>
                </div>
            </div>

            <div class="control-group" data-mode="basic">
                <div class="control-label-enhanced">
                    <span>
                        <span class="live-indicator"></span>
                        BPM (Tempo)
                        <span class="info-tooltip" data-tip="Controls the speed of your beat. Lower = slower/chill, Higher = faster/energetic. Trap: 130-150 | Boom Bap: 80-95 | Drill: 140-165">‚Ñπ</span>
                    </span>
                    <span class="value-display" id="bpmValue">140</span>
                </div>
                <input type="range" id="bpmControl" min="60" max="200" value="140" 
                       oninput="updateBPM(this.value); updateGuidance('bpm', this.value)">
                <div class="control-description">
                    üí° Current style: <strong id="bpmStyle">Classic Trap</strong>
                </div>
            </div>

            <h3>üéõÔ∏è Pattern Grid (16 Steps)</h3>
            
            <!-- Sound Preview Buttons -->
            <div style="margin: 15px 0; padding: 15px; background: var(--bg-tertiary); border-radius: 10px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.9em;">
                    üéß Preview Individual Sounds:
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-secondary" onclick="initAudio(); play808Bass(audioContext, audioContext.currentTime)" style="padding: 8px 16px; font-size: 0.9em;">
                        üîä 808 Bass
                    </button>
                    <button class="btn btn-secondary" onclick="initAudio(); playKickDrum(audioContext, audioContext.currentTime)" style="padding: 8px 16px; font-size: 0.9em;">
                        ü•Å Kick
                    </button>
                    <button class="btn btn-secondary" onclick="initAudio(); playSnareDrum(audioContext, audioContext.currentTime)" style="padding: 8px 16px; font-size: 0.9em;">
                        üëè Snare
                    </button>
                    <button class="btn btn-secondary" onclick="initAudio(); playHiHat(audioContext, audioContext.currentTime)" style="padding: 8px 16px; font-size: 0.9em;">
                        üé© Hi-Hat
                    </button>
                </div>
            </div>
            
            <div class="beat-grid" id="beatGrid">
                <!-- Grid will be generated by JavaScript -->
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="playBeat()">‚ñ∂Ô∏è Play Beat</button>
                <button class="btn btn-secondary" onclick="stopBeat()">‚èπÔ∏è Stop</button>
                <button class="btn" onclick="clearPattern()">üóëÔ∏è Clear</button>
                <button class="btn btn-gold" onclick="loadPresetPattern()">üì¶ Load Preset</button>
                <button class="btn" onclick="exportToRadio()" style="background: linear-gradient(135deg, #ff00ff, #00ff00); color: #000; font-weight: bold;">
                    üìª Send to Radio
                </button>
            </div>

            <div class="preset-grid">
                <div class="preset-card" onclick="loadPattern('classic_trap')">
                    <div class="preset-icon">üî•</div>
                    <div class="preset-name">Classic Trap</div>
                    <div class="preset-desc">140 BPM</div>
                </div>
                <div class="preset-card" onclick="loadPattern('drill')">
                    <div class="preset-icon">üî´</div>
                    <div class="preset-name">Drill</div>
                    <div class="preset-desc">145 BPM</div>
                </div>
                <div class="preset-card" onclick="loadPattern('boom_bap')">
                    <div class="preset-icon">üíø</div>
                    <div class="preset-name">Boom-Bap</div>
                    <div class="preset-desc">90 BPM</div>
                </div>
                <div class="preset-card" onclick="loadPattern('phonk')">
                    <div class="preset-icon">üíÄ</div>
                    <div class="preset-name">Phonk</div>
                    <div class="preset-desc">130 BPM</div>
                </div>
            </div>

            <div id="patternOutput" class="output-box" style="display: none;">
                <pre id="patternCode"></pre>
            </div>
        </div>

        <!-- 808 Bass Designer -->
        <div class="tool-section animated">
            <div class="section-header-enhanced">
                <div class="section-icon">üîä</div>
                <div class="section-info">
                    <h2 class="section-title">808 Bass Designer</h2>
                    <p class="section-subtitle">Design your perfect 808 sub-bass sound - the foundation of trap music</p>
                </div>
            </div>

            <!-- 808 Presets -->
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="load808Preset('classic')">
                    üéµ Classic
                </div>
                <div class="quick-action-btn" onclick="load808Preset('punchy')">
                    üëä Punchy
                </div>
                <div class="quick-action-btn" onclick="load808Preset('deep')">
                    üåä Deep
                </div>
                <div class="quick-action-btn" onclick="load808Preset('distorted')">
                    üî• Distorted
                </div>
            </div>

            <div class="tool-grid">
                <div class="control-group" data-mode="basic">
                    <div class="control-label-enhanced">
                        <span>
                            Frequency
                            <span class="info-tooltip" data-tip="Sets the pitch of your 808. Lower = deeper bass. A1 (55Hz) is classic trap. G#1 (52Hz) for drill. Can be changed per pattern step.">‚Ñπ</span>
                        </span>
                        <span class="value-display" id="freq808Value">55</span>
                    </div>
                    <input type="range" id="bass808Freq" min="30" max="100" value="55" 
                           oninput="update808Param('freq', this.value); updateGuidance('808freq', this.value)">
                    <div class="control-description">
                        üí° <strong id="freq808Note">A1 (Classic Trap)</strong>
                    </div>
                </div>

                <div class="control-group" data-mode="basic">
                    <div class="control-label-enhanced">
                        <span>
                            Decay
                            <span class="info-tooltip" data-tip="How long the 808 sustains. Short (0.1-0.4s) = punchy kicks. Long (0.8-2s) = rolling bass. Match to your tempo!">‚Ñπ</span>
                        </span>
                        <span class="value-display" id="decay808Value">0.8</span>
                    </div>
                    <input type="range" id="bass808Decay" min="0.1" max="2.0" step="0.1" value="0.8" 
                           oninput="update808Param('decay', this.value); updateGuidance('808decay', this.value)">
                    <div class="control-description">
                        üí° <strong id="decay808Style">Rolling Bass</strong>
                    </div>
                </div>

                <div class="control-group" data-mode="pro">
                    <div class="control-label-enhanced">
                        <span>
                            Filter Cutoff
                            <span class="info-tooltip" data-tip="Controls brightness. Low = pure sub-bass (club sound). Higher = more harmonics (bedroom sound). 180Hz is classic.">‚Ñπ</span>
                        </span>
                        <span class="value-display" id="cutoff808Value">180</span>
                    </div>
                    <input type="range" id="bass808Cutoff" min="80" max="500" value="180" 
                           oninput="update808Param('cutoff', this.value); updateGuidance('808cutoff', this.value)">
                    <div class="control-description">
                        üí° <strong id="cutoff808Style">Club Sub-Bass</strong>
                    </div>
                </div>

                <div class="control-group" data-mode="pro">
                    <div class="control-label-enhanced">
                        <span>
                            Resonance
                            <span class="info-tooltip" data-tip="Emphasizes the filter frequency. 0 = smooth. 0.4-0.7 = punchy. 1.0 = screaming (distorted). Use carefully!">‚Ñπ</span>
                        </span>
                        <span class="value-display" id="res808Value">0.4</span>
                    </div>
                    <input type="range" id="bass808Resonance" min="0" max="1" step="0.1" value="0.4" 
                           oninput="update808Param('resonance', this.value); updateGuidance('808res', this.value)">
                    <div class="control-description">
                        üí° <strong id="res808Style">Punchy</strong>
                    </div>
                </div>

                <div class="control-group" data-mode="advanced">
                    <div class="control-label-enhanced">
                        <span>
                            Distortion
                            <span class="info-tooltip" data-tip="Adds harmonics and grit. 0% = clean. 20-40% = warm saturation. 60%+ = aggressive distortion. Great for cutting through the mix!">‚Ñπ</span>
                        </span>
                        <span class="value-display" id="dist808Value">0</span>
                    </div>
                    <input type="range" id="bass808Distortion" min="0" max="100" value="0" 
                           oninput="update808Param('distortion', this.value); updateGuidance('808dist', this.value)">
                    <div class="control-description">
                        üí° <strong id="dist808Style">Clean</strong>
                    </div>
                </div>

                <div class="control-group" data-mode="advanced">
                    <div class="control-label-enhanced">
                        <span>
                            Pitch Glide
                            <span class="info-tooltip" data-tip="Smooth pitch slides between notes. 0ms = no glide. 50-100ms = subtle. 150-200ms = dramatic slides. Signature trap sound!">‚Ñπ</span>
                        </span>
                        <span class="value-display" id="glide808Value">0</span>
                    </div>
                    <input type="range" id="bass808Glide" min="0" max="200" value="0" 
                           oninput="update808Param('glide', this.value); updateGuidance('808glide', this.value)">
                    <div class="control-description">
                        üí° <strong id="glide808Style">No Glide</strong>
                    </div>
                </div>
            </div>

            <canvas id="waveformCanvas" class="waveform-display"></canvas>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="play808Preview()">‚ñ∂Ô∏è Play 808</button>
                <button class="btn btn-secondary" onclick="randomize808()">üé≤ Randomize</button>
                <button class="btn export-btn" onclick="export808Settings()">
                    üíæ Export Settings
                </button>
            </div>

            <div id="bass808Output" class="output-box" style="display: none;">
                <pre id="bass808Code"></pre>
            </div>

            <!-- ============================================ -->
            <!-- DAW-STYLE ARRANGEMENT TIMELINE (ADVANCED MODE) -->
            <!-- ============================================ -->
            <div class="control-group" data-mode="advanced" style="margin-top: 30px;">
                <div style="padding: 25px; background: linear-gradient(135deg, rgba(255, 46, 99, 0.15), rgba(8, 217, 214, 0.15)); border: 2px solid var(--accent-gold); border-radius: 15px;">
                    <h2 style="color: var(--accent-gold); margin-bottom: 20px; font-size: 1.4em; text-align: center;">
                        üéº Arrangement Timeline - DAW Style
                    </h2>
                    
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: 25px; font-size: 0.95em;">
                        Arrange your patterns and instruments into a full track. Drag blocks to build your song structure!
                    </p>

                    <!-- Timeline Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 10px;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="playArrangement()" id="playArrangementBtn">
                                ‚ñ∂Ô∏è Play Full Track
                            </button>
                            <button class="btn btn-secondary" onclick="stopArrangement()">
                                ‚èπÔ∏è Stop
                            </button>
                            <button class="btn btn-secondary" onclick="clearArrangement()">
                                üóëÔ∏è Clear All
                            </button>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="color: var(--text-secondary); font-size: 0.9em;">
                                Bars: <span id="arrangementBars">8</span>
                            </label>
                            <input type="range" id="arrangementLength" min="4" max="32" value="8" step="4"
                                   oninput="updateArrangementLength(this.value)"
                                   style="width: 150px;">
                        </div>
                    </div>

                    <!-- Pattern Library (Drag Sources) -->
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <h4 style="color: var(--accent-secondary); margin-bottom: 15px; font-size: 1em;">
                            üì¶ Pattern Library - Drag to Timeline
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                            <!-- Kick Patterns -->
                            <div class="pattern-block" draggable="true" data-type="kick" data-pattern="classic">
                                <div class="pattern-icon">ü•Å</div>
                                <div class="pattern-name">Classic Kick</div>
                            </div>
                            <div class="pattern-block" draggable="true" data-type="kick" data-pattern="hard">
                                <div class="pattern-icon">ü•Å</div>
                                <div class="pattern-name">Hard Kick</div>
                            </div>
                            <div class="pattern-block" draggable="true" data-type="kick" data-pattern="drill">
                                <div class="pattern-icon">ü•Å</div>
                                <div class="pattern-name">Drill Kick</div>
                            </div>
                            
                            <!-- Hi-Hat Patterns -->
                            <div class="pattern-block" draggable="true" data-type="hihat" data-pattern="closed">
                                <div class="pattern-icon">üé©</div>
                                <div class="pattern-name">Closed Hats</div>
                            </div>
                            <div class="pattern-block" draggable="true" data-type="hihat" data-pattern="trap-roll">
                                <div class="pattern-icon">üé©</div>
                                <div class="pattern-name">Trap Roll</div>
                            </div>
                            <div class="pattern-block" draggable="true" data-type="hihat" data-pattern="double-time">
                                <div class="pattern-icon">üé©</div>
                                <div class="pattern-name">Double Time</div>
                            </div>
                            
                            <!-- 808 Bass Patterns -->
                            <div class="pattern-block" draggable="true" data-type="808" data-pattern="rolling">
                                <div class="pattern-icon">üîä</div>
                                <div class="pattern-name">808 Rolling</div>
                            </div>
                            <div class="pattern-block" draggable="true" data-type="808" data-pattern="melodic">
                                <div class="pattern-icon">üîä</div>
                                <div class="pattern-name">808 Melodic</div>
                            </div>
                            
                            <!-- Snare Patterns -->
                            <div class="pattern-block" draggable="true" data-type="snare" data-pattern="classic">
                                <div class="pattern-icon">üëè</div>
                                <div class="pattern-name">Snare Basic</div>
                            </div>
                            <div class="pattern-block" draggable="true" data-type="snare" data-pattern="roll">
                                <div class="pattern-icon">üëè</div>
                                <div class="pattern-name">Snare Roll</div>
                            </div>
                            
                            <!-- Special Elements -->
                            <div class="pattern-block" draggable="true" data-type="melody" data-pattern="chord">
                                <div class="pattern-icon">üéπ</div>
                                <div class="pattern-name">Chord Prog</div>
                            </div>
                            <div class="pattern-block" draggable="true" data-type="fx" data-pattern="riser">
                                <div class="pattern-icon">‚ö°</div>
                                <div class="pattern-name">Riser FX</div>
                            </div>
                        </div>
                    </div>

                    <!-- Arrangement Timeline Grid -->
                    <div style="background: #000; padding: 20px; border-radius: 10px; overflow-x: auto;">
                        <div id="arrangementTimeline" style="min-width: 800px;">
                            <!-- Timeline header with bar markers -->
                            <div style="display: flex; margin-bottom: 10px; padding-left: 120px;">
                                <div id="timelineMarkers" style="display: flex; flex: 1;">
                                    <!-- Generated by JS -->
                                </div>
                            </div>
                            
                            <!-- Track rows -->
                            <div id="timelineTracks">
                                <!-- Track 1: Kick -->
                                <div class="timeline-track" data-track="kick">
                                    <div class="track-label">
                                        <span class="track-icon">ü•Å</span>
                                        <span>Kick</span>
                                    </div>
                                    <div class="track-content" data-track-type="kick"></div>
                                </div>
                                
                                <!-- Track 2: Snare -->
                                <div class="timeline-track" data-track="snare">
                                    <div class="track-label">
                                        <span class="track-icon">üëè</span>
                                        <span>Snare</span>
                                    </div>
                                    <div class="track-content" data-track-type="snare"></div>
                                </div>
                                
                                <!-- Track 3: Hi-Hat -->
                                <div class="timeline-track" data-track="hihat">
                                    <div class="track-label">
                                        <span class="track-icon">üé©</span>
                                        <span>Hi-Hat</span>
                                    </div>
                                    <div class="track-content" data-track-type="hihat"></div>
                                </div>
                                
                                <!-- Track 4: 808 Bass -->
                                <div class="timeline-track" data-track="808">
                                    <div class="track-label">
                                        <span class="track-icon">üîä</span>
                                        <span>808</span>
                                    </div>
                                    <div class="track-content" data-track-type="808"></div>
                                </div>
                                
                                <!-- Track 5: Melody -->
                                <div class="timeline-track" data-track="melody">
                                    <div class="track-label">
                                        <span class="track-icon">üéπ</span>
                                        <span>Melody</span>
                                    </div>
                                    <div class="track-content" data-track-type="melody"></div>
                                </div>
                                
                                <!-- Track 6: FX -->
                                <div class="timeline-track" data-track="fx">
                                    <div class="track-label">
                                        <span class="track-icon">‚ö°</span>
                                        <span>FX</span>
                                    </div>
                                    <div class="track-content" data-track-type="fx"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Arrangement Info -->
                    <div style="margin-top: 15px; padding: 15px; background: var(--bg-tertiary); border-radius: 10px; text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.9em;">
                            <strong style="color: var(--accent-gold);">üí° Tips:</strong>
                            Drag patterns from the library onto tracks. Click blocks to delete. Double-click to edit. Build intro ‚Üí verse ‚Üí chorus ‚Üí outro!
                        </div>
                    </div>

                    <!-- Quick Arrangement Presets -->
                    <div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 10px;">
                        <h4 style="color: var(--accent-secondary); margin-bottom: 15px; font-size: 1em;">
                            üéØ Quick Arrangement Templates
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button class="btn btn-secondary" onclick="loadArrangementTemplate('intro-verse-chorus')">
                                üìä Intro ‚Üí Verse ‚Üí Chorus
                            </button>
                            <button class="btn btn-secondary" onclick="loadArrangementTemplate('trap-buildup')">
                                üî• Trap Buildup
                            </button>
                            <button class="btn btn-secondary" onclick="loadArrangementTemplate('drill-structure')">
                                üî´ Drill Structure
                            </button>
                            <button class="btn btn-secondary" onclick="loadArrangementTemplate('minimal-loop')">
                                üéµ Minimal Loop
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Synthesis Architecture Info -->
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="toggleSynthInfo()" style="width: 100%;">
                    üéõÔ∏è View Synthesis Architecture
                </button>
                <div id="synthInfo" class="output-box" style="display: none; margin-top: 10px;">
                    <pre>
<strong>üîä 808 Bass Synthesis Chain:</strong>
VCO1 (Sine) ‚Üí VCF (Lowpass) ‚Üí Distortion ‚Üí VCA ‚Üí Output
VCO2 (Sine) ‚Üó

Parameters:
‚Ä¢ Dual oscillators (slight detune for thickness)
‚Ä¢ Pitch envelope (optional glide)
‚Ä¢ Filter modulation (follows decay envelope)
‚Ä¢ Distortion/saturation for harmonics
‚Ä¢ ADSR envelope control

<strong>ü•Å Kick Drum Synthesis:</strong>
Body Osc (Sine) ‚Üí Filter ‚Üí Master Gain ‚Üí Output
Punch Osc (Sine) ‚Üó

Parameters:
‚Ä¢ Body: 120Hz ‚Üí 40Hz pitch sweep
‚Ä¢ Punch: 200Hz ‚Üí 60Hz quick attack
‚Ä¢ Dual envelope (body + punch)
‚Ä¢ Lowpass filter sweep

<strong>üëè Snare Drum Synthesis:</strong>
Tone Osc (Triangle) ‚Üí HPF ‚Üí Tone Gain ‚Üò
White Noise ‚Üí BPF ‚Üí Noise Gain ‚Üí Master ‚Üí Output

Parameters:
‚Ä¢ Tone: 200Hz ‚Üí 100Hz sweep
‚Ä¢ Noise: Bandpass @ 3kHz
‚Ä¢ Dual component (tonal + noise)
‚Ä¢ Short attack envelope

<strong>üé© Hi-Hat Synthesis:</strong>
Osc1 (Square 317Hz) ‚Üò
Osc2 (Square 421Hz) ‚Üí HPF @ 7kHz ‚Üí Master ‚Üí Output
Osc3 (Square 543Hz) ‚Üó
Osc4 (Square 789Hz) ‚Üó
White Noise ‚Üí BPF @ 10kHz ‚Üó

Parameters:
‚Ä¢ 4 inharmonic oscillators (metallic)
‚Ä¢ White noise for shimmer
‚Ä¢ High-pass filtering for brightness
‚Ä¢ Very short decay (30-50ms)
                    </pre>
                </div>
            </div>
        </div>

        <!-- Quick Reference -->
        <div class="tool-section animated">
            <h2>üìö Quick Reference Guide</h2>
            
            <h3>üéº BPM Ranges by Genre</h3>
            <div class="tool-grid">
                <div class="preset-card">
                    <div class="preset-icon">üíø</div>
                    <div class="preset-name">Boom-Bap</div>
                    <div class="preset-desc">85-95 BPM</div>
                </div>
                <div class="preset-card">
                    <div class="preset-icon">üî•</div>
                    <div class="preset-name">Modern Trap</div>
                    <div class="preset-desc">130-150 BPM</div>
                </div>
                <div class="preset-card">
                    <div class="preset-icon">üî´</div>
                    <div class="preset-name">Drill</div>
                    <div class="preset-desc">140-150 BPM</div>
                </div>
                <div class="preset-card">
                    <div class="preset-icon">‚òÅÔ∏è</div>
                    <div class="preset-name">Cloud Rap</div>
                    <div class="preset-desc">60-80 BPM</div>
                </div>
                <div class="preset-card">
                    <div class="preset-icon">üíÄ</div>
                    <div class="preset-name">Phonk</div>
                    <div class="preset-desc">120-140 BPM</div>
                </div>
                <div class="preset-card">
                    <div class="preset-icon">üåä</div>
                    <div class="preset-name">Wave</div>
                    <div class="preset-desc">110-130 BPM</div>
                </div>
            </div>

            <h3>üéπ Popular Trap Scales</h3>
            <div style="margin: 20px 0;">
                <div class="chord-item">
                    <span class="chord-name">A Minor Pentatonic</span>
                    <span class="chord-notes">A - C - D - E - G</span>
                </div>
                <div class="chord-item">
                    <span class="chord-name">E Minor Pentatonic</span>
                    <span class="chord-notes">E - G - A - B - D</span>
                </div>
                <div class="chord-item">
                    <span class="chord-name">F# Minor Pentatonic</span>
                    <span class="chord-notes">F# - A - B - C# - E</span>
                </div>
                <div class="chord-item">
                    <span class="chord-name">C Minor Pentatonic</span>
                    <span class="chord-notes">C - Eb - F - G - Bb</span>
                </div>
            </div>

            <h3>üéöÔ∏è Frequency Chart</h3>
            <div class="output-box">
                <pre>
Sub-Bass (808):      20-80 Hz    [Foundation]
Kick Punch:          50-120 Hz   [Impact]
Snare Body:          200-400 Hz  [Warmth]
Snare Crack:         2-5 kHz     [Attack]
Hi-Hats:             8-15 kHz    [Brightness]
Melody/Bells:        1-5 kHz     [Presence]
Pads:                200-800 Hz  [Atmosphere]
                </pre>
            </div>
        </div>
    </div>

    <script>
        // Audio Context
        let audioContext;
        let beatInterval;
        let isPlaying = false;

        // Initialize Audio Context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // ============================================
        // LIVE GUIDANCE SYSTEM
        // ============================================
        
        function toggleGuidance() {
            const panel = document.getElementById('guidancePanel');
            const toggle = document.getElementById('guidanceToggle');
            panel.classList.toggle('minimized');
            toggle.textContent = panel.classList.contains('minimized') ? '+' : '‚àí';
        }
        
        // ============================================
        // ADVANCED MODE TOGGLE
        // ============================================
        
        let isAdvancedMode = false;
        
        function toggleAdvancedMode() {
            isAdvancedMode = !isAdvancedMode;
            const advancedSections = document.querySelectorAll('.advanced-section, #advancedSynthControls');
            const modeText = document.getElementById('modeText');
            const modeToggle = document.getElementById('modeToggle');
            
            advancedSections.forEach(section => {
                section.style.display = isAdvancedMode ? 'block' : 'none';
            });
            
            // Update button text and style
            if (isAdvancedMode) {
                modeText.textContent = 'Expert Mode';
                modeToggle.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                modeToggle.style.color = '#000';
                
                // Show notification
                showAdvancedNotification('üéõÔ∏è Expert Mode Enabled', 'Advanced synthesis controls are now visible');
            } else {
                modeText.textContent = 'Basic Mode';
                modeToggle.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                modeToggle.style.color = 'var(--text-primary)';
                
                showAdvancedNotification('üéµ Basic Mode Enabled', 'Advanced controls hidden for simpler workflow');
            }
            
            // Save preference
            localStorage.setItem('trap-studio-mode', isAdvancedMode ? 'advanced' : 'basic');
        }
        
        function showAdvancedNotification(title, message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                z-index: 10000;
                min-width: 300px;
                border: 1px solid rgba(255,255,255,0.2);
                backdrop-filter: blur(10px);
            `;
            notification.innerHTML = `
                <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 6px;">${title}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">${message}</div>
            `;
            document.body.appendChild(notification);
            
            // Slide in animation
            notification.style.transform = 'translateX(400px)';
            notification.style.transition = 'transform 0.3s ease-out';
            setTimeout(() => notification.style.transform = 'translateX(0)', 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Load saved mode preference on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('trap-studio-mode') || 'basic';
            if (savedMode === 'advanced') {
                toggleAdvancedMode();
            }
        });

        function updateGuidance(type, value) {
            const content = document.getElementById('guidanceContent');
            let tip = '';
            
            switch(type) {
                case 'bpm':
                    const bpmNum = parseInt(value);
                    let bpmStyle = '';
                    if (bpmNum < 90) bpmStyle = 'Slow Boom-Bap';
                    else if (bpmNum < 130) bpmStyle = 'Mid-Tempo Hip-Hop';
                    else if (bpmNum < 150) bpmStyle = 'Classic Trap';
                    else if (bpmNum < 165) bpmStyle = 'Fast Drill';
                    else bpmStyle = 'Hypercore';
                    
                    document.getElementById('bpmStyle').textContent = bpmStyle;
                    
                    tip = `
                        <div class="guidance-tip" style="background: rgba(255, 46, 99, 0.15); border-left-color: var(--accent-primary);">
                            <div class="guidance-tip-title">üéµ BPM: ${value} - ${bpmStyle}</div>
                            <div class="guidance-tip-text">
                                ${bpmNum < 90 ? 'üíø Perfect for boom-bap and lo-fi beats' :
                                  bpmNum < 130 ? 'üé§ Classic hip-hop tempo - great for rap vocals' :
                                  bpmNum < 150 ? 'üî• Classic trap speed - modern trap standard' :
                                  bpmNum < 165 ? 'üî´ UK/NY Drill territory - aggressive and hard' :
                                  '‚ö° Hypercore/speedcore - experimental and intense'}
                            </div>
                        </div>
                    `;
                    break;
                    
                case '808freq':
                    const freq = parseInt(value);
                    let note = '';
                    if (freq >= 49 && freq <= 52) note = 'G#1 (Drill)';
                    else if (freq >= 53 && freq <= 58) note = 'A1 (Classic Trap)';
                    else if (freq >= 59 && freq <= 62) note = 'B‚ô≠1';
                    else if (freq >= 63 && freq <= 70) note = 'C2';
                    else note = freq < 49 ? 'Sub-Bass Territory' : 'Upper Bass';
                    
                    document.getElementById('freq808Note').textContent = note;
                    break;
                    
                case '808decay':
                    const decay = parseFloat(value);
                    let decayStyle = decay < 0.3 ? 'Kick-like (Punchy)' :
                                    decay < 0.6 ? 'Short Bass' :
                                    decay < 1.2 ? 'Rolling Bass' :
                                    'Long Sustain';
                    document.getElementById('decay808Style').textContent = decayStyle;
                    break;
                    
                case '808cutoff':
                    const cutoff = parseInt(value);
                    let cutoffStyle = cutoff < 120 ? 'Pure Sub-Bass (Club)' :
                                     cutoff < 250 ? 'Club Sub-Bass' :
                                     cutoff < 350 ? 'Bedroom Bass' :
                                     'Bright/Harmonics';
                    document.getElementById('cutoff808Style').textContent = cutoffStyle;
                    break;
                    
                case '808res':
                    const res = parseFloat(value);
                    let resStyle = res < 0.3 ? 'Smooth' :
                                  res < 0.7 ? 'Punchy' :
                                  'Resonant/Screaming';
                    document.getElementById('res808Style').textContent = resStyle;
                    break;
                    
                case '808dist':
                    const dist = parseInt(value);
                    let distStyle = dist === 0 ? 'Clean' :
                                   dist < 30 ? 'Warm Saturation' :
                                   dist < 60 ? 'Gritty' :
                                   'Heavy Distortion';
                    document.getElementById('dist808Style').textContent = distStyle;
                    break;
                    
                case '808glide':
                    const glide = parseInt(value);
                    let glideStyle = glide === 0 ? 'No Glide' :
                                    glide < 80 ? 'Subtle Slides' :
                                    glide < 150 ? 'Moderate Glide' :
                                    'Dramatic Slides';
                    document.getElementById('glide808Style').textContent = glideStyle;
                    break;
                    
                case 'key':
                    tip = `
                        <div class="guidance-tip" style="background: rgba(8, 217, 214, 0.15); border-left-color: var(--accent-secondary);">
                            <div class="guidance-tip-title">üéº Key Changed</div>
                            <div class="guidance-tip-text">
                                Popular trap keys: F# Minor (dark), A Minor (balanced), D Minor (emotional)
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'mode':
                    tip = `
                        <div class="guidance-tip" style="background: rgba(8, 217, 214, 0.15); border-left-color: var(--accent-secondary);">
                            <div class="guidance-tip-title">üé≠ ${value === 'minor' ? 'Minor Mode' : 'Major Mode'}</div>
                            <div class="guidance-tip-text">
                                ${value === 'minor' ? 
                                  'üåë Dark, aggressive, emotional - the classic trap sound' :
                                  '‚òÄÔ∏è Bright, uplifting, melodic - modern melodic trap'}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'progression':
                    const progNames = {
                        dark_trap: 'Dark Trap',
                        melodic_trap: 'Melodic Trap',
                        drill: 'UK/NY Drill',
                        cloud_rap: 'Cloud Rap',
                        boom_bap: 'Boom-Bap',
                        emotional: 'Emotional'
                    };
                    tip = `
                        <div class="guidance-tip" style="background: rgba(8, 217, 214, 0.15); border-left-color: var(--accent-secondary);">
                            <div class="guidance-tip-title">üéµ ${progNames[value] || 'Custom'} Progression</div>
                            <div class="guidance-tip-text">
                                Each progression creates a unique mood. Try them all to find your sound!
                            </div>
                        </div>
                    `;
                    break;
            }
            
            if (tip) {
                // Add tip at the top of guidance content
                const existingContent = content.innerHTML;
                content.innerHTML = tip + existingContent;
                
                // Keep only last 5 tips
                const tips = content.querySelectorAll('.guidance-tip');
                if (tips.length > 5) {
                    tips[tips.length - 1].remove();
                }
            }
        }

        // Quick preset loaders
        function loadChordPreset(type) {
            const presets = {
                'dark-trap': { key: 'F#', mode: 'minor', progression: 'dark_trap' },
                'melodic': { key: 'A', mode: 'minor', progression: 'melodic_trap' },
                'drill': { key: 'F#', mode: 'minor', progression: 'drill' }
            };
            
            if (presets[type]) {
                document.getElementById('chordKey').value = presets[type].key;
                document.getElementById('chordMode').value = presets[type].mode;
                document.getElementById('progressionType').value = presets[type].progression;
                generateChordProgression();
            }
        }

        function load808Preset(type) {
            const presets = {
                'classic': { freq: 55, decay: 0.8, cutoff: 180, res: 0.4, dist: 0, glide: 0 },
                'punchy': { freq: 55, decay: 0.3, cutoff: 150, res: 0.6, dist: 20, glide: 0 },
                'deep': { freq: 45, decay: 1.2, cutoff: 100, res: 0.3, dist: 0, glide: 50 },
                'distorted': { freq: 55, decay: 0.6, cutoff: 250, res: 0.7, dist: 60, glide: 30 }
            };
            
            if (presets[type]) {
                const p = presets[type];
                document.getElementById('bass808Freq').value = p.freq;
                document.getElementById('bass808Decay').value = p.decay;
                document.getElementById('bass808Cutoff').value = p.cutoff;
                document.getElementById('bass808Resonance').value = p.res;
                document.getElementById('bass808Distortion').value = p.dist;
                document.getElementById('bass808Glide').value = p.glide;
                
                update808Param('freq', p.freq);
                update808Param('decay', p.decay);
                update808Param('cutoff', p.cutoff);
                update808Param('resonance', p.res);
                update808Param('distortion', p.dist);
                update808Param('glide', p.glide);
                
                play808Preview();
            }
        }

        // Chord Theory Data
        const chordTheory = {
            notes: ['C', 'Db', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'],
            
            progressions: {
                dark_trap: {
                    name: 'Dark Trap',
                    degrees: [0, 5, 2, 6], // i-VI-III-VII
                    description: 'Classic dark trap sound'
                },
                melodic_trap: {
                    name: 'Melodic Trap',
                    degrees: [0, 3, 6, 5], // i-iv-VII-VI
                    description: 'Emotional, melodic vibe'
                },
                drill: {
                    name: 'Drill',
                    degrees: [0, 2, 6, 5], // i-III-VII-VI
                    description: 'UK/NY Drill progression'
                },
                cloud_rap: {
                    name: 'Cloud Rap',
                    degrees: [5, 3, 0, 4], // vi-IV-I-V
                    description: 'Dreamy, atmospheric'
                },
                boom_bap: {
                    name: 'Boom-Bap',
                    degrees: [0, 6, 5, 4], // i-VII-VI-V
                    description: '90s hip-hop classic'
                },
                emotional: {
                    name: 'Emotional',
                    degrees: [0, 4, 5, 2], // i-v-VI-III
                    description: 'Sad, introspective'
                }
            },

            minorScale: [0, 2, 3, 5, 7, 8, 10], // Natural minor intervals
            majorScale: [0, 2, 4, 5, 7, 9, 11],

            getChordNotes(root, type) {
                const rootIndex = this.notes.indexOf(root);
                let intervals;
                
                if (type === 'minor') {
                    intervals = [0, 3, 7]; // Minor triad
                } else if (type === 'major') {
                    intervals = [0, 4, 7]; // Major triad
                } else if (type === 'dim') {
                    intervals = [0, 3, 6]; // Diminished
                }
                
                return intervals.map(interval => 
                    this.notes[(rootIndex + interval) % 12]
                );
            }
        };

        // Generate Chord Progression
        function generateChordProgression() {
            const key = document.getElementById('chordKey').value;
            const mode = document.getElementById('chordMode').value;
            const progressionType = document.getElementById('progressionType').value;
            
            const progression = chordTheory.progressions[progressionType];
            const scale = mode === 'minor' ? chordTheory.minorScale : chordTheory.majorScale;
            const rootIndex = chordTheory.notes.indexOf(key);
            
            const chords = [];
            generatedChords = []; // Reset generated chords
            let codeOutput = `# ${progression.name} Progression in ${key} ${mode}\n\n`;
            
            progression.degrees.forEach((degree, index) => {
                const scaleNote = (rootIndex + scale[degree]) % 12;
                const chordRoot = chordTheory.notes[scaleNote];
                
                // Determine chord quality
                let chordType = 'minor';
                if (mode === 'minor') {
                    if (degree === 2 || degree === 5 || degree === 6) chordType = 'major';
                    if (degree === 1) chordType = 'dim';
                } else {
                    if (degree === 0 || degree === 3 || degree === 4) chordType = 'major';
                }
                
                const notes = chordTheory.getChordNotes(chordRoot, chordType);
                const midiNotes = notes.map(n => getMIDINote(n, 4));
                const chordSymbol = chordType === 'minor' ? 'm' : 
                                  chordType === 'dim' ? 'dim' : '';
                
                chords.push({
                    name: `${chordRoot}${chordSymbol}`,
                    notes: notes.join(' - '),
                    roman: getRomanNumeral(degree, mode)
                });
                
                // Save for playback
                generatedChords.push({
                    name: `${chordRoot}${chordSymbol}`,
                    notes: midiNotes
                });
                
                codeOutput += `Chord ${index + 1}: ${chordRoot}${chordSymbol}\n`;
                codeOutput += `Notes: ${notes.join(', ')}\n`;
                codeOutput += `MIDI: ${midiNotes.join(', ')}\n\n`;
            });
            
            displayChords(chords);
            document.getElementById('chordCode').textContent = codeOutput;
            document.getElementById('chordOutput').style.display = 'block';
        }

        function getRomanNumeral(degree, mode) {
            const numerals = ['i', 'ii', 'III', 'iv', 'v', 'VI', 'VII'];
            return mode === 'minor' ? numerals[degree] : numerals[degree].toUpperCase();
        }

        function getMIDINote(note, octave) {
            const noteIndex = chordTheory.notes.indexOf(note);
            return 12 + (octave * 12) + noteIndex;
        }

        function displayChords(chords) {
            const display = document.getElementById('chordDisplay');
            display.innerHTML = chords.map((chord, i) => `
                <div class="chord-item animated">
                    <div>
                        <span class="chord-name">${i + 1}. ${chord.name}</span>
                        <span style="margin-left: 15px; color: var(--accent-secondary);">${chord.roman}</span>
                    </div>
                    <span class="chord-notes">${chord.notes}</span>
                </div>
            `).join('');
        }

        // Play Chord Progression
        let currentChordInstrument = 'piano';
        let generatedChords = [];

        function setChordInstrument(instrument) {
            currentChordInstrument = instrument;
            
            // Update button styles
            document.querySelectorAll('[id^="inst-"]').forEach(btn => {
                btn.style.background = 'linear-gradient(135deg, var(--accent-secondary), #06b8b5)';
            });
            document.getElementById(`inst-${instrument}`).style.background = 
                'linear-gradient(135deg, var(--accent-gold), #ffed4e)';
        }

        function playChordProgression() {
            initAudio();
            
            if (generatedChords.length === 0) {
                alert('‚ö†Ô∏è Please generate a chord progression first!');
                return;
            }
            
            const ctx = audioContext;
            const startTime = ctx.currentTime + 0.1;
            const rhythmPattern = document.getElementById('rhythmPattern').value;
            const arpeggioPattern = document.getElementById('arpeggioPattern').value;
            
            // Calculate chord duration based on rhythm
            const baseDuration = rhythmPattern === 'quarter' ? 0.75 : 
                                rhythmPattern === 'triplet' ? 0.5 : 1.5;
            
            let currentTime = startTime;
            
            generatedChords.forEach((chord, chordIndex) => {
                if (arpeggioPattern === 'none') {
                    // Play full chord
                    playChordWithEffects(ctx, chord.notes, currentTime, currentChordInstrument);
                    
                    // Add rhythm variations
                    if (rhythmPattern === 'syncopated') {
                        // Play again at half position
                        playChordWithEffects(ctx, chord.notes, currentTime + baseDuration * 0.5, currentChordInstrument, 0.5);
                    } else if (rhythmPattern === 'triplet') {
                        // Play triplet pattern
                        playChordWithEffects(ctx, chord.notes, currentTime + baseDuration, currentChordInstrument, 0.7);
                        playChordWithEffects(ctx, chord.notes, currentTime + baseDuration * 2, currentChordInstrument, 0.7);
                    }
                } else {
                    // Arpeggiate the chord
                    playArpeggio(ctx, chord.notes, currentTime, arpeggioPattern, baseDuration);
                }
                
                currentTime += rhythmPattern === 'triplet' ? baseDuration * 3 : 
                              rhythmPattern === 'quarter' ? baseDuration : 
                              rhythmPattern === 'syncopated' ? baseDuration * 1.5 : baseDuration;
            });
        }

        function playChordWithEffects(ctx, midiNotes, startTime, instrument, velocityMod = 1.0) {
            // Get settings
            const octave = parseInt(document.getElementById('octaveControl').value);
            const velocity = parseInt(document.getElementById('velocityControl').value) / 100;
            const humanize = document.getElementById('humanizeToggle').checked;
            const reverb = document.getElementById('reverbToggle').checked;
            const delay = document.getElementById('delayToggle').checked;
            
            // Adjust MIDI notes for octave
            const octaveShift = (octave - 4) * 12;
            const adjustedNotes = midiNotes.map(note => note + octaveShift);
            
            // Apply humanization
            const timeOffset = humanize ? (Math.random() - 0.5) * 0.02 : 0;
            const velocityVar = humanize ? 0.9 + Math.random() * 0.2 : 1.0;
            const finalVelocity = velocity * velocityMod * velocityVar;
            
            // Create effects chain
            let destination = ctx.destination;
            let effectsChain = [];
            
            if (reverb) {
                const reverbNode = createReverb(ctx);
                effectsChain.push(reverbNode);
            }
            
            if (delay) {
                const delayNode = createDelay(ctx);
                effectsChain.push(delayNode);
            }
            
            // Connect effects chain
            if (effectsChain.length > 0) {
                destination = effectsChain[0];
                for (let i = 0; i < effectsChain.length - 1; i++) {
                    effectsChain[i].connect(effectsChain[i + 1]);
                }
                effectsChain[effectsChain.length - 1].connect(ctx.destination);
            }
            
            // Play with modified parameters
            playChordWithDestination(ctx, adjustedNotes, startTime + timeOffset, instrument, finalVelocity, destination);
        }

        function playArpeggio(ctx, midiNotes, startTime, pattern, baseDuration) {
            let noteOrder = [...midiNotes];
            
            // Determine note order based on pattern
            switch(pattern) {
                case 'up':
                    noteOrder.sort((a, b) => a - b);
                    break;
                case 'down':
                    noteOrder.sort((a, b) => b - a);
                    break;
                case 'updown':
                    noteOrder.sort((a, b) => a - b);
                    noteOrder = [...noteOrder, ...noteOrder.slice(1, -1).reverse()];
                    break;
                case 'random':
                    noteOrder = noteOrder.sort(() => Math.random() - 0.5);
                    break;
            }
            
            const noteGap = baseDuration / noteOrder.length;
            noteOrder.forEach((note, index) => {
                playChordWithEffects(ctx, [note], startTime + (index * noteGap), currentChordInstrument);
            });
        }

        function createReverb(ctx) {
            const convolver = ctx.createConvolver();
            const reverbTime = 2; // 2 seconds
            const sampleRate = ctx.sampleRate;
            const length = sampleRate * reverbTime;
            const impulse = ctx.createBuffer(2, length, sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.exp(-i / (sampleRate * 0.5));
                }
            }
            
            convolver.buffer = impulse;
            
            // Mix with dry signal
            const dryGain = ctx.createGain();
            const wetGain = ctx.createGain();
            dryGain.gain.value = 0.7;
            wetGain.gain.value = 0.3;
            
            return convolver;
        }

        function createDelay(ctx) {
            const delayNode = ctx.createDelay();
            const feedback = ctx.createGain();
            const wetGain = ctx.createGain();
            
            delayNode.delayTime.value = 0.375; // Dotted eighth note at 120 BPM
            feedback.gain.value = 0.3;
            wetGain.gain.value = 0.4;
            
            delayNode.connect(feedback);
            feedback.connect(delayNode);
            delayNode.connect(wetGain);
            
            return wetGain;
        }

        function playChordWithDestination(ctx, midiNotes, startTime, instrument, velocity, destination) {
            const frequencies = midiNotes.map(midi => midiToFrequency(midi));
            
            // Use enhanced engine if selected
            if (instrument === 'enhanced') {
                playEnhancedChord(ctx, frequencies, startTime, velocity, destination);
                return;
            }
            
            switch(instrument) {
                case 'piano':
                    playPianoChordDest(ctx, frequencies, startTime, velocity, destination);
                    break;
                case 'bells':
                    playBellsChordDest(ctx, frequencies, startTime, velocity, destination);
                    break;
                case 'pad':
                    playPadChordDest(ctx, frequencies, startTime, velocity, destination);
                    break;
                case 'pluck':
                    playPluckChordDest(ctx, frequencies, startTime, velocity, destination);
                    break;
                case 'brass':
                    playBrassChordDest(ctx, frequencies, startTime, velocity, destination);
                    break;
                case 'lead':
                    playLeadChordDest(ctx, frequencies, startTime, velocity, destination);
                    break;
            }
        }

        // ============================================
        // ENHANCED SYNTHESIS ENGINE
        // Uses advanced parameters from UI controls
        // ============================================
        
        function playEnhancedNote(ctx, freq, startTime, velocity, destination, duration = 2.0) {
            // Get synthesis parameters from UI
            const waveform = document.getElementById('waveform')?.value || 'sawtooth';
            const unisonVoices = parseInt(document.getElementById('unisonVoices')?.value || 1);
            const detuneAmount = parseFloat(document.getElementById('detuneAmount')?.value || 5);
            const harmonicCount = parseInt(document.getElementById('harmonicCount')?.value || 2);
            
            // Filter parameters
            const filterType = document.getElementById('filterType')?.value || 'lowpass';
            const filterCutoff = parseFloat(document.getElementById('filterCutoff')?.value || 2000);
            const filterResonance = parseFloat(document.getElementById('filterResonance')?.value || 1);
            const filterEnvelope = parseFloat(document.getElementById('filterEnvelope')?.value || 50) / 100;
            
            // Envelope parameters
            const attackTime = parseFloat(document.getElementById('attackTime')?.value || 0.01);
            const decayTime = parseFloat(document.getElementById('decayTime')?.value || 0.3);
            const sustainLevel = parseFloat(document.getElementById('sustainLevel')?.value || 70) / 100;
            const releaseTime = parseFloat(document.getElementById('releaseTime')?.value || 0.5);
            
            // LFO parameters
            const lfoEnabled = document.getElementById('lfoEnabled')?.checked || false;
            const lfoRate = parseFloat(document.getElementById('lfoRate')?.value || 4);
            const lfoDepth = parseFloat(document.getElementById('lfoDepth')?.value || 30) / 100;
            const lfoTarget = document.getElementById('lfoTarget')?.value || 'filter';
            
            // Automation
            const autoFilter = document.getElementById('autoFilterEnabled')?.checked || false;
            const autoVolume = document.getElementById('autoVolumeEnabled')?.checked || false;
            const autoPan = document.getElementById('autoPanEnabled')?.checked || false;
            
            // Create master filter
            const masterFilter = ctx.createBiquadFilter();
            masterFilter.type = filterType;
            masterFilter.frequency.setValueAtTime(filterCutoff, startTime);
            masterFilter.Q.setValueAtTime(filterResonance, startTime);
            
            // Create master gain
            const masterGain = ctx.createGain();
            
            // Create panner for auto-pan
            const panner = ctx.createStereoPanner();
            panner.pan.setValueAtTime(0, startTime);
            
            // LFO setup
            let lfo = null;
            let lfoGain = null;
            if (lfoEnabled) {
                lfo = ctx.createOscillator();
                lfoGain = ctx.createGain();
                lfo.frequency.setValueAtTime(lfoRate, startTime);
                lfo.connect(lfoGain);
                
                if (lfoTarget === 'pitch') {
                    lfoGain.gain.setValueAtTime(freq * lfoDepth * 0.1, startTime);
                } else if (lfoTarget === 'filter') {
                    lfoGain.gain.setValueAtTime(filterCutoff * lfoDepth, startTime);
                    lfoGain.connect(masterFilter.frequency);
                } else if (lfoTarget === 'volume') {
                    lfoGain.gain.setValueAtTime(velocity * lfoDepth, startTime);
                    lfoGain.connect(masterGain.gain);
                }
                
                lfo.start(startTime);
                lfo.stop(startTime + duration);
            }
            
            // Create unison voices with harmonics
            const oscillators = [];
            const gains = [];
            
            for (let voice = 0; voice < unisonVoices; voice++) {
                // Calculate detune for this voice
                const voiceDetune = voice === Math.floor(unisonVoices / 2) ? 0 : 
                    ((voice - Math.floor(unisonVoices / 2)) * detuneAmount);
                
                // Create fundamental oscillator
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = waveform;
                osc.frequency.setValueAtTime(freq, startTime);
                osc.detune.setValueAtTime(voiceDetune, startTime);
                
                // Connect pitch LFO if enabled
                if (lfoEnabled && lfoTarget === 'pitch') {
                    lfoGain.connect(osc.frequency);
                }
                
                osc.connect(gain);
                gain.connect(masterFilter);
                
                // Voice amplitude (center voice louder)
                const voiceAmp = voice === Math.floor(unisonVoices / 2) ? 1.0 : 0.7;
                gain.gain.setValueAtTime(voiceAmp / unisonVoices, startTime);
                
                oscillators.push(osc);
                gains.push(gain);
                
                // Add harmonics
                for (let h = 1; h <= harmonicCount; h++) {
                    const harmOsc = ctx.createOscillator();
                    const harmGain = ctx.createGain();
                    
                    harmOsc.type = 'sine'; // Harmonics always sine
                    harmOsc.frequency.setValueAtTime(freq * (h + 1), startTime);
                    harmOsc.detune.setValueAtTime(voiceDetune, startTime);
                    
                    harmOsc.connect(harmGain);
                    harmGain.connect(masterFilter);
                    
                    // Decreasing amplitude for higher harmonics
                    harmGain.gain.setValueAtTime((voiceAmp / unisonVoices) * (0.5 / (h + 1)), startTime);
                    
                    oscillators.push(harmOsc);
                    gains.push(harmGain);
                }
            }
            
            // Connect filter -> gain -> panner -> destination
            masterFilter.connect(masterGain);
            masterGain.connect(panner);
            panner.connect(destination);
            
            // Apply ADSR envelope
            masterGain.gain.setValueAtTime(0, startTime);
            masterGain.gain.linearRampToValueAtTime(velocity, startTime + attackTime);
            masterGain.gain.linearRampToValueAtTime(velocity * sustainLevel, startTime + attackTime + decayTime);
            masterGain.gain.linearRampToValueAtTime(velocity * sustainLevel, startTime + duration - releaseTime);
            masterGain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
            
            // Filter envelope modulation
            const filterEnvAmount = filterCutoff * filterEnvelope * 2;
            masterFilter.frequency.setValueAtTime(filterCutoff, startTime);
            masterFilter.frequency.linearRampToValueAtTime(filterCutoff + filterEnvAmount, startTime + attackTime);
            masterFilter.frequency.exponentialRampToValueAtTime(filterCutoff, startTime + attackTime + decayTime + 0.5);
            
            // Automation effects
            if (autoFilter) {
                // Slow filter sweep over duration
                masterFilter.frequency.exponentialRampToValueAtTime(filterCutoff * 0.3, startTime + duration * 0.8);
            }
            
            if (autoVolume) {
                // Volume fade
                masterGain.gain.linearRampToValueAtTime(velocity * 0.3, startTime + duration * 0.9);
            }
            
            if (autoPan) {
                // Auto-pan from left to right
                panner.pan.linearRampToValueAtTime(-1, startTime + duration * 0.5);
                panner.pan.linearRampToValueAtTime(1, startTime + duration);
            }
            
            // Start and stop all oscillators
            oscillators.forEach(osc => {
                osc.start(startTime);
                osc.stop(startTime + duration);
            });
        }

        function playEnhancedChord(ctx, frequencies, startTime, velocity, destination) {
            frequencies.forEach((freq, index) => {
                const noteDelay = index * 0.02; // Slight stagger for richness
                playEnhancedNote(ctx, freq, startTime + noteDelay, velocity * (1 - index * 0.1), destination, 2.0);
            });
        }

        function randomizeChordProgression() {
            // Randomize key
            const keys = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'];
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            document.getElementById('chordKey').value = randomKey;
            
            // Randomize mode
            const mode = Math.random() > 0.5 ? 'minor' : 'major';
            document.getElementById('chordMode').value = mode;
            
            // Randomize progression type
            const types = ['dark_trap', 'melodic_trap', 'drill', 'cloud_rap', 'boom_bap', 'emotional'];
            const randomType = types[Math.floor(Math.random() * types.length)];
            document.getElementById('progressionType').value = randomType;
            
            // Generate and play
            generateChordProgression();
            
            // Visual feedback
            const display = document.getElementById('chordDisplay');
            display.style.animation = 'none';
            setTimeout(() => {
                display.style.animation = 'slideIn 0.5s ease-out';
            }, 10);
        }

        // Preset System
        const chordPresets = {
            'dark_piano': { 
                instrument: 'piano', 
                key: 'A', 
                mode: 'minor', 
                type: 'dark_trap',
                octave: 3,
                arpeggio: 'none',
                rhythm: 'whole'
            },
            'bright_bells': { 
                instrument: 'bells', 
                key: 'C', 
                mode: 'major', 
                type: 'melodic_trap',
                octave: 5,
                arpeggio: 'up',
                rhythm: 'quarter'
            },
            'ambient_pad': { 
                instrument: 'pad', 
                key: 'F', 
                mode: 'minor', 
                type: 'emotional',
                octave: 3,
                arpeggio: 'none',
                rhythm: 'whole'
            },
            'trap_pluck': { 
                instrument: 'pluck', 
                key: 'D', 
                mode: 'minor', 
                type: 'drill',
                octave: 4,
                arpeggio: 'updown',
                rhythm: 'syncopated'
            },
            'drill_brass': { 
                instrument: 'brass', 
                key: 'E', 
                mode: 'minor', 
                type: 'drill',
                octave: 4,
                arpeggio: 'none',
                rhythm: 'quarter'
            },
            'hyperpop_lead': { 
                instrument: 'lead', 
                key: 'G', 
                mode: 'major', 
                type: 'melodic_trap',
                octave: 5,
                arpeggio: 'random',
                rhythm: 'triplet'
            }
        };

        function loadPreset(presetName) {
            const preset = chordPresets[presetName];
            if (!preset) return;
            
            // Set chord parameters
            document.getElementById('chordKey').value = preset.key;
            document.getElementById('chordMode').value = preset.mode;
            document.getElementById('progressionType').value = preset.type;
            
            // Set instrument
            setChordInstrument(preset.instrument);
            
            // Set playback options
            document.getElementById('octaveControl').value = preset.octave;
            document.getElementById('octaveValue').textContent = preset.octave;
            document.getElementById('arpeggioPattern').value = preset.arpeggio;
            document.getElementById('rhythmPattern').value = preset.rhythm;
            
            // Generate progression
            generateChordProgression();
            
            // Visual feedback
            const display = document.getElementById('chordDisplay');
            display.style.animation = 'none';
            setTimeout(() => {
                display.style.animation = 'slideIn 0.5s ease-out';
            }, 10);
        }

        // Play a single chord with chosen instrument
        function playChord(ctx, midiNotes, startTime, instrument) {
            const frequencies = midiNotes.map(midi => midiToFrequency(midi));
            
            switch(instrument) {
                case 'piano':
                    playPianoChord(ctx, frequencies, startTime);
                    break;
                case 'bells':
                    playBellsChord(ctx, frequencies, startTime);
                    break;
                case 'pad':
                    playPadChord(ctx, frequencies, startTime);
                    break;
                case 'pluck':
                    playPluckChord(ctx, frequencies, startTime);
                    break;
                case 'brass':
                    playBrassChord(ctx, frequencies, startTime);
                    break;
                case 'lead':
                    playLeadChord(ctx, frequencies, startTime);
                    break;
            }
        }

        // Convert MIDI note to frequency
        function midiToFrequency(midi) {
            return 440 * Math.pow(2, (midi - 69) / 12);
        }

        // Destination-aware synthesis wrappers
        function playPianoChordDest(ctx, frequencies, startTime, velocity = 0.3, destination = null) {
            playInstrumentChord(ctx, frequencies, startTime, velocity, destination || ctx.destination, 'piano');
        }

        function playBellsChordDest(ctx, frequencies, startTime, velocity = 0.25, destination = null) {
            playInstrumentChord(ctx, frequencies, startTime, velocity, destination || ctx.destination, 'bells');
        }

        function playPadChordDest(ctx, frequencies, startTime, velocity = 0.15, destination = null) {
            playInstrumentChord(ctx, frequencies, startTime, velocity, destination || ctx.destination, 'pad');
        }

        function playPluckChordDest(ctx, frequencies, startTime, velocity = 0.4, destination = null) {
            playInstrumentChord(ctx, frequencies, startTime, velocity, destination || ctx.destination, 'pluck');
        }

        function playBrassChordDest(ctx, frequencies, startTime, velocity = 0.25, destination = null) {
            playInstrumentChord(ctx, frequencies, startTime, velocity, destination || ctx.destination, 'brass');
        }

        function playLeadChordDest(ctx, frequencies, startTime, velocity = 0.2, destination = null) {
            playInstrumentChord(ctx, frequencies, startTime, velocity, destination || ctx.destination, 'lead');
        }

        function playInstrumentChord(ctx, frequencies, startTime, velocity, destination, type) {
            frequencies.forEach((freq, index) => {
                if (type === 'piano') {
                    playPianoNote(ctx, freq, startTime, velocity - (index * 0.05), destination);
                } else if (type === 'bells') {
                    playBellsNote(ctx, freq, startTime, velocity - (index * 0.1), destination);
                } else if (type === 'pad') {
                    playPadNote(ctx, freq, startTime, velocity - (index * 0.02), destination);
                } else if (type === 'pluck') {
                    playPluckNote(ctx, freq, startTime, velocity - (index * 0.08), destination);
                } else if (type === 'brass') {
                    playBrassNote(ctx, freq, startTime, velocity - (index * 0.04), destination);
                } else if (type === 'lead') {
                    playLeadNote(ctx, freq, startTime, velocity - (index * 0.03), destination);
                }
            });
        }

        function playPianoNote(ctx, freq, startTime, velocity, destination) {
            const osc1 = ctx.createOscillator();
            const osc2 = ctx.createOscillator();
            const osc3 = ctx.createOscillator();
            
            osc1.frequency.setValueAtTime(freq, startTime);
            osc2.frequency.setValueAtTime(freq * 2, startTime);
            osc3.frequency.setValueAtTime(freq * 3, startTime);
            
            osc1.type = 'sine';
            osc2.type = 'sine';
            osc3.type = 'triangle';
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(3000, startTime);
            filter.Q.setValueAtTime(1, startTime);
            
            const gain1 = ctx.createGain();
            const gain2 = ctx.createGain();
            const gain3 = ctx.createGain();
            const masterGain = ctx.createGain();
            
            osc1.connect(gain1);
            osc2.connect(gain2);
            osc3.connect(gain3);
            gain1.connect(filter);
            gain2.connect(filter);
            gain3.connect(filter);
            filter.connect(masterGain);
            masterGain.connect(destination);
            
            gain1.gain.setValueAtTime(0.8, startTime);
            gain2.gain.setValueAtTime(0.3, startTime);
            gain3.gain.setValueAtTime(0.15, startTime);
            
            masterGain.gain.setValueAtTime(0, startTime);
            masterGain.gain.linearRampToValueAtTime(velocity, startTime + 0.01);
            masterGain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.2);
            
            filter.frequency.exponentialRampToValueAtTime(800, startTime + 0.8);
            
            osc1.start(startTime);
            osc2.start(startTime);
            osc3.start(startTime);
            osc1.stop(startTime + 1.5);
            osc2.stop(startTime + 1.5);
            osc3.stop(startTime + 1.5);
        }

        function playBellsNote(ctx, freq, startTime, velocity, destination) {
            const partials = [1, 2.76, 5.4, 8.93];
            partials.forEach((ratio, pIndex) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq * ratio, startTime);
                
                osc.connect(gain);
                gain.connect(destination);
                
                const amplitude = (velocity / (pIndex + 1));
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(amplitude, startTime + 0.005);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.5);
                
                osc.start(startTime);
                osc.stop(startTime + 1.8);
            });
        }

        function playPadNote(ctx, freq, startTime, velocity, destination) {
            const osc1 = ctx.createOscillator();
            const osc2 = ctx.createOscillator();
            const osc3 = ctx.createOscillator();
            
            osc1.type = 'sawtooth';
            osc2.type = 'sawtooth';
            osc3.type = 'triangle';
            
            osc1.frequency.setValueAtTime(freq, startTime);
            osc2.frequency.setValueAtTime(freq * 1.01, startTime);
            osc3.frequency.setValueAtTime(freq * 0.99, startTime);
            
            const lfo = ctx.createOscillator();
            const lfoGain = ctx.createGain();
            lfo.frequency.setValueAtTime(4, startTime);
            lfoGain.gain.setValueAtTime(3, startTime);
            
            lfo.connect(lfoGain);
            lfoGain.connect(osc1.frequency);
            lfoGain.connect(osc2.frequency);
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(1200, startTime);
            filter.Q.setValueAtTime(0.7, startTime);
            
            const gain = ctx.createGain();
            
            osc1.connect(filter);
            osc2.connect(filter);
            osc3.connect(filter);
            filter.connect(gain);
            gain.connect(destination);
            
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(velocity, startTime + 0.4);
            gain.gain.linearRampToValueAtTime(velocity * 0.8, startTime + 1.2);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 2.0);
            
            filter.frequency.linearRampToValueAtTime(1800, startTime + 0.3);
            filter.frequency.linearRampToValueAtTime(1000, startTime + 1.5);
            
            lfo.start(startTime);
            osc1.start(startTime);
            osc2.start(startTime);
            osc3.start(startTime);
            lfo.stop(startTime + 2.2);
            osc1.stop(startTime + 2.2);
            osc2.stop(startTime + 2.2);
            osc3.stop(startTime + 2.2);
        }

        function playPluckNote(ctx, freq, startTime, velocity, destination) {
            const osc = ctx.createOscillator();
            const filter = ctx.createBiquadFilter();
            const gain = ctx.createGain();
            
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, startTime);
            
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(5000, startTime);
            filter.Q.setValueAtTime(3, startTime);
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(destination);
            
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(velocity, startTime + 0.002);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
            
            filter.frequency.exponentialRampToValueAtTime(500, startTime + 0.3);
            
            osc.start(startTime);
            osc.stop(startTime + 0.6);
        }

        function playBrassNote(ctx, freq, startTime, velocity, destination) {
            const osc1 = ctx.createOscillator();
            const osc2 = ctx.createOscillator();
            
            osc1.type = 'sawtooth';
            osc2.type = 'sawtooth';
            
            osc1.frequency.setValueAtTime(freq, startTime);
            osc2.frequency.setValueAtTime(freq * 1.005, startTime);
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(800, startTime);
            filter.Q.setValueAtTime(4, startTime);
            
            const distortion = ctx.createWaveShaper();
            distortion.curve = makeDistortionCurve(30);
            
            const gain = ctx.createGain();
            
            osc1.connect(filter);
            osc2.connect(filter);
            filter.connect(distortion);
            distortion.connect(gain);
            gain.connect(destination);
            
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(velocity, startTime + 0.08);
            gain.gain.linearRampToValueAtTime(velocity * 0.9, startTime + 1.0);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.4);
            
            filter.frequency.linearRampToValueAtTime(2000, startTime + 0.1);
            filter.frequency.linearRampToValueAtTime(1200, startTime + 1.2);
            
            osc1.start(startTime);
            osc2.start(startTime);
            osc1.stop(startTime + 1.6);
            osc2.stop(startTime + 1.6);
        }

        function playLeadNote(ctx, freq, startTime, velocity, destination) {
            const osc = ctx.createOscillator();
            
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, startTime);
            
            const lfo = ctx.createOscillator();
            const lfoGain = ctx.createGain();
            lfo.frequency.setValueAtTime(6, startTime);
            lfoGain.gain.setValueAtTime(20, startTime);
            
            lfo.connect(lfoGain);
            lfoGain.connect(osc.detune);
            
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(4000, startTime);
            filter.Q.setValueAtTime(2, startTime);
            
            const gain = ctx.createGain();
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(destination);
            
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(velocity, startTime + 0.02);
            gain.gain.linearRampToValueAtTime(velocity * 0.85, startTime + 0.8);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.3);
            
            filter.frequency.linearRampToValueAtTime(6000, startTime + 0.05);
            filter.frequency.exponentialRampToValueAtTime(2000, startTime + 1.0);
            
            lfo.start(startTime);
            osc.start(startTime);
            lfo.stop(startTime + 1.5);
            osc.stop(startTime + 1.5);
        }

        // Piano Sound (Multi-oscillator with decay)
        function playPianoChord(ctx, frequencies, startTime) {
            frequencies.forEach((freq, index) => {
                // Fundamental
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const osc3 = ctx.createOscillator();
                
                // Harmonic series for piano-like timbre
                osc1.frequency.setValueAtTime(freq, startTime);
                osc2.frequency.setValueAtTime(freq * 2, startTime);     // 2nd harmonic
                osc3.frequency.setValueAtTime(freq * 3, startTime);     // 3rd harmonic
                
                osc1.type = 'sine';
                osc2.type = 'sine';
                osc3.type = 'triangle';
                
                // Filter for brightness control
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(3000, startTime);
                filter.Q.setValueAtTime(1, startTime);
                
                // Gains for harmonic balance
                const gain1 = ctx.createGain();
                const gain2 = ctx.createGain();
                const gain3 = ctx.createGain();
                const masterGain = ctx.createGain();
                
                // Routing
                osc1.connect(gain1);
                osc2.connect(gain2);
                osc3.connect(gain3);
                gain1.connect(filter);
                gain2.connect(filter);
                gain3.connect(filter);
                filter.connect(masterGain);
                masterGain.connect(ctx.destination);
                
                // Harmonic levels
                gain1.gain.setValueAtTime(0.8, startTime);   // Fundamental
                gain2.gain.setValueAtTime(0.3, startTime);   // 2nd harmonic
                gain3.gain.setValueAtTime(0.15, startTime);  // 3rd harmonic
                
                // Piano-like envelope (quick attack, medium decay)
                const velocity = 0.3 - (index * 0.05); // Lower notes slightly louder
                masterGain.gain.setValueAtTime(0, startTime);
                masterGain.gain.linearRampToValueAtTime(velocity, startTime + 0.01);
                masterGain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.2);
                
                // Filter envelope
                filter.frequency.exponentialRampToValueAtTime(800, startTime + 0.8);
                
                osc1.start(startTime);
                osc2.start(startTime);
                osc3.start(startTime);
                osc1.stop(startTime + 1.5);
                osc2.stop(startTime + 1.5);
                osc3.stop(startTime + 1.5);
            });
        }

        // Bells/Pluck Sound (Bright, metallic)
        function playBellsChord(ctx, frequencies, startTime) {
            frequencies.forEach((freq, index) => {
                // Multiple inharmonic partials for bell-like sound
                const partials = [1, 2.76, 5.4, 8.93];  // Bell-like ratios
                
                partials.forEach((ratio, pIndex) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq * ratio, startTime);
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    // Decreasing amplitude for higher partials
                    const amplitude = (0.25 / (pIndex + 1)) * (1 - index * 0.1);
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(amplitude, startTime + 0.005);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.5);
                    
                    osc.start(startTime);
                    osc.stop(startTime + 1.8);
                });
            });
        }

        // Pad Sound (Warm, sustained)
        function playPadChord(ctx, frequencies, startTime) {
            frequencies.forEach((freq, index) => {
                // Detuned oscillators for width
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const osc3 = ctx.createOscillator();
                
                osc1.type = 'sawtooth';
                osc2.type = 'sawtooth';
                osc3.type = 'triangle';
                
                osc1.frequency.setValueAtTime(freq, startTime);
                osc2.frequency.setValueAtTime(freq * 1.01, startTime);  // Slight detune
                osc3.frequency.setValueAtTime(freq * 0.99, startTime);  // Slight detune
                
                // LFO for subtle vibrato
                const lfo = ctx.createOscillator();
                const lfoGain = ctx.createGain();
                lfo.frequency.setValueAtTime(4, startTime);
                lfoGain.gain.setValueAtTime(3, startTime);
                
                lfo.connect(lfoGain);
                lfoGain.connect(osc1.frequency);
                lfoGain.connect(osc2.frequency);
                
                // Filter for warmth
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(1200, startTime);
                filter.Q.setValueAtTime(0.7, startTime);
                
                // Gains
                const gain = ctx.createGain();
                
                // Routing
                osc1.connect(filter);
                osc2.connect(filter);
                osc3.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                // Slow attack, long sustain (pad-like)
                const amplitude = 0.15 - (index * 0.02);
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(amplitude, startTime + 0.4);
                gain.gain.linearRampToValueAtTime(amplitude * 0.8, startTime + 1.2);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 2.0);
                
                // Filter modulation
                filter.frequency.linearRampToValueAtTime(1800, startTime + 0.3);
                filter.frequency.linearRampToValueAtTime(1000, startTime + 1.5);
                
                lfo.start(startTime);
                osc1.start(startTime);
                osc2.start(startTime);
                osc3.start(startTime);
                lfo.stop(startTime + 2.2);
                osc1.stop(startTime + 2.2);
                osc2.stop(startTime + 2.2);
                osc3.stop(startTime + 2.2);
            });
        }

        // Pluck Sound (Guitar/Harp-like)
        function playPluckChord(ctx, frequencies, startTime) {
            frequencies.forEach((freq, index) => {
                const osc = ctx.createOscillator();
                const filter = ctx.createBiquadFilter();
                const gain = ctx.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, startTime);
                
                // Filter for pluck character
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(5000, startTime);
                filter.Q.setValueAtTime(3, startTime);
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                // Sharp attack, fast decay (pluck envelope)
                const amplitude = 0.4 - (index * 0.08);
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(amplitude, startTime + 0.002);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
                
                // Filter sweep for pluck characteristic
                filter.frequency.exponentialRampToValueAtTime(500, startTime + 0.3);
                
                osc.start(startTime);
                osc.stop(startTime + 0.6);
            });
        }

        // Brass Sound (Bold, punchy)
        function playBrassChord(ctx, frequencies, startTime) {
            frequencies.forEach((freq, index) => {
                // Sawtooth oscillators for brass-like timbre
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                
                osc1.type = 'sawtooth';
                osc2.type = 'sawtooth';
                
                osc1.frequency.setValueAtTime(freq, startTime);
                osc2.frequency.setValueAtTime(freq * 1.005, startTime);  // Slight detune
                
                // Filter for brass character
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(800, startTime);
                filter.Q.setValueAtTime(4, startTime);
                
                // Distortion for edge
                const distortion = ctx.createWaveShaper();
                distortion.curve = makeDistortionCurve(30);
                
                const gain = ctx.createGain();
                
                // Routing
                osc1.connect(filter);
                osc2.connect(filter);
                filter.connect(distortion);
                distortion.connect(gain);
                gain.connect(ctx.destination);
                
                // Brass envelope (medium attack, sustained)
                const amplitude = 0.25 - (index * 0.04);
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(amplitude, startTime + 0.08);
                gain.gain.linearRampToValueAtTime(amplitude * 0.9, startTime + 1.0);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.4);
                
                // Filter envelope (opens up)
                filter.frequency.linearRampToValueAtTime(2000, startTime + 0.1);
                filter.frequency.linearRampToValueAtTime(1200, startTime + 1.2);
                
                osc1.start(startTime);
                osc2.start(startTime);
                osc1.stop(startTime + 1.6);
                osc2.stop(startTime + 1.6);
            });
        }

        // Lead Sound (Bright, cutting)
        function playLeadChord(ctx, frequencies, startTime) {
            frequencies.forEach((freq, index) => {
                const osc = ctx.createOscillator();
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(freq, startTime);
                
                // PWM-style modulation
                const lfo = ctx.createOscillator();
                const lfoGain = ctx.createGain();
                lfo.frequency.setValueAtTime(6, startTime);
                lfoGain.gain.setValueAtTime(20, startTime);
                
                lfo.connect(lfoGain);
                lfoGain.connect(osc.detune);
                
                // Bright filter
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(4000, startTime);
                filter.Q.setValueAtTime(2, startTime);
                
                const gain = ctx.createGain();
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                // Lead envelope (quick attack, medium sustain)
                const amplitude = 0.2 - (index * 0.03);
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(amplitude, startTime + 0.02);
                gain.gain.linearRampToValueAtTime(amplitude * 0.85, startTime + 0.8);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.3);
                
                // Filter modulation
                filter.frequency.linearRampToValueAtTime(6000, startTime + 0.05);
                filter.frequency.exponentialRampToValueAtTime(2000, startTime + 1.0);
                
                lfo.start(startTime);
                osc.start(startTime);
                lfo.stop(startTime + 1.5);
                osc.stop(startTime + 1.5);
            });
        }

        // Beat Grid Generation
        const instruments = ['808', 'Kick', 'Snare', 'Hi-Hat'];
        let beatPattern = {
            '808': [],
            'Kick': [],
            'Snare': [],
            'Hi-Hat': []
        };

        function initBeatGrid() {
            const grid = document.getElementById('beatGrid');
            grid.innerHTML = '';
            
            // Header row with step numbers
            grid.appendChild(createEmptyCell());
            for (let i = 1; i <= 16; i++) {
                const stepLabel = document.createElement('div');
                stepLabel.className = 'beat-label';
                stepLabel.textContent = i;
                stepLabel.style.textAlign = 'center';
                stepLabel.style.fontSize = '0.8em';
                grid.appendChild(stepLabel);
            }
            
            // Create grid for each instrument
            instruments.forEach(instrument => {
                const label = document.createElement('div');
                label.className = 'beat-label';
                label.textContent = instrument;
                grid.appendChild(label);
                
                for (let step = 0; step < 16; step++) {
                    const cell = document.createElement('div');
                    cell.className = 'beat-step';
                    if (step % 4 === 0) cell.classList.add('bar-marker');
                    cell.dataset.instrument = instrument;
                    cell.dataset.step = step;
                    
                    cell.onclick = () => toggleStep(instrument, step, cell);
                    grid.appendChild(cell);
                }
            });
        }

        function toggleStep(instrument, step, cell) {
            const index = beatPattern[instrument].indexOf(step);
            if (index > -1) {
                beatPattern[instrument].splice(index, 1);
                cell.classList.remove('active');
            } else {
                beatPattern[instrument].push(step);
                cell.classList.add('active');
            }
        }

        // ============================================
        // MODE SWITCHING SYSTEM
        // ============================================
        
        let currentMode = 'basic';
        
        function switchMode(mode) {
            currentMode = mode;
            const container = document.querySelector('.container');
            
            // Remove all mode classes
            container.classList.remove('mode-basic', 'mode-pro', 'mode-advanced');
            
            // Add new mode class
            container.classList.add(`mode-${mode}`);
            
            // Update mode tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.mode-tab[data-mode="${mode}"]`).classList.add('active');
            
            // Update mode badge
            const badges = {
                'basic': 'üéØ Basic Mode',
                'pro': 'üéõÔ∏è Pro Mode',
                'advanced': '‚ö° Advanced Mode'
            };
            document.getElementById('modeText').textContent = badges[mode];
            
            // Show toast notification
            const descriptions = {
                'basic': 'Essential controls only - perfect for beginners!',
                'pro': 'Common production tools - for experienced producers',
                'advanced': 'Full control & precision - for power users'
            };
            showToast(`Switched to ${badges[mode]}\n${descriptions[mode]}`, 'success');
            
            // Save mode preference
            localStorage.setItem('trap-studio-mode', mode);
        }
        
        // Load saved mode on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('trap-studio-mode') || 'basic';
            switchMode(savedMode);
        });

        // ============================================
        // KICK PATTERN VARIATIONS
        // ============================================
        
        const kickPatterns = {
            'classic': [0, 4, 8, 12],  // Four on the floor
            'hard': [0, 3, 6, 8, 11, 14],  // Hard hitting
            'rolling': [0, 2, 4, 6, 8, 10, 12, 14],  // Rolling kicks
            'double': [0, 1, 4, 5, 8, 9, 12, 13],  // Double kicks
            'triplet': [0, 1, 2, 4, 5, 6, 8, 9, 10, 12, 13, 14],  // Triplet feel
            'offbeat': [2, 6, 10, 14],  // Offbeat kicks
            'syncopated': [0, 3, 7, 10, 13],  // Syncopated
            'drill': [0, 6, 10],  // UK Drill style
            'sparse': [0, 8],  // Minimal
            'breakbeat': [0, 3, 7, 10, 12, 15]  // Breakbeat style
        };
        
        function loadKickPattern(patternName) {
            const pattern = kickPatterns[patternName];
            if (!pattern) return;
            
            // Clear current kick pattern
            beatPattern['Kick'] = [];
            document.querySelectorAll('.beat-step[data-instrument="Kick"]').forEach(cell => {
                cell.classList.remove('active');
            });
            
            // Load new pattern
            pattern.forEach(step => {
                beatPattern['Kick'].push(step);
                const cell = document.querySelector(`.beat-step[data-instrument="Kick"][data-step="${step}"]`);
                if (cell) cell.classList.add('active');
            });
            
            showToast(`Loaded ${patternName} kick pattern! ü•Å`, 'success');
        }

        // ============================================
        // HI-HAT PATTERN VARIATIONS
        // ============================================
        
        const hiHatPatterns = {
            'closed': [0, 2, 4, 6, 8, 10, 12, 14],  // Closed 8th notes
            'open': [1, 5, 9, 13],  // Open hats on offbeats
            'trap-roll': [0, 1, 2, 3, 4, 6, 8, 9, 10, 11, 12, 14],  // Trap roll
            'drill-roll': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],  // Full roll
            'double-time': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],  // 16th notes
            'half-time': [0, 4, 8, 12],  // Quarter notes
            'triplets': [0, 1, 2, 4, 5, 6, 8, 9, 10, 12, 13, 14],  // Triplet feel
            'shuffled': [0, 2, 3, 4, 7, 8, 10, 11, 12, 15],  // Shuffled
            'syncopated': [0, 3, 4, 7, 8, 11, 12, 15],  // Syncopated
            'minimal': [4, 12]  // Minimal hats
        };
        
        function loadHiHatPattern(patternName) {
            const pattern = hiHatPatterns[patternName];
            if (!pattern) return;
            
            // Clear current hi-hat pattern
            beatPattern['Hi-Hat'] = [];
            document.querySelectorAll('.beat-step[data-instrument="Hi-Hat"]').forEach(cell => {
                cell.classList.remove('active');
            });
            
            // Load new pattern
            pattern.forEach(step => {
                beatPattern['Hi-Hat'].push(step);
                const cell = document.querySelector(`.beat-step[data-instrument="Hi-Hat"][data-step="${step}"]`);
                if (cell) cell.classList.add('active');
            });
            
            showToast(`Loaded ${patternName} hi-hat pattern! üé©`, 'success');
        }

        function updateBPM(value) {
            document.getElementById('bpmValue').textContent = value;
        }

        function playBeat() {
            if (isPlaying) return;
            initAudio();
            
            isPlaying = true;
            const bpm = parseInt(document.getElementById('bpmControl').value);
            const stepDuration = (60 / bpm) / 4 * 1000; // 16th notes
            
            let currentStep = 0;
            beatInterval = setInterval(() => {
                // Highlight current step
                document.querySelectorAll('.beat-step').forEach(cell => {
                    if (parseInt(cell.dataset.step) === currentStep) {
                        cell.style.transform = 'scale(1.2)';
                        setTimeout(() => cell.style.transform = '', 100);
                    }
                });
                
                // Play sounds for active steps
                instruments.forEach(instrument => {
                    if (beatPattern[instrument].includes(currentStep)) {
                        playSound(instrument);
                    }
                });
                
                currentStep = (currentStep + 1) % 16;
            }, stepDuration);
        }

        function stopBeat() {
            isPlaying = false;
            if (beatInterval) {
                clearInterval(beatInterval);
            }
        }

        function clearPattern() {
            beatPattern = {
                '808': [],
                'Kick': [],
                'Snare': [],
                'Hi-Hat': []
            };
            document.querySelectorAll('.beat-step').forEach(cell => {
                cell.classList.remove('active');
            });
        }

        function loadPattern(presetName) {
            clearPattern();
            
            const presets = {
                classic_trap: {
                    bpm: 140,
                    '808': [0, 3, 8, 11],
                    'Kick': [0, 4, 8, 12],
                    'Snare': [4, 12],
                    'Hi-Hat': [0, 2, 4, 6, 8, 10, 12, 14]
                },
                drill: {
                    bpm: 145,
                    '808': [0, 2, 6, 11, 13],
                    'Kick': [0, 6, 10],
                    'Snare': [4, 12],
                    'Hi-Hat': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
                },
                boom_bap: {
                    bpm: 90,
                    '808': [0, 8],
                    'Kick': [0, 10],
                    'Snare': [4, 12],
                    'Hi-Hat': [2, 6, 10, 14]
                },
                phonk: {
                    bpm: 130,
                    '808': [0, 4, 8, 12],
                    'Kick': [0, 6, 8, 14],
                    'Snare': [4, 12],
                    'Hi-Hat': [0, 2, 4, 6, 8, 10, 12, 14]
                }
            };
            
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('bpmControl').value = preset.bpm;
                updateBPM(preset.bpm);
                
                beatPattern = { ...preset };
                delete beatPattern.bpm;
                
                // Update UI
                Object.keys(beatPattern).forEach(instrument => {
                    beatPattern[instrument].forEach(step => {
                        const cell = document.querySelector(
                            `.beat-step[data-instrument="${instrument}"][data-step="${step}"]`
                        );
                        if (cell) cell.classList.add('active');
                    });
                });
                
                // Highlight selected preset
                document.querySelectorAll('.preset-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');
            }
        }

        function playSound(instrument) {
            const ctx = audioContext;
            const now = ctx.currentTime;
            
            // Enhanced synthesis sounds using proper synth patching
            switch(instrument) {
                case '808':
                    play808Bass(ctx, now);
                    break;
                case 'Kick':
                    playKickDrum(ctx, now);
                    break;
                case 'Snare':
                    playSnareDrum(ctx, now);
                    break;
                case 'Hi-Hat':
                    playHiHat(ctx, now);
                    break;
            }
        }

        // 808 Sub-Bass Synthesis (Sine wave with pitch envelope and filter)
        function play808Bass(ctx, startTime) {
            const settings = bass808Settings;
            
            // VCO (Voltage Controlled Oscillator) - Sine wave for pure sub
            const vco1 = ctx.createOscillator();
            const vco2 = ctx.createOscillator();
            
            // VCF (Voltage Controlled Filter) - Low-pass for tone shaping
            const vcf = ctx.createBiquadFilter();
            vcf.type = 'lowpass';
            vcf.frequency.setValueAtTime(settings.cutoff, startTime);
            vcf.Q.setValueAtTime(settings.resonance * 10, startTime);
            
            // VCA (Voltage Controlled Amplifier) - Gain envelope
            const vca = ctx.createGain();
            
            // Distortion/Saturation
            const distortion = ctx.createWaveShaper();
            if (settings.distortion > 0) {
                distortion.curve = makeDistortionCurve(settings.distortion);
                distortion.oversample = '4x';
            }
            
            // Signal path: VCO -> VCF -> Distortion -> VCA -> Output
            vco1.connect(vcf);
            vco2.connect(vcf);
            
            if (settings.distortion > 0) {
                vcf.connect(distortion);
                distortion.connect(vca);
            } else {
                vcf.connect(vca);
            }
            vca.connect(ctx.destination);
            
            // VCO Configuration - Dual oscillators for thickness
            vco1.type = 'sine';
            vco2.type = 'sine';
            vco1.frequency.setValueAtTime(settings.freq, startTime);
            vco2.frequency.setValueAtTime(settings.freq * 0.99, startTime); // Slight detune
            
            // Pitch envelope (optional glide)
            if (settings.glide > 0) {
                const glideDuration = settings.glide / 1000;
                vco1.frequency.exponentialRampToValueAtTime(
                    settings.freq * 0.7, 
                    startTime + glideDuration
                );
                vco2.frequency.exponentialRampToValueAtTime(
                    settings.freq * 0.7 * 0.99, 
                    startTime + glideDuration
                );
            }
            
            // VCA Envelope (ADSR)
            vca.gain.setValueAtTime(0, startTime);
            vca.gain.linearRampToValueAtTime(0.9, startTime + 0.001); // Attack
            vca.gain.exponentialRampToValueAtTime(0.01, startTime + settings.decay); // Decay
            
            // Filter envelope modulation
            vcf.frequency.exponentialRampToValueAtTime(
                settings.cutoff * 0.5, 
                startTime + settings.decay * 0.7
            );
            
            vco1.start(startTime);
            vco2.start(startTime);
            vco1.stop(startTime + settings.decay + 0.1);
            vco2.stop(startTime + settings.decay + 0.1);
        }

        // Kick Drum Synthesis (Pitched sine with aggressive pitch envelope)
        function playKickDrum(ctx, startTime) {
            // Dual oscillator for punch and body
            const bodyOsc = ctx.createOscillator();
            const punchOsc = ctx.createOscillator();
            
            // Filter for tone shaping
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(200, startTime);
            filter.Q.setValueAtTime(1, startTime);
            
            // Gain envelopes
            const bodyGain = ctx.createGain();
            const punchGain = ctx.createGain();
            const masterGain = ctx.createGain();
            
            // Signal path
            bodyOsc.connect(bodyGain);
            punchOsc.connect(punchGain);
            bodyGain.connect(filter);
            punchGain.connect(filter);
            filter.connect(masterGain);
            masterGain.connect(ctx.destination);
            
            // Body oscillator (low sine wave with pitch envelope)
            bodyOsc.type = 'sine';
            bodyOsc.frequency.setValueAtTime(120, startTime);
            bodyOsc.frequency.exponentialRampToValueAtTime(50, startTime + 0.05);
            bodyOsc.frequency.exponentialRampToValueAtTime(40, startTime + 0.1);
            
            // Punch oscillator (higher frequency for attack)
            punchOsc.type = 'sine';
            punchOsc.frequency.setValueAtTime(200, startTime);
            punchOsc.frequency.exponentialRampToValueAtTime(60, startTime + 0.02);
            
            // Body envelope (longer)
            bodyGain.gain.setValueAtTime(0.8, startTime);
            bodyGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);
            
            // Punch envelope (short attack)
            punchGain.gain.setValueAtTime(1, startTime);
            punchGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.04);
            
            // Master gain
            masterGain.gain.setValueAtTime(1, startTime);
            masterGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);
            
            // Filter envelope
            filter.frequency.exponentialRampToValueAtTime(60, startTime + 0.08);
            
            bodyOsc.start(startTime);
            punchOsc.start(startTime);
            bodyOsc.stop(startTime + 0.2);
            punchOsc.stop(startTime + 0.2);
        }

        // Snare Drum Synthesis (Triangle + Noise)
        function playSnareDrum(ctx, startTime) {
            // Tonal component (triangle wave)
            const toneOsc = ctx.createOscillator();
            toneOsc.type = 'triangle';
            toneOsc.frequency.setValueAtTime(200, startTime);
            toneOsc.frequency.exponentialRampToValueAtTime(100, startTime + 0.05);
            
            // Noise component (white noise for snare crack)
            const noiseBuffer = createNoiseBuffer(ctx, 0.1);
            const noise = ctx.createBufferSource();
            noise.buffer = noiseBuffer;
            
            // Filters
            const toneFilter = ctx.createBiquadFilter();
            toneFilter.type = 'highpass';
            toneFilter.frequency.setValueAtTime(200, startTime);
            
            const noiseFilter = ctx.createBiquadFilter();
            noiseFilter.type = 'bandpass';
            noiseFilter.frequency.setValueAtTime(3000, startTime);
            noiseFilter.Q.setValueAtTime(2, startTime);
            
            // Gains
            const toneGain = ctx.createGain();
            const noiseGain = ctx.createGain();
            const masterGain = ctx.createGain();
            
            // Signal path
            toneOsc.connect(toneFilter);
            toneFilter.connect(toneGain);
            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            toneGain.connect(masterGain);
            noiseGain.connect(masterGain);
            masterGain.connect(ctx.destination);
            
            // Tone envelope
            toneGain.gain.setValueAtTime(0.3, startTime);
            toneGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1);
            
            // Noise envelope (shorter for snap)
            noiseGain.gain.setValueAtTime(0.7, startTime);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.08);
            
            // Master envelope
            masterGain.gain.setValueAtTime(0.6, startTime);
            masterGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.12);
            
            toneOsc.start(startTime);
            noise.start(startTime);
            toneOsc.stop(startTime + 0.15);
            noise.stop(startTime + 0.15);
        }

        // Hi-Hat Synthesis (Multiple square waves + noise)
        function playHiHat(ctx, startTime) {
            // Create multiple square wave oscillators for metallic sound
            const osc1 = ctx.createOscillator();
            const osc2 = ctx.createOscillator();
            const osc3 = ctx.createOscillator();
            const osc4 = ctx.createOscillator();
            
            osc1.type = 'square';
            osc2.type = 'square';
            osc3.type = 'square';
            osc4.type = 'square';
            
            // Inharmonic frequencies for metallic timbre
            osc1.frequency.setValueAtTime(317, startTime);  // Close to E
            osc2.frequency.setValueAtTime(421, startTime);  // Close to G#
            osc3.frequency.setValueAtTime(543, startTime);  // Close to C#
            osc4.frequency.setValueAtTime(789, startTime);  // Close to G
            
            // Noise for shimmer
            const noiseBuffer = createNoiseBuffer(ctx, 0.05);
            const noise = ctx.createBufferSource();
            noise.buffer = noiseBuffer;
            
            // High-pass filter for brightness
            const filter = ctx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.setValueAtTime(7000, startTime);
            filter.Q.setValueAtTime(1, startTime);
            
            // Bandpass for noise
            const noiseFilter = ctx.createBiquadFilter();
            noiseFilter.type = 'bandpass';
            noiseFilter.frequency.setValueAtTime(10000, startTime);
            noiseFilter.Q.setValueAtTime(0.5, startTime);
            
            // Gains
            const oscGain = ctx.createGain();
            const noiseGain = ctx.createGain();
            const masterGain = ctx.createGain();
            
            // Signal path
            osc1.connect(oscGain);
            osc2.connect(oscGain);
            osc3.connect(oscGain);
            osc4.connect(oscGain);
            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            oscGain.connect(filter);
            filter.connect(masterGain);
            noiseGain.connect(masterGain);
            masterGain.connect(ctx.destination);
            
            // Oscillator envelope (very short)
            oscGain.gain.setValueAtTime(0.1, startTime);
            oscGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.03);
            
            // Noise envelope
            noiseGain.gain.setValueAtTime(0.25, startTime);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.04);
            
            // Master envelope
            masterGain.gain.setValueAtTime(0.4, startTime);
            masterGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.05);
            
            osc1.start(startTime);
            osc2.start(startTime);
            osc3.start(startTime);
            osc4.start(startTime);
            noise.start(startTime);
            
            osc1.stop(startTime + 0.06);
            osc2.stop(startTime + 0.06);
            osc3.stop(startTime + 0.06);
            osc4.stop(startTime + 0.06);
            noise.stop(startTime + 0.06);
        }

        // Utility: Create noise buffer for drum synthesis
        function createNoiseBuffer(ctx, duration) {
            const bufferSize = ctx.sampleRate * duration;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            return buffer;
        }

        // Utility: Create distortion curve for 808 saturation
        function makeDistortionCurve(amount) {
            const k = amount;
            const samples = 44100;
            const curve = new Float32Array(samples);
            const deg = Math.PI / 180;
            
            for (let i = 0; i < samples; i++) {
                const x = (i * 2) / samples - 1;
                curve[i] = ((3 + k) * x * 20 * deg) / (Math.PI + k * Math.abs(x));
            }
            
            return curve;
        }

        // ============================================
        // CLEAN SOUND ENGINE UTILITIES
        // Anti-aliasing and improved synthesis
        // ============================================
        
        /**
         * Create bandlimited oscillator with reduced aliasing
         * Uses additive synthesis to avoid high-frequency artifacts
         */
        function createCleanOscillator(ctx, freq, waveform, maxPartials = 32) {
            const nyquist = ctx.sampleRate / 2;
            const fundamental = freq;
            
            // Calculate how many harmonics we can safely add without aliasing
            const safePartials = Math.min(maxPartials, Math.floor(nyquist / fundamental) - 1);
            
            // Create oscillator nodes for each partial
            const oscillators = [];
            const gains = [];
            const merger = ctx.createGain();
            
            for (let n = 1; n <= safePartials; n++) {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = 'sine'; // All partials are sine waves
                osc.frequency.value = fundamental * n;
                
                // Calculate amplitude based on waveform type
                let amplitude = 0;
                switch(waveform) {
                    case 'sawtooth':
                        amplitude = 1 / n; // Harmonics decrease linearly
                        break;
                    case 'square':
                        amplitude = (n % 2 === 1) ? (1 / n) : 0; // Odd harmonics only
                        break;
                    case 'triangle':
                        amplitude = (n % 2 === 1) ? (1 / (n * n)) : 0; // Odd harmonics, squared decrease
                        break;
                    case 'sine':
                        amplitude = (n === 1) ? 1 : 0; // Fundamental only
                        break;
                }
                
                gain.gain.value = amplitude / safePartials;
                
                osc.connect(gain);
                gain.connect(merger);
                
                oscillators.push(osc);
                gains.push(gain);
            }
            
            return { oscillators, gains, output: merger };
        }
        
        /**
         * Create improved biquad filter with smoother response
         * Uses cascaded filters for steeper rolloff
         */
        function createCleanFilter(ctx, type, cutoff, resonance, stages = 2) {
            const filters = [];
            let input = null;
            
            for (let i = 0; i < stages; i++) {
                const filter = ctx.createBiquadFilter();
                filter.type = type;
                filter.frequency.value = cutoff;
                // Distribute resonance across stages to avoid instability
                filter.Q.value = Math.pow(resonance, 1 / stages);
                
                if (input) {
                    input.connect(filter);
                }
                
                filters.push(filter);
                input = filter;
            }
            
            return {
                input: filters[0],
                output: filters[filters.length - 1],
                filters: filters,
                setFrequency: (freq) => filters.forEach(f => f.frequency.value = freq),
                setQ: (q) => filters.forEach((f, i) => f.Q.value = Math.pow(q, 1 / stages))
            };
        }
        
        /**
         * Soft clipping function for warmer saturation
         * Uses hyperbolic tangent for smooth saturation
         */
        function createSoftClipper(ctx, drive = 1.0) {
            const samples = 2048;
            const curve = new Float32Array(samples);
            
            for (let i = 0; i < samples; i++) {
                const x = (i * 2 / samples) - 1;
                const processed = Math.tanh(x * drive);
                curve[i] = processed / Math.max(Math.abs(processed), 1.0);
            }
            
            const shaper = ctx.createWaveShaper();
            shaper.curve = curve;
            shaper.oversample = '4x'; // Enable oversampling to reduce aliasing
            
            return shaper;
        }
        
        /**
         * Create improved reverb with early reflections
         */
        function createCleanReverb(ctx, size = 0.5, damping = 0.5) {
            const convolver = ctx.createConvolver();
            const reverbTime = 2 * size;
            const sampleRate = ctx.sampleRate;
            const length = sampleRate * reverbTime;
            const impulse = ctx.createBuffer(2, length, sampleRate);
            
            const leftChannel = impulse.getChannelData(0);
            const rightChannel = impulse.getChannelData(1);
            
            // Generate impulse with early reflections
            for (let i = 0; i < length; i++) {
                const decay = Math.exp(-3 * i / length);
                const noise = (Math.random() * 2 - 1);
                
                // Apply damping to high frequencies
                const dampedNoise = noise * (1 - damping * (i / length));
                
                leftChannel[i] = dampedNoise * decay;
                rightChannel[i] = dampedNoise * decay * 0.9; // Slight stereo difference
            }
            
            // Add early reflections (first 50ms)
            const earlyReflections = Math.floor(sampleRate * 0.05);
            const reflectionTimes = [7, 11, 13, 17, 19, 23, 29, 31];
            
            reflectionTimes.forEach(time => {
                const sample = Math.floor(sampleRate * time / 1000);
                if (sample < earlyReflections) {
                    leftChannel[sample] += 0.3 * (Math.random() * 2 - 1);
                    rightChannel[sample] += 0.3 * (Math.random() * 2 - 1);
                }
            });
            
            convolver.buffer = impulse;
            return convolver;
        }
        
        /**
         * Stereo widener using Haas effect
         */
        function createStereoWidener(ctx, width = 0.5) {
            const splitter = ctx.createChannelSplitter(2);
            const merger = ctx.createChannelMerger(2);
            const delay = ctx.createDelay();
            const delayGain = ctx.createGain();
            
            // Small delay for Haas effect (5-35ms)
            delay.delayTime.value = 0.015 * width;
            delayGain.gain.value = 0.7;
            
            splitter.connect(delay, 0);
            delay.connect(delayGain);
            delayGain.connect(merger, 0, 1); // Cross delay to opposite channel
            splitter.connect(merger, 0, 0);
            splitter.connect(merger, 1, 1);
            
            return { input: splitter, output: merger };
        }

        // 808 Bass Designer
        let bass808Settings = {
            freq: 55,
            decay: 0.8,
            cutoff: 180,
            resonance: 0.4,
            distortion: 0,
            glide: 0
        };

        function update808Param(param, value) {
            bass808Settings[param] = parseFloat(value);
            document.getElementById(`${param}808Value`).textContent = value;
            draw808Waveform();
        }

        function draw808Waveform() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const width = canvas.width;
            const height = canvas.height;
            const centerY = height / 2;
            
            ctx.fillStyle = getComputedStyle(document.documentElement)
                .getPropertyValue('--bg-tertiary');
            ctx.fillRect(0, 0, width, height);
            
            // Draw waveform
            ctx.beginPath();
            ctx.strokeStyle = getComputedStyle(document.documentElement)
                .getPropertyValue('--accent-primary');
            ctx.lineWidth = 2;
            
            const decayFactor = bass808Settings.decay;
            const cycles = bass808Settings.freq / 20; // Approximate visual cycles
            
            for (let x = 0; x < width; x++) {
                const t = x / width;
                const decay = Math.exp(-t * 5 / decayFactor);
                const wave = Math.sin(t * Math.PI * 2 * cycles) * decay;
                const y = centerY + wave * (height / 2) * 0.8;
                
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Draw grid
            ctx.strokeStyle = getComputedStyle(document.documentElement)
                .getPropertyValue('--border');
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
        }

        function play808Preview() {
            initAudio();
            // Use the enhanced 808 synthesis engine
            play808Bass(audioContext, audioContext.currentTime);
        }

        function randomize808() {
            bass808Settings = {
                freq: Math.floor(Math.random() * 40) + 40,
                decay: (Math.random() * 1.5 + 0.3).toFixed(1),
                cutoff: Math.floor(Math.random() * 300) + 100,
                resonance: (Math.random() * 0.8).toFixed(1),
                distortion: Math.floor(Math.random() * 50),
                glide: Math.floor(Math.random() * 150)
            };
            
            // Update UI
            document.getElementById('bass808Freq').value = bass808Settings.freq;
            document.getElementById('bass808Decay').value = bass808Settings.decay;
            document.getElementById('bass808Cutoff').value = bass808Settings.cutoff;
            document.getElementById('bass808Resonance').value = bass808Settings.resonance;
            document.getElementById('bass808Distortion').value = bass808Settings.distortion;
            document.getElementById('bass808Glide').value = bass808Settings.glide;
            
            Object.keys(bass808Settings).forEach(param => {
                document.getElementById(`${param}808Value`).textContent = bass808Settings[param];
            });
            
            draw808Waveform();
        }

        function export808Settings() {
            const settings = `# 808 Bass Settings\n\n` +
                `Frequency: ${bass808Settings.freq} Hz\n` +
                `Decay: ${bass808Settings.decay}s\n` +
                `Filter Cutoff: ${bass808Settings.cutoff} Hz\n` +
                `Resonance: ${bass808Settings.resonance}\n` +
                `Distortion: ${bass808Settings.distortion}%\n` +
                `Pitch Glide: ${bass808Settings.glide}ms\n\n` +
                `# Synth2600 CLI Command:\n` +
                `python3 synth2600_cli.py preset --load 808_custom\n` +
                `python3 synth2600_cli.py params set "vco1.frequency=${bass808Settings.freq}"\n` +
                `python3 synth2600_cli.py params set "env.decay=${bass808Settings.decay}"\n` +
                `python3 synth2600_cli.py params set "vcf.cutoff=${bass808Settings.cutoff}"\n` +
                `python3 synth2600_cli.py params set "vcf.resonance=${bass808Settings.resonance}"\n`;
            
            document.getElementById('bass808Code').textContent = settings;
            document.getElementById('bass808Output').style.display = 'block';
            
            // Download as file
            const blob = new Blob([settings], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '808_bass_settings.txt';
            a.click();
        }

        // Toggle synthesis architecture info
        function toggleSynthInfo() {
            const info = document.getElementById('synthInfo');
            if (info.style.display === 'none') {
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        }

        // ============================================
        // DAW-STYLE ARRANGEMENT TIMELINE
        // ============================================
        
        let arrangementData = {
            kick: [],
            snare: [],
            hihat: [],
            '808': [],
            melody: [],
            fx: []
        };
        let arrangementLength = 8; // in bars
        let isPlayingArrangement = false;
        let arrangementPlaybackTimeout = null;
        
        /**
         * Initialize arrangement timeline
         */
        function initArrangementTimeline() {
            updateTimelineMarkers();
            setupDragAndDrop();
        }
        
        /**
         * Update timeline bar markers
         */
        function updateTimelineMarkers() {
            const markers = document.getElementById('timelineMarkers');
            if (!markers) return;
            
            markers.innerHTML = '';
            for (let i = 1; i <= arrangementLength; i++) {
                const marker = document.createElement('div');
                marker.style.cssText = `
                    flex: 1;
                    text-align: center;
                    color: var(--text-secondary);
                    font-size: 0.8em;
                    border-left: 1px solid var(--border);
                    padding: 5px 0;
                `;
                marker.textContent = `Bar ${i}`;
                markers.appendChild(marker);
            }
        }
        
        /**
         * Update arrangement length
         */
        function updateArrangementLength(bars) {
            arrangementLength = parseInt(bars);
            document.getElementById('arrangementBars').textContent = bars;
            updateTimelineMarkers();
            
            // Adjust track content widths
            document.querySelectorAll('.track-content').forEach(track => {
                // Remove blocks that are beyond new length
                const blocks = track.querySelectorAll('.arrangement-block');
                blocks.forEach(block => {
                    const blockStart = parseFloat(block.dataset.startBar);
                    if (blockStart >= arrangementLength) {
                        block.remove();
                    }
                });
            });
        }
        
        /**
         * Setup drag and drop for pattern blocks
         */
        function setupDragAndDrop() {
            // Make pattern library items draggable
            document.querySelectorAll('.pattern-block').forEach(block => {
                block.addEventListener('dragstart', handleDragStart);
                block.addEventListener('dragend', handleDragEnd);
            });
            
            // Make track content areas droppable
            document.querySelectorAll('.track-content').forEach(track => {
                track.addEventListener('dragover', handleDragOver);
                track.addEventListener('dragleave', handleDragLeave);
                track.addEventListener('drop', handleDrop);
            });
        }
        
        let draggedPattern = null;
        
        function handleDragStart(e) {
            draggedPattern = {
                type: this.dataset.type,
                pattern: this.dataset.pattern,
                name: this.querySelector('.pattern-name').textContent
            };
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'copy';
        }
        
        function handleDragEnd(e) {
            this.style.opacity = '1';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            this.classList.add('drag-over');
            return false;
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
            
            if (!draggedPattern) return;
            
            // Calculate drop position (which bar)
            const trackRect = this.getBoundingClientRect();
            const dropX = e.clientX - trackRect.left;
            const barWidth = trackRect.width / arrangementLength;
            const barPosition = Math.floor(dropX / barWidth);
            
            // Check if pattern type matches track type
            const trackType = this.dataset.trackType;
            if (draggedPattern.type !== trackType && trackType !== '808') {
                // Allow flexibility - user can place different patterns
                // console.log('Pattern type mismatch, but allowing for creative freedom');
            }
            
            // Create arrangement block
            createArrangementBlock(this, draggedPattern, barPosition);
            
            return false;
        }
        
        /**
         * Create an arrangement block on the timeline
         */
        function createArrangementBlock(trackContent, pattern, barPosition) {
            // Prevent overlapping - check if block exists at this position
            const existingBlocks = trackContent.querySelectorAll('.arrangement-block');
            for (let block of existingBlocks) {
                const existingBar = parseInt(block.dataset.startBar);
                const existingLength = parseInt(block.dataset.length);
                if (barPosition >= existingBar && barPosition < existingBar + existingLength) {
                    console.log('Block already exists at this position');
                    return;
                }
            }
            
            const block = document.createElement('div');
            block.className = `arrangement-block ${pattern.type}`;
            block.dataset.type = pattern.type;
            block.dataset.pattern = pattern.pattern;
            block.dataset.startBar = barPosition;
            block.dataset.length = 1; // 1 bar length by default
            
            // Position the block
            const barWidth = 100 / arrangementLength;
            block.style.left = `${barPosition * barWidth}%`;
            block.style.width = `${barWidth}%`;
            
            // Block content
            const icon = getPatternIcon(pattern.type);
            block.innerHTML = `
                <div class="arrangement-block-icon">${icon}</div>
                <div class="arrangement-block-name">${pattern.name}</div>
            `;
            
            // Add click to delete
            block.addEventListener('click', function(e) {
                if (e.shiftKey) {
                    // Shift-click to delete
                    this.remove();
                }
            });
            
            // Add double-click to edit/extend
            block.addEventListener('dblclick', function(e) {
                const currentLength = parseInt(this.dataset.length);
                const newLength = (currentLength % 4) + 1; // Cycle through 1, 2, 3, 4 bars
                this.dataset.length = newLength;
                this.style.width = `${barWidth * newLength}%`;
            });
            
            trackContent.appendChild(block);
            
            // Store in arrangement data
            const trackType = trackContent.dataset.trackType;
            if (!arrangementData[trackType]) {
                arrangementData[trackType] = [];
            }
            arrangementData[trackType].push({
                pattern: pattern.pattern,
                startBar: barPosition,
                length: 1
            });
        }
        
        /**
         * Get icon for pattern type
         */
        function getPatternIcon(type) {
            const icons = {
                'kick': 'ü•Å',
                'snare': 'üëè',
                'hihat': 'üé©',
                '808': 'üîä',
                'melody': 'üéπ',
                'fx': '‚ö°'
            };
            return icons[type] || 'üéµ';
        }
        
        /**
         * Play full arrangement
         */
        async function playArrangement() {
            if (isPlayingArrangement) {
                stopArrangement();
                return;
            }
            
            // Check if there are any blocks
            const allTracks = document.querySelectorAll('.track-content');
            let hasBlocks = false;
            allTracks.forEach(track => {
                if (track.querySelectorAll('.arrangement-block').length > 0) {
                    hasBlocks = true;
                }
            });
            
            if (!hasBlocks) {
                alert('‚ö†Ô∏è Add some pattern blocks to the timeline first!\n\nDrag patterns from the library onto the tracks.');
                return;
            }
            
            isPlayingArrangement = true;
            document.getElementById('playArrangementBtn').innerHTML = '‚è∏Ô∏è Pause';
            
            // Initialize audio context
            if (!audioContext) {
                initAudio();
            }
            
            // Calculate BPM and timing
            const bpm = parseInt(document.getElementById('bpmControl').value);
            const beatsPerBar = 4;
            const barDuration = (60 / bpm) * beatsPerBar; // in seconds
            
            // Play each bar sequentially
            let currentBar = 0;
            const playNextBar = () => {
                if (!isPlayingArrangement || currentBar >= arrangementLength) {
                    stopArrangement();
                    return;
                }
                
                // Highlight current bar
                updatePlayheadPosition(currentBar);
                
                // Trigger all patterns at this bar position
                allTracks.forEach(track => {
                    const blocks = track.querySelectorAll('.arrangement-block');
                    blocks.forEach(block => {
                        const startBar = parseInt(block.dataset.startBar);
                        const length = parseInt(block.dataset.length);
                        const endBar = startBar + length;
                        
                        if (currentBar >= startBar && currentBar < endBar) {
                            // This block should play
                            const pattern = block.dataset.pattern;
                            const type = block.dataset.type;
                            playPatternOnTimeline(type, pattern, audioContext.currentTime);
                        }
                    });
                });
                
                currentBar++;
                arrangementPlaybackTimeout = setTimeout(playNextBar, barDuration * 1000);
            };
            
            playNextBar();
        }
        
        /**
         * Stop arrangement playback
         */
        function stopArrangement() {
            isPlayingArrangement = false;
            document.getElementById('playArrangementBtn').innerHTML = '‚ñ∂Ô∏è Play Full Track';
            if (arrangementPlaybackTimeout) {
                clearTimeout(arrangementPlaybackTimeout);
                arrangementPlaybackTimeout = null;
            }
            removePlayheadHighlight();
        }
        
        /**
         * Update playhead position visual indicator
         */
        function updatePlayheadPosition(barIndex) {
            // Add visual feedback for current bar playback
            document.querySelectorAll('.track-content').forEach(track => {
                const barWidth = 100 / arrangementLength;
                // Could add a playhead line here
            });
        }
        
        /**
         * Remove playhead highlight
         */
        function removePlayheadHighlight() {
            // Clean up playhead visual
        }
        
        /**
         * Play a specific pattern on the timeline
         */
        function playPatternOnTimeline(type, patternName, startTime) {
            if (!audioContext) return;
            
            // Play appropriate sound based on type and pattern
            switch(type) {
                case 'kick':
                    playKickDrum(audioContext, startTime);
                    break;
                case 'snare':
                    playSnareDrum(audioContext, startTime);
                    break;
                case 'hihat':
                    playHiHat(audioContext, startTime);
                    break;
                case '808':
                    play808Bass(audioContext, startTime);
                    break;
                case 'melody':
                    // Play chord progression or melody
                    if (generatedChords.length > 0) {
                        playChordAtTime(generatedChords[0], startTime);
                    }
                    break;
                case 'fx':
                    // Play FX sound (could be hi-hat roll or cymbal)
                    playHiHat(audioContext, startTime);
                    setTimeout(() => playHiHat(audioContext, audioContext.currentTime), 50);
                    break;
            }
        }
        
        /**
         * Clear all arrangement blocks
         */
        function clearArrangement() {
            if (!confirm('Clear entire arrangement? This cannot be undone.')) {
                return;
            }
            
            document.querySelectorAll('.track-content').forEach(track => {
                track.innerHTML = '';
            });
            
            arrangementData = {
                kick: [],
                snare: [],
                hihat: [],
                '808': [],
                melody: [],
                fx: []
            };
        }
        
        /**
         * Load arrangement template
         */
        function loadArrangementTemplate(templateName) {
            clearArrangement();
            
            const templates = {
                'intro-verse-chorus': {
                    kick: [{pattern: 'classic', startBar: 0, length: 2}, {pattern: 'hard', startBar: 2, length: 4}, {pattern: 'drill', startBar: 6, length: 2}],
                    hihat: [{pattern: 'closed', startBar: 0, length: 2}, {pattern: 'trap-roll', startBar: 2, length: 4}, {pattern: 'double-time', startBar: 6, length: 2}],
                    snare: [{pattern: 'classic', startBar: 2, length: 4}, {pattern: 'roll', startBar: 6, length: 2}],
                    '808': [{pattern: 'rolling', startBar: 2, length: 6}]
                },
                'trap-buildup': {
                    kick: [{pattern: 'sparse', startBar: 0, length: 4}, {pattern: 'hard', startBar: 4, length: 4}],
                    hihat: [{pattern: 'closed', startBar: 0, length: 4}, {pattern: 'trap-roll', startBar: 4, length: 4}],
                    fx: [{pattern: 'riser', startBar: 3, length: 1}]
                },
                'drill-structure': {
                    kick: [{pattern: 'drill', startBar: 0, length: 8}],
                    hihat: [{pattern: 'drill-roll', startBar: 0, length: 8}],
                    snare: [{pattern: 'roll', startBar: 2, length: 6}],
                    '808': [{pattern: 'rolling', startBar: 0, length: 8}]
                },
                'minimal-loop': {
                    kick: [{pattern: 'classic', startBar: 0, length: 4}],
                    hihat: [{pattern: 'minimal', startBar: 0, length: 4}],
                    '808': [{pattern: 'melodic', startBar: 0, length: 4}]
                }
            };
            
            const template = templates[templateName];
            if (!template) return;
            
            // Create blocks for each track
            Object.keys(template).forEach(trackType => {
                const trackContent = document.querySelector(`.track-content[data-track-type="${trackType}"]`);
                if (!trackContent) return;
                
                template[trackType].forEach(item => {
                    const pattern = {
                        type: trackType,
                        pattern: item.pattern,
                        name: item.pattern.charAt(0).toUpperCase() + item.pattern.slice(1)
                    };
                    
                    const block = document.createElement('div');
                    block.className = `arrangement-block ${trackType}`;
                    block.dataset.type = trackType;
                    block.dataset.pattern = item.pattern;
                    block.dataset.startBar = item.startBar;
                    block.dataset.length = item.length;
                    
                    const barWidth = 100 / arrangementLength;
                    block.style.left = `${item.startBar * barWidth}%`;
                    block.style.width = `${item.length * barWidth}%`;
                    
                    const icon = getPatternIcon(trackType);
                    block.innerHTML = `
                        <div class="arrangement-block-icon">${icon}</div>
                        <div class="arrangement-block-name">${pattern.name}</div>
                    `;
                    
                    block.addEventListener('click', function(e) {
                        if (e.shiftKey) this.remove();
                    });
                    
                    block.addEventListener('dblclick', function(e) {
                        const currentLength = parseInt(this.dataset.length);
                        const newLength = (currentLength % 4) + 1;
                        this.dataset.length = newLength;
                        this.style.width = `${barWidth * newLength}%`;
                    });
                    
                    trackContent.appendChild(block);
                });
            });
            
            console.log(`Loaded template: ${templateName}`);
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            setTimeout(initArrangementTimeline, 500);
        });

        // ============================================
        // INTELLIGENT BEAT GENERATOR - EXPERT MODE
        // ============================================
        
        /**
         * Generate an intelligent beat based on style, complexity, and instruments
         */
        function generateIntelligentBeat() {
            const genre = document.getElementById('genreStyle').value;
            const complexity = document.getElementById('complexityLevel').value;
            const energy = parseInt(document.getElementById('energyLevel').value);
            
            // Get active instruments
            const instruments = {
                kick: document.getElementById('inst_kick').checked,
                snare: document.getElementById('inst_snare').checked,
                hihat: document.getElementById('inst_hihat').checked,
                bass808: document.getElementById('inst_808').checked,
                perc: document.getElementById('inst_perc').checked,
                melody: document.getElementById('inst_melody').checked
            };
            
            console.log(`Generating ${genre} beat | Complexity: ${complexity} | Energy: ${energy}`);
            
            // Clear current pattern
            clearPattern();
            
            // Generate BPM based on genre and energy
            const bpm = calculateBPMForGenre(genre, energy);
            document.getElementById('bpmControl').value = bpm;
            updateBPM(bpm);
            
            // Generate patterns for each active instrument
            if (instruments.kick) {
                const kickPattern = selectKickPattern(genre, complexity, energy);
                loadKickPattern(kickPattern);
            }
            
            if (instruments.hihat) {
                const hihatPattern = selectHiHatPattern(genre, complexity, energy);
                loadHiHatPattern(hihatPattern);
            }
            
            if (instruments.snare) {
                generateSnarePattern(genre, complexity, energy);
            }
            
            if (instruments.bass808) {
                generate808Pattern(genre, energy);
            }
            
            // Play preview
            setTimeout(() => {
                playBeat();
            }, 300);
            
            // Show notification
            showBeatGenerationNotification(genre, complexity);
        }
        
        /**
         * Calculate BPM for genre
         */
        function calculateBPMForGenre(genre, energy) {
            const bpmRanges = {
                'trap': { min: 130, max: 150 },
                'drill': { min: 140, max: 165 },
                'boom-bap': { min: 80, max: 95 },
                'lo-fi': { min: 70, max: 90 },
                'hyperpop': { min: 150, max: 180 },
                'phonk': { min: 120, max: 145 },
                'jersey-club': { min: 130, max: 145 }
            };
            
            const range = bpmRanges[genre] || { min: 120, max: 140 };
            const bpm = Math.round(range.min + (range.max - range.min) * (energy / 10));
            return bpm;
        }
        
        /**
         * Select kick pattern based on parameters
         */
        function selectKickPattern(genre, complexity, energy) {
            const patterns = {
                'trap': {
                    minimal: 'sparse',
                    simple: 'classic',
                    moderate: 'hard',
                    complex: 'rolling',
                    chaotic: 'double'
                },
                'drill': {
                    minimal: 'classic',
                    simple: 'drill',
                    moderate: 'hard',
                    complex: 'drill',
                    chaotic: 'rolling'
                },
                'boom-bap': {
                    minimal: 'classic',
                    simple: 'classic',
                    moderate: 'offbeat',
                    complex: 'syncopated',
                    chaotic: 'breakbeat'
                },
                'lo-fi': {
                    minimal: 'sparse',
                    simple: 'classic',
                    moderate: 'offbeat',
                    complex: 'syncopated',
                    chaotic: 'rolling'
                },
                'hyperpop': {
                    minimal: 'double',
                    simple: 'hard',
                    moderate: 'triplet',
                    complex: 'rolling',
                    chaotic: 'breakbeat'
                },
                'phonk': {
                    minimal: 'classic',
                    simple: 'rolling',
                    moderate: 'hard',
                    complex: 'drill',
                    chaotic: 'breakbeat'
                },
                'jersey-club': {
                    minimal: 'classic',
                    simple: 'double',
                    moderate: 'triplet',
                    complex: 'rolling',
                    chaotic: 'breakbeat'
                }
            };
            
            return patterns[genre]?.[complexity] || 'classic';
        }
        
        /**
         * Select hi-hat pattern based on parameters
         */
        function selectHiHatPattern(genre, complexity, energy) {
            const patterns = {
                'trap': {
                    minimal: 'closed',
                    simple: 'closed',
                    moderate: 'trap-roll',
                    complex: 'double-time',
                    chaotic: 'drill-roll'
                },
                'drill': {
                    minimal: 'closed',
                    simple: 'drill-roll',
                    moderate: 'drill-roll',
                    complex: 'double-time',
                    chaotic: 'trap-roll'
                },
                'boom-bap': {
                    minimal: 'minimal',
                    simple: 'closed',
                    moderate: 'half-time',
                    complex: 'shuffled',
                    chaotic: 'syncopated'
                },
                'lo-fi': {
                    minimal: 'minimal',
                    simple: 'half-time',
                    moderate: 'shuffled',
                    complex: 'syncopated',
                    chaotic: 'triplets'
                },
                'hyperpop': {
                    minimal: 'closed',
                    simple: 'double-time',
                    moderate: 'trap-roll',
                    complex: 'drill-roll',
                    chaotic: 'double-time'
                },
                'phonk': {
                    minimal: 'closed',
                    simple: 'shuffled',
                    moderate: 'syncopated',
                    complex: 'trap-roll',
                    chaotic: 'drill-roll'
                },
                'jersey-club': {
                    minimal: 'closed',
                    simple: 'double-time',
                    moderate: 'triplets',
                    complex: 'trap-roll',
                    chaotic: 'drill-roll'
                }
            };
            
            return patterns[genre]?.[complexity] || 'closed';
        }
        
        /**
         * Generate snare pattern
         */
        function generateSnarePattern(genre, complexity, energy) {
            // Snare typically hits on beats 2 and 4
            const basePattern = [4, 12]; // Steps 5 and 13 (beats 2 and 4)
            
            if (complexity === 'complex' || complexity === 'chaotic') {
                // Add extra snare hits
                basePattern.push(7, 15);
            }
            
            if (complexity === 'chaotic' && energy > 7) {
                // Add even more snare rolls
                basePattern.push(3, 11);
            }
            
            beatPattern['Snare'] = basePattern;
            updateBeatGrid();
        }
        
        /**
         * Generate 808 bass pattern
         */
        function generate808Pattern(genre, energy) {
            // 808 follows kick pattern but with some variation
            const basePattern = [0, 8]; // On beat
            
            if (energy > 5) {
                basePattern.push(4, 12);
            }
            
            if (energy > 7) {
                basePattern.push(6, 14);
            }
            
            beatPattern['808'] = basePattern;
            updateBeatGrid();
        }
        
        /**
         * Update beat grid visual after pattern changes
         */
        function updateBeatGrid() {
            instruments.forEach(instrument => {
                for (let step = 0; step < 16; step++) {
                    const cell = document.querySelector(`[data-instrument="${instrument}"][data-step="${step}"]`);
                    if (cell) {
                        if (beatPattern[instrument].includes(step)) {
                            cell.classList.add('active');
                        } else {
                            cell.classList.remove('active');
                        }
                    }
                }
            });
        }
        
        /**
         * Show beat generation notification
         */
        function showBeatGenerationNotification(genre, complexity) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 20px 30px;
                background: linear-gradient(135deg, var(--accent-gold), #ffd700);
                color: #000;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
                z-index: 10000;
                font-weight: bold;
                animation: slideInRight 0.3s ease-out;
            `;
            notif.innerHTML = `üß† Generated ${genre.toUpperCase()} beat<br><small style="opacity:0.8">${complexity} complexity</small>`;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => document.body.removeChild(notif), 300);
            }, 3000);
        }
        
        /**
         * Load pattern combination presets
         */
        function loadPatternCombo(comboName) {
            const combos = {
                'trap-banger': {
                    kick: 'hard',
                    hihat: 'trap-roll',
                    bpm: 140
                },
                'drill-attack': {
                    kick: 'drill',
                    hihat: 'drill-roll',
                    bpm: 150
                },
                'minimalist': {
                    kick: 'sparse',
                    hihat: 'minimal',
                    bpm: 120
                },
                'hyperpop-chaos': {
                    kick: 'triplet',
                    hihat: 'double-time',
                    bpm: 165
                },
                'boom-bap-classic': {
                    kick: 'classic',
                    hihat: 'half-time',
                    bpm: 90
                },
                'lo-fi-chill': {
                    kick: 'offbeat',
                    hihat: 'shuffled',
                    bpm: 80
                },
                'jersey-bounce': {
                    kick: 'triplet',
                    hihat: 'double-time',
                    bpm: 135
                },
                'phonk-drift': {
                    kick: 'rolling',
                    hihat: 'syncopated',
                    bpm: 130
                }
            };
            
            const combo = combos[comboName];
            if (!combo) return;
            
            // Set BPM
            document.getElementById('bpmControl').value = combo.bpm;
            updateBPM(combo.bpm);
            
            // Load patterns
            loadKickPattern(combo.kick);
            loadHiHatPattern(combo.hihat);
            
            // Play preview
            setTimeout(() => playBeat(), 200);
            
            console.log(`Loaded combo: ${comboName}`);
        }
        
        /**
         * Randomize kick pattern
         */
        function randomizeKickPattern() {
            const patterns = ['classic', 'hard', 'rolling', 'double', 'triplet', 'offbeat', 'syncopated', 'drill', 'sparse', 'breakbeat'];
            const random = patterns[Math.floor(Math.random() * patterns.length)];
            loadKickPattern(random);
        }
        
        /**
         * Randomize hi-hat pattern
         */
        function randomizeHiHatPattern() {
            const patterns = ['closed', 'open', 'trap-roll', 'drill-roll', 'double-time', 'half-time', 'triplets', 'shuffled', 'syncopated', 'minimal'];
            const random = patterns[Math.floor(Math.random() * patterns.length)];
            loadHiHatPattern(random);
        }
        
        /**
         * Randomize all patterns
         */
        function randomizeAllPatterns() {
            randomizeKickPattern();
            setTimeout(() => randomizeHiHatPattern(), 100);
            setTimeout(() => playBeat(), 300);
        }
        
        /**
         * Mutate current pattern (slight variations)
         */
        function mutateCurrentPattern() {
            // Add random variations to existing pattern
            instruments.forEach(instrument => {
                const currentPattern = beatPattern[instrument];
                if (currentPattern.length > 0) {
                    // 30% chance to add a new hit
                    if (Math.random() < 0.3) {
                        const randomStep = Math.floor(Math.random() * 16);
                        if (!currentPattern.includes(randomStep)) {
                            currentPattern.push(randomStep);
                        }
                    }
                    // 20% chance to remove a hit
                    if (Math.random() < 0.2 && currentPattern.length > 1) {
                        const randomIndex = Math.floor(Math.random() * currentPattern.length);
                        currentPattern.splice(randomIndex, 1);
                    }
                }
            });
            
            updateBeatGrid();
            setTimeout(() => playBeat(), 100);
        }

        // ============================================
        // RADIO INTEGRATION
        // ============================================
        
        /**
         * Export current beat to Radio 24/7
         * Records the beat and sends it to the radio queue
         */
        async function exportToRadio() {
            if (generatedChords.length === 0 && !hasActivePattern()) {
                alert('‚ö†Ô∏è Create a beat first!\n\n1. Generate a chord progression\n2. Add drum pattern\n3. Click "Send to Radio"');
                return;
            }

            // Show progress
            const originalBtn = event.target;
            const originalText = originalBtn.innerHTML;
            originalBtn.innerHTML = 'üéôÔ∏è Recording...';
            originalBtn.disabled = true;

            try {
                // Record the beat (8 bars)
                const audioBlob = await recordBeat();
                
                if (!audioBlob) {
                    throw new Error('Recording failed');
                }

                // Get beat metadata
                const beatName = `Trap Beat ${new Date().toLocaleTimeString()}`;
                const bpm = parseInt(document.getElementById('bpmSlider').value);
                const key = document.getElementById('keySelect').value;
                
                // Send to Radio 24/7
                const success = sendToRadio({
                    blob: audioBlob,
                    title: beatName,
                    artist: 'Trap Studio',
                    bpm: bpm,
                    key: key,
                    channel: 'rap' // Trap beats go to Rap channel
                });

                if (success) {
                    originalBtn.innerHTML = '‚úÖ Sent to Radio!';
                    setTimeout(() => {
                        originalBtn.innerHTML = originalText;
                        originalBtn.disabled = false;
                    }, 2000);
                    
                    // Ask if user wants to open radio
                    if (confirm('üéâ Beat sent to Rap Radio!\n\nOpen Radio 24/7 now?')) {
                        window.open('/radio.html', '_blank');
                    }
                } else {
                    throw new Error('Failed to send to radio');
                }
            } catch (error) {
                console.error('Export to radio error:', error);
                originalBtn.innerHTML = '‚ùå Failed';
                setTimeout(() => {
                    originalBtn.innerHTML = originalText;
                    originalBtn.disabled = false;
                }, 2000);
                alert('‚ùå Failed to send to radio. Make sure you have created a beat first.');
            }
        }

        /**
         * Check if there's an active drum pattern
         */
        function hasActivePattern() {
            const grid = document.getElementById('beatGrid');
            if (!grid) return false;
            
            const cells = grid.querySelectorAll('.beat-cell.active');
            return cells.length > 0;
        }

        /**
         * Record the current beat to audio blob
         */
        async function recordBeat() {
            return new Promise((resolve, reject) => {
                try {
                    // Create MediaStreamDestination for recording
                    const destination = audioContext.createMediaStreamDestination();
                    
                    // Start recording
                    const mediaRecorder = new MediaRecorder(destination.stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    const chunks = [];
                    
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            chunks.push(e.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        resolve(blob);
                    };
                    
                    mediaRecorder.onerror = (error) => {
                        reject(error);
                    };
                    
                    // Start recording
                    mediaRecorder.start();
                    
                    // Play beat for 8 bars
                    const bpm = parseInt(document.getElementById('bpmSlider').value);
                    const barDuration = (60 / bpm) * 4 * 1000; // 4 beats per bar
                    const recordingDuration = barDuration * 8; // 8 bars
                    
                    // Play the beat with recording destination
                    playBeatWithDestination(destination, recordingDuration);
                    
                    // Stop recording after duration
                    setTimeout(() => {
                        mediaRecorder.stop();
                    }, recordingDuration + 500); // Add 500ms buffer
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        /**
         * Play beat with custom destination (for recording)
         */
        function playBeatWithDestination(destination, duration) {
            const bpm = parseInt(document.getElementById('bpmSlider').value);
            const beatInterval = (60 / bpm) * 1000 / 4; // 16th note interval
            let currentStep = 0;
            const totalSteps = Math.ceil(duration / beatInterval);
            
            const playStep = () => {
                if (currentStep >= totalSteps) return;
                
                const stepInPattern = currentStep % 16;
                
                // Play active instruments on this step
                ['kick', 'snare', 'hihat', 'clap'].forEach((instrument, row) => {
                    const cell = document.querySelector(`[data-row="${row}"][data-col="${stepInPattern}"]`);
                    if (cell && cell.classList.contains('active')) {
                        playSampleWithDestination(instrument, destination);
                    }
                });
                
                // Play chord progression
                if (generatedChords.length > 0 && stepInPattern % 4 === 0) {
                    const chordIndex = Math.floor(stepInPattern / 4) % generatedChords.length;
                    const chord = generatedChords[chordIndex];
                    if (chord) {
                        playChordWithDestination(chord, destination);
                    }
                }
                
                currentStep++;
                setTimeout(playStep, beatInterval);
            };
            
            playStep();
        }

        /**
         * Play sample with custom destination
         */
        function playSampleWithDestination(instrument, destination) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(destination);
            gainNode.connect(audioContext.destination); // Also to speakers
            
            // Instrument-specific settings
            const settings = {
                kick: { freq: 60, decay: 0.5, gain: 0.8 },
                snare: { freq: 200, decay: 0.15, gain: 0.6 },
                hihat: { freq: 8000, decay: 0.05, gain: 0.4 },
                clap: { freq: 1000, decay: 0.1, gain: 0.5 }
            };
            
            const config = settings[instrument] || settings.kick;
            
            oscillator.frequency.setValueAtTime(config.freq, audioContext.currentTime);
            gainNode.gain.setValueAtTime(config.gain, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + config.decay);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + config.decay);
        }

        /**
         * Send audio blob to Radio 24/7
         */
        function sendToRadio(beatData) {
            try {
                // Create a unique track object
                const track = {
                    id: Date.now() + Math.random(),
                    title: beatData.title,
                    artist: beatData.artist,
                    bpm: beatData.bpm,
                    key: beatData.key,
                    url: URL.createObjectURL(beatData.blob),
                    file: new File([beatData.blob], `${beatData.title}.webm`, { type: 'audio/webm' }),
                    channel: beatData.channel,
                    duration: 0, // Will be calculated by Radio
                    source: 'Trap Studio'
                };
                
                // Store in localStorage for Radio to pickup
                const radioQueue = localStorage.getItem('rapQueue');
                let queue = radioQueue ? JSON.parse(radioQueue) : [];
                
                // Add metadata (note: blob URLs can't be persisted)
                queue.push({
                    id: track.id,
                    title: track.title,
                    artist: track.artist,
                    bpm: track.bpm,
                    key: track.key,
                    channel: track.channel,
                    source: track.source,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem('rapQueue', JSON.stringify(queue));
                
                // Also send via postMessage if Radio is open
                if (window.opener || window.parent !== window) {
                    window.postMessage({
                        type: 'ADD_TO_RADIO',
                        track: track
                    }, '*');
                }
                
                // Dispatch custom event for same-window communication
                window.dispatchEvent(new CustomEvent('trapStudioBeatExport', {
                    detail: track
                }));
                
                return true;
            } catch (error) {
                console.error('Failed to send to radio:', error);
                return false;
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initBeatGrid();
            draw808Waveform();
        });

        // Resume AudioContext on user interaction (required by browsers)
        document.addEventListener('click', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });

        // ============================================
        // LIVE INTERACTIVE TUTORIAL SYSTEM
        // ============================================
        
        let tutorialActive = false;
        let currentTutorialStep = 0;
        
        const tutorialSteps = [
            {
                title: "üéâ Welcome to Trap Studio!",
                text: "Let's take a quick tour of the new features that will help you create amazing beats!",
                element: null,
                highlightGuidance: true
            },
            {
                title: "üí° Live Guidance Panel",
                text: "This panel shows you exactly what to do next. Follow the 7 steps to create your first beat!",
                element: "#guidancePanel",
                action: () => {
                    const panel = document.getElementById('guidancePanel');
                    if (panel.classList.contains('minimized')) {
                        toggleGuidance();
                    }
                }
            },
            {
                title: "‚ÑπÔ∏è Interactive Tooltips",
                text: "Hover over any ‚Ñπ icon to learn what each control does. Try hovering over the BPM tooltip!",
                element: ".info-tooltip",
                demo: "tooltip"
            },
            {
                title: "üöÄ Quick Presets",
                text: "Click these buttons for instant professional settings. Try 'Classic Trap' to get started fast!",
                element: ".quick-actions",
                action: () => {
                    const btn = document.querySelector('.quick-action-btn');
                    if (btn) {
                        btn.style.animation = 'tour-bounce 0.5s 3';
                    }
                }
            },
            {
                title: "üìä Live Feedback",
                text: "Watch the style indicators update in real-time as you adjust parameters. The values show you exactly what sound you're creating!",
                element: ".value-display",
                demo: "parameter"
            },
            {
                title: "üéµ BPM Control",
                text: "Try adjusting the BPM slider and watch the style change from 'Boom-Bap' to 'Trap' to 'Drill'!",
                element: "#bpmControl"
            },
            {
                title: "üéâ You're Ready!",
                text: "You now know how to use all the new features. Start creating your first trap beat!",
                element: null,
                action: () => {
                    showAchievement("Tutorial Complete!", "You're ready to create amazing beats! üî•");
                }
            }
        ];

        function startTutorial() {
            tutorialActive = true;
            currentTutorialStep = 0;
            showTutorialStep(0);
        }

        function showTutorialStep(stepIndex) {
            if (stepIndex >= tutorialSteps.length) {
                endTutorial();
                return;
            }

            const step = tutorialSteps[stepIndex];
            
            // Remove previous spotlight
            const oldSpotlight = document.querySelector('.tutorial-spotlight');
            if (oldSpotlight) oldSpotlight.remove();
            
            // Create overlay
            let overlay = document.querySelector('.tutorial-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'tutorial-overlay';
                document.body.appendChild(overlay);
            }
            
            overlay.className = 'tutorial-overlay active';
            
            // Create tutorial card
            const card = document.createElement('div');
            card.className = 'tutorial-card';
            card.innerHTML = `
                <div class="tutorial-title">${step.title}</div>
                <div class="tutorial-text">${step.text}</div>
                <div class="tutorial-buttons">
                    ${stepIndex > 0 ? '<button class="tutorial-btn" onclick="previousTutorialStep()">‚Üê Back</button>' : ''}
                    <button class="tutorial-btn primary" onclick="nextTutorialStep()">
                        ${stepIndex < tutorialSteps.length - 1 ? 'Next ‚Üí' : 'Finish ‚úì'}
                    </button>
                    <button class="tutorial-btn" onclick="skipTutorial()">Skip Tour</button>
                </div>
            `;
            
            overlay.innerHTML = '';
            overlay.appendChild(card);
            
            // Highlight element if specified
            if (step.element) {
                const element = document.querySelector(step.element);
                if (element) {
                    const rect = element.getBoundingClientRect();
                    const spotlight = document.createElement('div');
                    spotlight.className = 'tutorial-spotlight';
                    spotlight.style.top = `${rect.top - 10}px`;
                    spotlight.style.left = `${rect.left - 10}px`;
                    spotlight.style.width = `${rect.width + 20}px`;
                    spotlight.style.height = `${rect.height + 20}px`;
                    document.body.appendChild(spotlight);
                    
                    // Scroll element into view
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            // Execute step action
            if (step.action) {
                setTimeout(step.action, 500);
            }
        }

        function nextTutorialStep() {
            currentTutorialStep++;
            showTutorialStep(currentTutorialStep);
        }

        function previousTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                showTutorialStep(currentTutorialStep);
            }
        }

        function skipTutorial() {
            endTutorial();
        }

        function endTutorial() {
            tutorialActive = false;
            const overlay = document.querySelector('.tutorial-overlay');
            if (overlay) overlay.classList.remove('active');
            const spotlight = document.querySelector('.tutorial-spotlight');
            if (spotlight) spotlight.remove();
            
            // Hide tour button
            const tourBtn = document.getElementById('tourButton');
            if (tourBtn) tourBtn.style.display = 'none';
        }

        // ============================================
        // LIVE PARAMETER PREVIEW
        // ============================================
        
        function showParameterPreview(element, paramName, value, type = 'bar') {
            const container = element.closest('.control-group');
            if (!container) return;
            
            let preview = container.querySelector('.param-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.className = 'param-preview';
                container.style.position = 'relative';
                container.appendChild(preview);
            }
            
            const percentage = ((value - element.min) / (element.max - element.min)) * 100;
            
            preview.innerHTML = `
                <div class="param-preview-title">${paramName} Preview</div>
                <div class="param-preview-visual">
                    ${type === 'bar' ? 
                        `<div class="param-preview-bar" style="width: ${percentage}%"></div>` :
                        `<canvas class="param-preview-wave" id="preview-${paramName}"></canvas>`
                    }
                </div>
            `;
            
            preview.classList.add('active');
            
            // Auto-hide after 2 seconds
            setTimeout(() => {
                preview.classList.remove('active');
            }, 2000);
            
            // Draw waveform if type is 'wave'
            if (type === 'wave') {
                drawPreviewWaveform(`preview-${paramName}`, value);
            }
        }

        function drawPreviewWaveform(canvasId, frequency) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#08d9d6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const amplitude = canvas.height / 3;
            const centerY = canvas.height / 2;
            const cycles = frequency / 50; // Scale frequency to visible cycles
            
            for (let x = 0; x < canvas.width; x++) {
                const y = centerY + Math.sin((x / canvas.width) * Math.PI * 2 * cycles) * amplitude;
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            
            ctx.stroke();
        }

        // ============================================
        // ACHIEVEMENT SYSTEM
        // ============================================
        
        let achievements = {
            firstBeat: false,
            firstPreset: false,
            first808: false,
            firstRadio: false
        };

        function showAchievement(title, text) {
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.innerHTML = `
                <div class="achievement-title">üèÜ ${title}</div>
                <div class="achievement-text">${text}</div>
            `;
            
            document.body.appendChild(achievement);
            
            setTimeout(() => achievement.classList.add('show'), 100);
            setTimeout(() => {
                achievement.classList.remove('show');
                setTimeout(() => achievement.remove(), 500);
            }, 3000);
        }

        function checkAchievement(type) {
            if (!achievements[type]) {
                achievements[type] = true;
                switch(type) {
                    case 'firstBeat':
                        showAchievement("First Beat!", "You played your first trap beat! üéµ");
                        break;
                    case 'firstPreset':
                        showAchievement("Preset Master!", "You used a quick preset! ‚ö°");
                        break;
                    case 'first808':
                        showAchievement("808 Designer!", "You customized your 808 bass! üîä");
                        break;
                    case 'firstRadio':
                        showAchievement("Live on Air!", "Your beat is broadcasting on Radio 24/7! üìª");
                        break;
                }
                
                // Save to localStorage
                localStorage.setItem('trap-achievements', JSON.stringify(achievements));
            }
        }

        // Load achievements from localStorage
        const savedAchievements = localStorage.getItem('trap-achievements');
        if (savedAchievements) {
            achievements = JSON.parse(savedAchievements);
        }

        // ============================================
        // LIVE VISUALIZER
        // ============================================
        
        function createLiveVisualizer(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const visualizer = document.createElement('div');
            visualizer.className = 'live-visualizer';
            visualizer.innerHTML = '<div class="visualizer-bars"></div>';
            container.appendChild(visualizer);
            
            const bars = visualizer.querySelector('.visualizer-bars');
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bars.appendChild(bar);
            }
            
            return visualizer;
        }

        function animateVisualizer(visualizer, active = true) {
            if (!visualizer) return;
            
            const bars = visualizer.querySelectorAll('.visualizer-bar');
            
            if (active) {
                const interval = setInterval(() => {
                    if (!visualizer.isConnected) {
                        clearInterval(interval);
                        return;
                    }
                    
                    bars.forEach(bar => {
                        const height = Math.random() * 80 + 10;
                        bar.style.height = `${height}%`;
                    });
                }, 100);
            } else {
                bars.forEach(bar => {
                    bar.style.height = '5px';
                });
            }
        }

        // ============================================
        // ENHANCED PARAMETER UPDATES WITH LIVE FEATURES
        // ============================================
        
        const originalUpdateBPM = window.updateBPM;
        window.updateBPM = function(value) {
            if (originalUpdateBPM) originalUpdateBPM(value);
            
            const slider = document.getElementById('bpmControl');
            if (slider) {
                showParameterPreview(slider, 'BPM', value, 'bar');
            }
        };

        const originalUpdate808Param = window.update808Param;
        window.update808Param = function(param, value) {
            if (originalUpdate808Param) originalUpdate808Param(param, value);
            
            if (param === 'freq') {
                const slider = document.getElementById('bass808Freq');
                if (slider) {
                    showParameterPreview(slider, 'Frequency', value, 'wave');
                }
                checkAchievement('first808');
            }
        };

        const originalPlayBeat = window.playBeat;
        window.playBeat = function() {
            if (originalPlayBeat) originalPlayBeat();
            checkAchievement('firstBeat');
        };

        const originalLoadPresetPattern = window.loadPresetPattern;
        window.loadPresetPattern = function(type) {
            if (originalLoadPresetPattern) originalLoadPresetPattern(type);
            checkAchievement('firstPreset');
        };

        const originalExportToRadio = window.exportToRadio;
        window.exportToRadio = function() {
            if (originalExportToRadio) originalExportToRadio();
            checkAchievement('firstRadio');
        };

        // ============================================
        // SMART PRESET SYSTEM with AUTO-SAVE
        // ============================================
        
        let userPresets = {};
        const PRESET_SLOTS = 9;

        function saveCurrentAsPreset(slot) {
            if (slot < 1 || slot > PRESET_SLOTS) return;
            
            const presetName = prompt(`üíæ Name your preset (Slot ${slot}):`, `My Preset ${slot}`);
            if (!presetName) return;
            
            // Capture current state
            const preset = {
                name: presetName,
                timestamp: new Date().toISOString(),
                parameters: {
                    key: document.getElementById('keySelect')?.value,
                    scale: document.getElementById('scaleSelect')?.value,
                    bpm: parseInt(document.getElementById('bpmControl')?.value || 140),
                    bass808Freq: parseInt(document.getElementById('bass808Freq')?.value || 55),
                    bass808Decay: parseFloat(document.getElementById('bass808Decay')?.value || 0.6),
                    bass808Gain: parseFloat(document.getElementById('bass808Gain')?.value || 0.8),
                    // Add more parameters as needed
                }
            };
            
            userPresets[`slot${slot}`] = preset;
            localStorage.setItem('trap-user-presets', JSON.stringify(userPresets));
            
            showToast(`‚úÖ Preset "${presetName}" saved to slot ${slot}!`, 'success');
            updatePresetButtons();
        }

        function loadUserPreset(slot) {
            const preset = userPresets[`slot${slot}`];
            if (!preset) {
                showToast(`‚ùå No preset in slot ${slot}`, 'error');
                return;
            }
            
            // Load parameters
            const params = preset.parameters;
            if (document.getElementById('keySelect')) document.getElementById('keySelect').value = params.key || 'C';
            if (document.getElementById('scaleSelect')) document.getElementById('scaleSelect').value = params.scale || 'minor';
            if (document.getElementById('bpmControl')) {
                document.getElementById('bpmControl').value = params.bpm || 140;
                updateBPM(params.bpm || 140);
            }
            if (document.getElementById('bass808Freq')) {
                document.getElementById('bass808Freq').value = params.bass808Freq || 55;
                update808Param('freq', params.bass808Freq || 55);
            }
            if (document.getElementById('bass808Decay')) {
                document.getElementById('bass808Decay').value = params.bass808Decay || 0.6;
                update808Param('decay', params.bass808Decay || 0.6);
            }
            if (document.getElementById('bass808Gain')) {
                document.getElementById('bass808Gain').value = params.bass808Gain || 0.8;
                update808Param('gain', params.bass808Gain || 0.8);
            }
            
            showToast(`‚úÖ Loaded preset "${preset.name}"`, 'success');
            checkAchievement('firstPreset');
        }

        function deleteUserPreset(slot) {
            const preset = userPresets[`slot${slot}`];
            if (!preset) return;
            
            if (confirm(`Delete preset "${preset.name}"?`)) {
                delete userPresets[`slot${slot}`];
                localStorage.setItem('trap-user-presets', JSON.stringify(userPresets));
                showToast(`üóëÔ∏è Preset deleted`, 'info');
                updatePresetButtons();
            }
        }

        function exportUserPresets() {
            const dataStr = JSON.stringify(userPresets, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trap-studio-presets-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('üì¶ Presets exported!', 'success');
        }

        function importUserPresets() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        userPresets = { ...userPresets, ...imported };
                        localStorage.setItem('trap-user-presets', JSON.stringify(userPresets));
                        updatePresetButtons();
                        showToast('üì• Presets imported!', 'success');
                    } catch (err) {
                        showToast('‚ùå Invalid preset file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function updatePresetButtons() {
            // Update UI to show which slots have presets
            for (let i = 1; i <= PRESET_SLOTS; i++) {
                const preset = userPresets[`slot${i}`];
                const btn = document.querySelector(`[data-preset-slot="${i}"]`);
                if (btn) {
                    btn.textContent = preset ? `${i}: ${preset.name}` : `${i}: Empty`;
                    btn.classList.toggle('has-preset', !!preset);
                }
            }
        }

        function renderPresetSlots() {
            const container = document.getElementById('presetSlotsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 1; i <= PRESET_SLOTS; i++) {
                const preset = userPresets[`slot${i}`];
                const slot = document.createElement('div');
                slot.className = `preset-slot ${preset ? 'has-preset' : ''}`;
                
                if (preset) {
                    const date = new Date(preset.timestamp);
                    slot.innerHTML = `
                        <div class="preset-slot-info">
                            <div class="preset-slot-name">üéµ Slot ${i}: ${preset.name}</div>
                            <div class="preset-slot-time">Saved: ${date.toLocaleString()}</div>
                            <div class="preset-slot-time" style="margin-top: 5px;">
                                BPM: ${preset.parameters.bpm} | Key: ${preset.parameters.key} ${preset.parameters.scale}
                            </div>
                        </div>
                        <div class="preset-slot-buttons">
                            <button class="load-btn" onclick="loadUserPreset(${i}); document.getElementById('presetManager').classList.remove('active');">
                                ‚ñ∂ Load
                            </button>
                            <button class="delete-btn" onclick="deleteUserPreset(${i}); renderPresetSlots();">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div class="preset-slot-info">
                            <div class="preset-slot-name" style="color: var(--text-secondary);">üì≠ Slot ${i}: Empty</div>
                            <div class="preset-slot-time">No preset saved</div>
                        </div>
                        <div class="preset-slot-buttons">
                            <button class="load-btn" onclick="saveCurrentAsPreset(${i}); renderPresetSlots();" 
                                    style="background: var(--accent-gold);">
                                üíæ Save Here
                            </button>
                        </div>
                    `;
                }
                
                container.appendChild(slot);
            }
        }

        // Load user presets from localStorage
        const savedUserPresets = localStorage.getItem('trap-user-presets');
        if (savedUserPresets) {
            userPresets = JSON.parse(savedUserPresets);
        }

        // ============================================
        // KEYBOARD SHORTCUTS SYSTEM
        // ============================================
        
        const shortcuts = {
            ' ': () => { // Space - Play/Pause
                const playBtn = document.querySelector('button[onclick*="playBeat"]');
                if (playBtn) playBtn.click();
            },
            's': (e) => { // S - Save preset
                if (e.ctrlKey || e.metaKey) return; // Don't interfere with Cmd+S
                const slot = prompt('Save to slot (1-9):', '1');
                if (slot && /^[1-9]$/.test(slot)) {
                    saveCurrentAsPreset(parseInt(slot));
                }
            },
            'r': () => { // R - Randomize
                randomizeParameters();
            },
            'l': () => { // L - Load random quick preset
                const presets = ['classic-trap', 'uk-drill', 'boom-bap', 'triplet-trap'];
                const random = presets[Math.floor(Math.random() * presets.length)];
                loadPresetPattern(random);
            },
            'h': () => { // H - Show shortcuts help
                showShortcutsHelp();
            },
            'Escape': () => { // ESC - Close any modal/tutorial
                if (currentTutorialStep >= 0) {
                    document.getElementById('tutorialOverlay')?.remove();
                    currentTutorialStep = -1;
                }
            }
        };

        // Number keys 1-9 for quick preset recall
        for (let i = 1; i <= 9; i++) {
            shortcuts[i.toString()] = () => loadUserPreset(i);
        }

        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            const handler = shortcuts[e.key];
            if (handler) {
                e.preventDefault();
                handler(e);
            }
            
            // Ctrl/Cmd + Z for undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undoLastChange();
            }
            
            // Ctrl/Cmd + Y for redo
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redoChange();
            }
        });

        function showShortcutsHelp() {
            const helpText = `
üéπ Keyboard Shortcuts:

SPACE     - Play/Pause beat
S         - Save current preset
R         - Randomize parameters
L         - Load random preset
H         - Show this help
ESC       - Close tutorial/modals
1-9       - Load user preset (slots 1-9)
Cmd+Z     - Undo last change
Cmd+Y     - Redo change

üí° Tip: These shortcuts work when not typing in input fields!
            `;
            alert(helpText.trim());
        }

        // ============================================
        // UNDO/REDO HISTORY SYSTEM
        // ============================================
        
        const historyStack = [];
        const redoStack = [];
        const MAX_HISTORY = 50;
        
        let lastState = null;

        function captureState() {
            return {
                timestamp: Date.now(),
                parameters: {
                    key: document.getElementById('keySelect')?.value,
                    scale: document.getElementById('scaleSelect')?.value,
                    bpm: parseInt(document.getElementById('bpmControl')?.value || 140),
                    bass808Freq: parseInt(document.getElementById('bass808Freq')?.value || 55),
                    bass808Decay: parseFloat(document.getElementById('bass808Decay')?.value || 0.6),
                    bass808Gain: parseFloat(document.getElementById('bass808Gain')?.value || 0.8),
                }
            };
        }

        function saveToHistory() {
            const currentState = captureState();
            
            // Don't save if no change
            if (lastState && JSON.stringify(currentState.parameters) === JSON.stringify(lastState.parameters)) {
                return;
            }
            
            historyStack.push(currentState);
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
            }
            
            redoStack.length = 0; // Clear redo stack on new action
            lastState = currentState;
        }

        function undoLastChange() {
            if (historyStack.length < 2) {
                showToast('‚ùå Nothing to undo', 'info');
                return;
            }
            
            const current = historyStack.pop();
            redoStack.push(current);
            
            const previous = historyStack[historyStack.length - 1];
            restoreState(previous);
            showToast('‚Ü∂ Undo', 'info');
        }

        function redoChange() {
            if (redoStack.length === 0) {
                showToast('‚ùå Nothing to redo', 'info');
                return;
            }
            
            const state = redoStack.pop();
            historyStack.push(state);
            restoreState(state);
            showToast('‚Ü∑ Redo', 'info');
        }

        function restoreState(state) {
            const params = state.parameters;
            if (document.getElementById('keySelect')) document.getElementById('keySelect').value = params.key;
            if (document.getElementById('scaleSelect')) document.getElementById('scaleSelect').value = params.scale;
            if (document.getElementById('bpmControl')) {
                document.getElementById('bpmControl').value = params.bpm;
                updateBPM(params.bpm);
            }
            if (document.getElementById('bass808Freq')) {
                document.getElementById('bass808Freq').value = params.bass808Freq;
                update808Param('freq', params.bass808Freq);
            }
            if (document.getElementById('bass808Decay')) {
                document.getElementById('bass808Decay').value = params.bass808Decay;
                update808Param('decay', params.bass808Decay);
            }
            if (document.getElementById('bass808Gain')) {
                document.getElementById('bass808Gain').value = params.bass808Gain;
                update808Param('gain', params.bass808Gain);
            }
            lastState = state;
        }

        // Auto-save to history on parameter change
        document.addEventListener('change', (e) => {
            if (e.target.type === 'range' || e.target.tagName === 'SELECT') {
                debounce(() => saveToHistory(), 500)();
            }
        });

        // ============================================
        // PARAMETER RANDOMIZER
        // ============================================
        
        function randomizeParameters() {
            if (!confirm('üé≤ Randomize all parameters? This will create a unique sound!')) return;
            
            saveToHistory(); // Save before randomizing
            
            // Randomize BPM (120-180)
            const randomBPM = Math.floor(Math.random() * 61) + 120;
            if (document.getElementById('bpmControl')) {
                document.getElementById('bpmControl').value = randomBPM;
                updateBPM(randomBPM);
            }
            
            // Randomize 808 frequency (40-80)
            const random808 = Math.floor(Math.random() * 41) + 40;
            if (document.getElementById('bass808Freq')) {
                document.getElementById('bass808Freq').value = random808;
                update808Param('freq', random808);
            }
            
            // Randomize 808 decay (0.3-1.0)
            const randomDecay = (Math.random() * 0.7) + 0.3;
            if (document.getElementById('bass808Decay')) {
                document.getElementById('bass808Decay').value = randomDecay.toFixed(2);
                update808Param('decay', randomDecay);
            }
            
            // Randomize key
            const keys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            if (document.getElementById('keySelect')) {
                document.getElementById('keySelect').value = randomKey;
            }
            
            showToast('üé≤ Parameters randomized!', 'success');
        }

        // ============================================
        // SMART SUGGESTIONS ENGINE
        // ============================================
        
        function suggestParameters() {
            const bpm = parseInt(document.getElementById('bpmControl')?.value || 140);
            const suggestions = [];
            
            // BPM-based suggestions
            if (bpm < 120) {
                suggestions.push("üí° For this slow tempo, try a deeper 808 (40-50 Hz)");
            } else if (bpm > 160) {
                suggestions.push("üí° Fast BPM detected! Try shorter 808 decay (0.3-0.5s)");
            } else {
                suggestions.push("üí° Classic trap range! Experiment with 808 around 55 Hz");
            }
            
            // Key-based suggestions
            const key = document.getElementById('keySelect')?.value;
            const scale = document.getElementById('scaleSelect')?.value;
            if (scale === 'minor') {
                suggestions.push("üí° Minor scale = dark vibes. Try chord progressions: i-VI-III-VII");
            } else {
                suggestions.push("üí° Major scale = uplifting. Try: I-V-vi-IV");
            }
            
            return suggestions;
        }

        function showSuggestions() {
            const suggestions = suggestParameters();
            const suggestText = suggestions.join('\n\n');
            alert(`üéØ Smart Suggestions:\n\n${suggestText}`);
        }

        // ============================================
        // TOAST NOTIFICATION SYSTEM
        // ============================================
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#00ff41' : type === 'error' ? '#ff2e63' : '#08d9d6'};
                color: #000;
                border-radius: 8px;
                font-weight: bold;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // DEBOUNCE UTILITY
        // ============================================
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ============================================
        // FIRST-TIME USER DETECTION
        // ============================================
        
        window.addEventListener('DOMContentLoaded', () => {
            const hasVisited = localStorage.getItem('trap-studio-visited');
            
            if (!hasVisited) {
                // Show welcome and start tutorial
                setTimeout(() => {
                    const tourBtn = document.getElementById('tourButton');
                    if (tourBtn) tourBtn.style.display = 'block';
                    
                    // Auto-start tutorial after 2 seconds
                    setTimeout(() => {
                        if (confirm('üëã Welcome to Trap Studio! Would you like a quick tour of the new features?')) {
                            startTutorial();
                        } else {
                            showToast('üí° Press H for keyboard shortcuts!', 'info');
                        }
                    }, 2000);
                }, 1000);
                
                localStorage.setItem('trap-studio-visited', 'true');
            } else {
                // Show tour button for returning users
                setTimeout(() => {
                    const tourBtn = document.getElementById('tourButton');
                    if (tourBtn) tourBtn.style.display = 'block';
                }, 1000);
            }
            
            // Initialize history with current state
            setTimeout(() => saveToHistory(), 500);
        });
    </script>


    <!-- Interactive Tutorial Button -->
    <button id="tourButton" class="tour-button" onclick="startTutorial()" style="display: none;">
        üéì Take a Tour
    </button>

    <!-- Shortcuts Panel -->
    <div id="shortcutsPanel" class="shortcuts-panel minimized">
        <h3 onclick="document.getElementById('shortcutsPanel').classList.toggle('minimized')">
            ‚å®Ô∏è Keyboard Shortcuts
            <span style="font-size: 0.8em;">‚ñº</span>
        </h3>
        <div class="shortcuts-content">
            <div class="shortcut-item">
                <span class="shortcut-key">SPACE</span>
                <span class="shortcut-desc">Play/Pause</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">S</span>
                <span class="shortcut-desc">Save Preset</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">R</span>
                <span class="shortcut-desc">Randomize</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">L</span>
                <span class="shortcut-desc">Load Random</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">1-9</span>
                <span class="shortcut-desc">Load Preset</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">Cmd+Z</span>
                <span class="shortcut-desc">Undo</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">Cmd+Y</span>
                <span class="shortcut-desc">Redo</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">H</span>
                <span class="shortcut-desc">Show Help</span>
            </div>
        </div>
    </div>

    <!-- Preset Manager Modal -->
    <div id="presetManager" class="preset-manager">
        <h2 style="color: var(--accent-primary); margin-bottom: 20px; text-align: center;">
            üíæ Preset Manager
        </h2>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button onclick="saveCurrentAsPreset(prompt('Slot (1-9):', '1'))" 
                    style="flex: 1; padding: 12px; background: var(--accent-secondary); border: none; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; min-width: 120px;">
                ‚ûï Save Current
            </button>
            <button onclick="exportUserPresets()" 
                    style="flex: 1; padding: 12px; background: var(--accent-gold); border: none; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; min-width: 120px;">
                üì§ Export All
            </button>
            <button onclick="importUserPresets()" 
                    style="flex: 1; padding: 12px; background: var(--accent-primary); border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; min-width: 120px;">
                üì• Import
            </button>
            <button onclick="document.getElementById('presetManager').classList.remove('active')" 
                    style="flex: 1; padding: 12px; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-weight: bold; cursor: pointer; min-width: 120px;">
                ‚úñ Close
            </button>
        </div>

        <div id="presetSlotsList">
            <!-- Preset slots will be dynamically populated -->
        </div>
    </div>

    <!-- Quick Action Toolbar -->
    <div style="position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 998;">
        <button onclick="document.getElementById('presetManager').classList.add('active'); renderPresetSlots()" 
                class="tour-button" style="position: relative; animation: none;">
            üíæ Presets
        </button>
        <button onclick="randomizeParameters()" 
                class="tour-button" style="position: relative; animation: none; background: linear-gradient(135deg, #ff00ff, #00ffff);">
            üé≤ Random
        </button>
        <button onclick="showSuggestions()" 
                class="tour-button" style="position: relative; animation: none; background: linear-gradient(135deg, #ffd700, #ff8c00);">
            üí° Tips
        </button>
        <button onclick="undoLastChange()" 
                class="tour-button" style="position: relative; animation: none; background: linear-gradient(135deg, #4CAF50, #2196F3);">
            ‚Ü∂ Undo
        </button>
    </div>

</body>
</html>

