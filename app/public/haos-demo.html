<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAOS.fm - Professional Techno Sound Design Platform</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1a202c;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        
        .logo-container {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .logo {
            max-width: 200px;
            height: auto;
            filter: drop-shadow(0 10px 30px rgba(102, 126, 234, 0.5));
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            font-size: 3.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
            font-weight: 700;
        }
        
        .tagline {
            font-size: 1.3em;
            color: #4a5568;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9em;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-weight: 700;
        }
        
        h3 {
            color: #f59e0b;
            font-size: 1.5em;
            margin: 20px 0 15px 0;
            font-weight: 600;
        }
        
        .synth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .synth-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .synth-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            border-color: #f59e0b;
        }
        
        .synth-name {
            font-size: 1.8em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .synth-description {
            color: #718096;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        
        .preset-count {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:disabled {
            background: #cbd5e0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        .visualizer-container {
            background: #000;
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }
        
        canvas {
            width: 100%;
            height: 200px;
            border-radius: 5px;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        label {
            color: #00ff88;
            margin-right: 10px;
            font-weight: bold;
        }
        
        select, input[type="range"] {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 1px solid #00ff88;
            padding: 8px 12px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }
        
        input[type="range"] {
            width: 200px;
        }
        
        .value-display {
            background: rgba(255, 0, 255, 0.2);
            color: #ff00ff;
            padding: 8px 15px;
            border-radius: 5px;
            min-width: 60px;
            text-align: center;
        }
        
        .preset-browser {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        
        .preset-item {
            background: rgba(0, 221, 255, 0.1);
            border: 1px solid #00ddff;
            border-radius: 5px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .preset-item:hover {
            background: rgba(0, 221, 255, 0.3);
            transform: scale(1.05);
            border-color: #00ff88;
        }
        
        .preset-item.active {
            background: rgba(0, 255, 136, 0.3);
            border: 2px solid #00ff88;
        }
        
        .preset-category {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        
        .preset-name {
            color: #00ddff;
            font-weight: bold;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            background: rgba(0, 221, 255, 0.2);
            color: #00ddff;
            border: 1px solid #00ddff;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #00ff88 0%, #00ddff 100%);
            color: #000;
            border-color: #00ff88;
        }
        
        .sequencer {
            margin: 20px 0;
        }
        
        .step-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        
        .step {
            aspect-ratio: 1;
            background: rgba(0, 221, 255, 0.1);
            border: 1px solid #00ddff;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .step.active {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .step.playing {
            border: 3px solid #ff00ff;
            box-shadow: 0 0 15px #ff00ff;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-item {
            background: rgba(255, 0, 255, 0.1);
            border-left: 4px solid #ff00ff;
            padding: 15px;
            border-radius: 5px;
        }
        
        .feature-title {
            color: #ff00ff;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.active {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .info-box {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .warning-box {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid #ffa500;
            color: #ffa500;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        
        footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 50px;
            border-top: 2px solid #00ff88;
            color: #888;
        }
        
        .log-output {
            background: #000;
            border: 1px solid #00ff88;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.85em;
            margin-top: 15px;
        }
        
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #222;
        }
        
        .log-success { color: #00ff88; }
        .log-error { color: #ff0055; }
        .log-info { color: #00ddff; }
        .log-warn { color: #ffa500; }
        
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .logo { max-width: 150px; }
            .synth-grid { grid-template-columns: 1fr; }
            .stats { flex-direction: column; gap: 20px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="/logo.png" alt="HAOS.fm Logo" class="logo">
        </div>
        <h1>HAOS.fm</h1>
        <div class="tagline">Professional Techno Sound Design Platform</div>
        <div class="stats">
            <div class="stat">
                <div class="stat-number">36</div>
                <div class="stat-label">Factory Presets</div>
            </div>
            <div class="stat">
                <div class="stat-number">3</div>
                <div class="stat-label">Classic Synthesizers</div>
            </div>
            <div class="stat">
                <div class="stat-number">100%</div>
                <div class="stat-label">Web Audio API</div>
            </div>
            <div class="stat">
                <div class="stat-number">‚àû</div>
                <div class="stat-label">Possibilities</div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- System Status -->
        <div class="section">
            <h2>üü¢ System Status</h2>
            <div class="info-box">
                <div><span class="status-indicator active"></span><strong>Audio Engine:</strong> <span id="audio-status">Initializing...</span></div>
                <div><span class="status-indicator active"></span><strong>Modules Loaded:</strong> <span id="modules-loaded">0/9</span></div>
                <div><span class="status-indicator active"></span><strong>Sample Rate:</strong> <span id="sample-rate">-</span> Hz</div>
                <div><span class="status-indicator active"></span><strong>Audio Context State:</strong> <span id="context-state">-</span></div>
            </div>
            <button id="init-audio" onclick="initializeAudio()">üîä Initialize Audio System</button>
            <button onclick="location.href='audio-test.html'">üß™ Advanced Test Page</button>
            <button onclick="location.href='haos-platform.html'">üéõÔ∏è Full Platform</button>
        </div>

        <!-- Real-time Audio Visualization -->
        <div class="section">
            <h2>üìä Real-time Audio Visualization</h2>
            <div class="visualizer-container">
                <h3>Waveform Oscilloscope</h3>
                <canvas id="waveform-canvas"></canvas>
            </div>
            <div class="visualizer-container">
                <h3>Frequency Spectrum Analyzer</h3>
                <canvas id="spectrum-canvas"></canvas>
            </div>
            <div class="controls">
                <button id="start-viz" onclick="startVisualization()">‚ñ∂Ô∏è Start Visualization</button>
                <button onclick="stopVisualization()">‚è∏Ô∏è Stop</button>
            </div>
        </div>

        <!-- Synthesizer Showcase -->
        <div class="section">
            <h2>üéπ Classic Synthesizers</h2>
            <div class="synth-grid">
                <!-- TB-303 -->
                <div class="synth-card">
                    <div class="synth-name">TB-303</div>
                    <div class="synth-description">Legendary acid bass synthesizer with resonant filter</div>
                    <div class="preset-count">17 Presets</div>
                    <div class="controls">
                        <label>Preset:</label>
                        <select id="tb303-preset" onchange="loadTB303Preset()">
                            <option>Loading...</option>
                        </select>
                    </div>
                    <div class="controls">
                        <label>Note:</label>
                        <select id="tb303-note">
                            <option value="C2">C2</option>
                            <option value="E2">E2</option>
                            <option value="G2">G2</option>
                            <option value="A2" selected>A2</option>
                            <option value="C3">C3</option>
                        </select>
                        <button onclick="playTB303()">‚ñ∂Ô∏è Play</button>
                    </div>
                    <div class="info-box" style="font-size: 0.85em;">
                        <strong>Current Settings:</strong><br>
                        Cutoff: <span id="tb303-cutoff">-</span> Hz | 
                        Resonance: <span id="tb303-res">-</span>% | 
                        Env Mod: <span id="tb303-env">-</span>
                    </div>
                </div>

                <!-- TR-909 -->
                <div class="synth-card">
                    <div class="synth-name">TR-909</div>
                    <div class="synth-description">Iconic techno drum machine with punchy analog sounds</div>
                    <div class="preset-count">9 Presets</div>
                    <div class="controls">
                        <label>Preset:</label>
                        <select id="tr909-preset" onchange="loadTR909Preset()">
                            <option>Loading...</option>
                        </select>
                    </div>
                    <div class="controls">
                        <button onclick="playTR909Kick()">ü•Å Kick</button>
                        <button onclick="playTR909Snare()">ü•Å Snare</button>
                        <button onclick="playTR909Hat()">ü•Å Hi-Hat</button>
                    </div>
                    <div class="info-box" style="font-size: 0.85em;">
                        <strong>BPM:</strong> <span id="tr909-bpm">128</span> | 
                        <strong>Style:</strong> <span id="tr909-style">Techno</span>
                    </div>
                </div>

                <!-- TR-808 -->
                <div class="synth-card">
                    <div class="synth-name">TR-808</div>
                    <div class="synth-description">Classic hip-hop drum machine with legendary bass</div>
                    <div class="preset-count">10 Presets</div>
                    <div class="controls">
                        <label>Preset:</label>
                        <select id="tr808-preset" onchange="loadTR808Preset()">
                            <option>Loading...</option>
                        </select>
                    </div>
                    <div class="controls">
                        <button onclick="playTR808Kick()">ü•Å Kick</button>
                        <button onclick="playTR808Snare()">ü•Å Snare</button>
                        <button onclick="playTR808Hat()">ü•Å Hi-Hat</button>
                    </div>
                    <div class="info-box" style="font-size: 0.85em;">
                        <strong>BPM:</strong> <span id="tr808-bpm">140</span> | 
                        <strong>Style:</strong> <span id="tr808-style">Trap</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preset Browser -->
        <div class="section">
            <h2>üé® Preset Browser</h2>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showPresetTab('tb303', event)">TB-303 (17)</button>
                <button class="tab-button" onclick="showPresetTab('tr909', event)">TR-909 (9)</button>
                <button class="tab-button" onclick="showPresetTab('tr808', event)">TR-808 (10)</button>
            </div>
            <div id="preset-browser-content">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- 16-Step Sequencer -->
        <div class="section">
            <h2>üéµ 16-Step Pattern Sequencer</h2>
            <div class="controls">
                <label>BPM:</label>
                <input type="range" id="seq-bpm" min="60" max="180" value="128" oninput="updateBPM(this.value)">
                <span class="value-display" id="bpm-display">128</span>
                
                <label>Pattern:</label>
                <select id="seq-pattern" onchange="loadPattern()">
                    <option value="techno">Techno Basic</option>
                    <option value="hard">Hard Techno</option>
                    <option value="minimal">Minimal</option>
                    <option value="trap">Trap</option>
                </select>
                
                <button onclick="playSequence()">‚ñ∂Ô∏è Play</button>
                <button onclick="stopSequence()">‚èπÔ∏è Stop</button>
            </div>
            
            <div class="sequencer">
                <h3>Kick Pattern</h3>
                <div class="step-grid" id="kick-steps"></div>
                
                <h3>Snare Pattern</h3>
                <div class="step-grid" id="snare-steps"></div>
                
                <h3>Hi-Hat Pattern</h3>
                <div class="step-grid" id="hat-steps"></div>
            </div>
        </div>

        <!-- Platform Features -->
        <div class="section">
            <h2>‚ú® Platform Capabilities</h2>
            <div class="feature-list">
                <div class="feature-item">
                    <div class="feature-title">üéõÔ∏è Modular Synthesis</div>
                    <div>Professional-grade TB-303, TR-909, and TR-808 emulation using Web Audio API</div>
                </div>
                <div class="feature-item">
                    <div class="feature-title">üé® 36 Factory Presets</div>
                    <div>Curated from TEKNO VST and OMNISPHERE documentation with authentic parameters</div>
                </div>
                <div class="feature-item">
                    <div class="feature-title">üìä Real-time Visualization</div>
                    <div>Waveform oscilloscope and frequency spectrum analyzer</div>
                </div>
                <div class="feature-item">
                    <div class="feature-title">üéµ Pattern Sequencer</div>
                    <div>16-step sequencer with BPM control and preset patterns</div>
                </div>
                <div class="feature-item">
                    <div class="feature-title">üîä Zero Latency</div>
                    <div>Browser-native synthesis with no external audio files</div>
                </div>
                <div class="feature-item">
                    <div class="feature-title">üíæ Preset Management</div>
                    <div>Organized by category: Classic, Bass, Lead, FX, Techno, Hip-Hop</div>
                </div>
            </div>
        </div>

        <!-- System Log -->
        <div class="section">
            <h2>üìù System Log</h2>
            <div class="log-output" id="system-log">
                <div class="log-entry log-info">System initialized - Ready for audio processing</div>
            </div>
        </div>
    </div>

    <footer>
        <p><strong>HAOS.fm</strong> - Professional Techno Sound Design Platform</p>
        <p>Powered by Web Audio API | No samples, pure synthesis</p>
        <p>¬© 2025 HAOS Suite | All modules loaded and functional</p>
    </footer>

    <!-- Load all modules -->
    <script src="/modules/core-audio-engine.js"></script>
    <script src="/js/synths/tb303.js"></script>
    <script src="/js/synths/tr909.js"></script>
    <script src="/js/synths/tr808.js"></script>
    <script src="/js/factory-presets.js"></script>
    <script src="/modules/bass-303.js"></script>
    <script src="/modules/sequencer.js"></script>
    <script src="/modules/pattern-library.js"></script>
    <script src="/js/preset-mapper.js"></script>

    <script>
        // Global state
        let audioInitialized = false;
        let tb303, tr909, tr808;
        let sequencer;
        let currentStep = 0;
        let sequencerInterval;
        let analyser, analyserData, analyserBuffer;
        let visualizationActive = false;
        let animationId;

        // Patterns
        const patterns = {
            techno: {
                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
                hat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0]
            },
            hard: {
                kick: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
                snare: [0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1],
                hat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            },
            minimal: {
                kick: [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
                hat: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0]
            },
            trap: {
                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0],
                snare: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
                hat: [1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1]
            }
        };

        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('system-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
            
            // Keep only last 50 entries
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // Initialize audio system
        async function initializeAudio() {
            try {
                if (audioInitialized) {
                    log('Audio already initialized', 'warn');
                    return;
                }

                log('Initializing HAOS.fm audio system...', 'info');
                
                // Initialize CoreAudioEngine
                if (typeof CoreAudioEngine === 'undefined') {
                    throw new Error('CoreAudioEngine not loaded');
                }
                
                const audioEngine = new CoreAudioEngine();
                await audioEngine.initialize();
                
                // Initialize synthesizers
                tb303 = new TB303Synth(audioEngine.context, audioEngine.masterGain);
                tr909 = new TR909Synth(audioEngine.context, audioEngine.masterGain);
                tr808 = new TR808Synth(audioEngine.context, audioEngine.masterGain);
                
                // Setup analyzer
                analyser = audioEngine.context.createAnalyser();
                analyser.fftSize = 2048;
                analyserBuffer = new Uint8Array(analyser.frequencyBinCount);
                analyserData = new Uint8Array(analyser.fftSize);
                audioEngine.masterGain.connect(analyser);
                
                audioInitialized = true;
                
                // Update status
                document.getElementById('audio-status').textContent = 'Active ‚úì';
                document.getElementById('modules-loaded').textContent = '9/9 ‚úì';
                document.getElementById('sample-rate').textContent = audioEngine.context.sampleRate;
                document.getElementById('context-state').textContent = audioEngine.context.state;
                
                // Load presets into dropdowns
                loadPresetDropdowns();
                
                // Initialize sequencer UI
                initSequencerUI();
                
                // Initialize preset browser
                showPresetTab('tb303');
                
                log('‚úì HAOS.fm system ready!', 'success');
                log(`‚úì TB-303 loaded with 17 presets`, 'success');
                log(`‚úì TR-909 loaded with 9 presets`, 'success');
                log(`‚úì TR-808 loaded with 10 presets`, 'success');
                
            } catch (error) {
                log(`‚úó Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Load presets into dropdowns
        function loadPresetDropdowns() {
            if (!window.FACTORY_PRESETS) {
                log('Factory presets not loaded', 'error');
                return;
            }

            // TB-303
            const tb303Select = document.getElementById('tb303-preset');
            tb303Select.innerHTML = '';
            FACTORY_PRESETS.tb303.forEach((preset, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${preset.name} (${preset.category})`;
                tb303Select.appendChild(option);
            });
            loadTB303Preset();

            // TR-909
            const tr909Select = document.getElementById('tr909-preset');
            tr909Select.innerHTML = '';
            FACTORY_PRESETS.tr909.forEach((preset, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${preset.name} (${preset.category})`;
                tr909Select.appendChild(option);
            });
            loadTR909Preset();

            // TR-808
            const tr808Select = document.getElementById('tr808-preset');
            tr808Select.innerHTML = '';
            FACTORY_PRESETS.tr808.forEach((preset, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${preset.name} (${preset.category})`;
                tr808Select.appendChild(option);
            });
            loadTR808Preset();
        }

        // Load TB-303 preset
        function loadTB303Preset() {
            const index = document.getElementById('tb303-preset').value;
            const preset = FACTORY_PRESETS.tb303[index];
            if (preset && preset.data && preset.data.params) {
                const p = preset.data.params;
                document.getElementById('tb303-cutoff').textContent = p.cutoff || '-';
                document.getElementById('tb303-res').textContent = p.resonance || '-';
                document.getElementById('tb303-env').textContent = p.envMod || '-';
                log(`Loaded TB-303: ${preset.name}`, 'info');
            }
        }

        // Load TR-909 preset
        function loadTR909Preset() {
            const index = document.getElementById('tr909-preset').value;
            const preset = FACTORY_PRESETS.tr909[index];
            if (preset) {
                document.getElementById('tr909-bpm').textContent = preset.bpm || preset.data?.bpm || 128;
                document.getElementById('tr909-style').textContent = preset.category || '-';
                log(`Loaded TR-909: ${preset.name}`, 'info');
            }
        }

        // Load TR-808 preset
        function loadTR808Preset() {
            const index = document.getElementById('tr808-preset').value;
            const preset = FACTORY_PRESETS.tr808[index];
            if (preset) {
                document.getElementById('tr808-bpm').textContent = preset.bpm || preset.data?.bpm || 140;
                document.getElementById('tr808-style').textContent = preset.category || '-';
                log(`Loaded TR-808: ${preset.name}`, 'info');
            }
        }

        // Play TB-303
        function playTB303() {
            if (!audioInitialized) {
                alert('Please initialize audio first!');
                return;
            }
            const note = document.getElementById('tb303-note').value;
            const index = document.getElementById('tb303-preset').value;
            const preset = FACTORY_PRESETS.tb303[index];
            
            if (preset && preset.data && preset.data.params) {
                tb303.playNote(note, preset.data.params);
                log(`üéµ ${note} - ${preset.name}`, 'success');
            }
        }

        // Play TR-909 sounds
        function playTR909Kick() {
            if (!audioInitialized) { alert('Please initialize audio first!'); return; }
            tr909.playKick();
            log('ü•Å TR-909 Kick', 'success');
        }

        function playTR909Snare() {
            if (!audioInitialized) { alert('Please initialize audio first!'); return; }
            tr909.playSnare();
            log('ü•Å TR-909 Snare', 'success');
        }

        function playTR909Hat() {
            if (!audioInitialized) { alert('Please initialize audio first!'); return; }
            tr909.playHatClosed();
            log('ü•Å TR-909 Hi-Hat', 'success');
        }

        // Play TR-808 sounds
        function playTR808Kick() {
            if (!audioInitialized) { alert('Please initialize audio first!'); return; }
            tr808.playKick();
            log('ü•Å TR-808 Kick', 'success');
        }

        function playTR808Snare() {
            if (!audioInitialized) { alert('Please initialize audio first!'); return; }
            tr808.playSnare();
            log('ü•Å TR-808 Snare', 'success');
        }

        function playTR808Hat() {
            if (!audioInitialized) { alert('Please initialize audio first!'); return; }
            tr808.playHatClosed();
            log('ü•Å TR-808 Hi-Hat', 'success');
        }

        // Preset browser
        function showPresetTab(synth, event) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            if (event) event.target.classList.add('active');
            else document.querySelector('.tab-button').classList.add('active');
            
            const content = document.getElementById('preset-browser-content');
            const presets = FACTORY_PRESETS[synth];
            
            content.innerHTML = '<div class="preset-browser"></div>';
            const browser = content.querySelector('.preset-browser');
            
            presets.forEach((preset, i) => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.innerHTML = `
                    <div class="preset-category">${preset.category}</div>
                    <div class="preset-name">${preset.name}</div>
                `;
                item.onclick = () => {
                    document.querySelectorAll('.preset-item').forEach(p => p.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Load preset in respective synth
                    const select = document.getElementById(`${synth}-preset`);
                    select.value = i;
                    if (synth === 'tb303') loadTB303Preset();
                    else if (synth === 'tr909') loadTR909Preset();
                    else if (synth === 'tr808') loadTR808Preset();
                };
                browser.appendChild(item);
            });
        }

        // Initialize sequencer UI
        function initSequencerUI() {
            createStepGrid('kick-steps');
            createStepGrid('snare-steps');
            createStepGrid('hat-steps');
            loadPattern();
        }

        function createStepGrid(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.dataset.step = i;
                step.onclick = () => toggleStep(containerId, i);
                container.appendChild(step);
            }
        }

        function toggleStep(containerId, step) {
            const stepEl = document.getElementById(containerId).children[step];
            stepEl.classList.toggle('active');
        }

        function loadPattern() {
            const patternName = document.getElementById('seq-pattern').value;
            const pattern = patterns[patternName];
            
            ['kick', 'snare', 'hat'].forEach(track => {
                const container = document.getElementById(`${track}-steps`);
                Array.from(container.children).forEach((step, i) => {
                    step.classList.toggle('active', pattern[track][i] === 1);
                });
            });
            
            log(`Pattern loaded: ${patternName}`, 'info');
        }

        function updateBPM(value) {
            document.getElementById('bpm-display').textContent = value;
        }

        function playSequence() {
            if (!audioInitialized) {
                alert('Please initialize audio first!');
                return;
            }
            
            stopSequence();
            const bpm = document.getElementById('seq-bpm').value;
            const stepTime = (60 / bpm) / 4 * 1000; // 16th notes
            
            currentStep = 0;
            log(`‚ñ∂Ô∏è Sequencer started (${bpm} BPM)`, 'success');
            
            sequencerInterval = setInterval(() => {
                // Clear previous playing state
                document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
                
                // Check each track
                const kickSteps = document.getElementById('kick-steps').children;
                const snareSteps = document.getElementById('snare-steps').children;
                const hatSteps = document.getElementById('hat-steps').children;
                
                // Highlight current step
                kickSteps[currentStep].classList.add('playing');
                snareSteps[currentStep].classList.add('playing');
                hatSteps[currentStep].classList.add('playing');
                
                // Play active steps
                if (kickSteps[currentStep].classList.contains('active')) {
                    tr909.playKick();
                }
                if (snareSteps[currentStep].classList.contains('active')) {
                    tr909.playSnare();
                }
                if (hatSteps[currentStep].classList.contains('active')) {
                    tr909.playHatClosed();
                }
                
                currentStep = (currentStep + 1) % 16;
            }, stepTime);
        }

        function stopSequence() {
            if (sequencerInterval) {
                clearInterval(sequencerInterval);
                sequencerInterval = null;
                document.querySelectorAll('.step').forEach(s => s.classList.remove('playing'));
                log('‚èπÔ∏è Sequencer stopped', 'info');
            }
        }

        // Visualization
        function startVisualization() {
            if (!audioInitialized) {
                alert('Please initialize audio first!');
                return;
            }
            
            visualizationActive = true;
            log('üìä Visualization started', 'success');
            drawWaveform();
            drawSpectrum();
        }

        function stopVisualization() {
            visualizationActive = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            log('‚è∏Ô∏è Visualization stopped', 'info');
        }

        function drawWaveform() {
            if (!visualizationActive) return;
            
            const canvas = document.getElementById('waveform-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            analyser.getByteTimeDomainData(analyserData);
            
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#00ff88';
            ctx.beginPath();
            
            const sliceWidth = canvas.width / analyserData.length;
            let x = 0;
            
            for (let i = 0; i < analyserData.length; i++) {
                const v = analyserData[i] / 128.0;
                const y = v * canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
            
            animationId = requestAnimationFrame(drawWaveform);
        }

        function drawSpectrum() {
            if (!visualizationActive) return;
            
            const canvas = document.getElementById('spectrum-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            analyser.getByteFrequencyData(analyserBuffer);
            
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / analyserBuffer.length) * 2.5;
            let x = 0;
            
            for (let i = 0; i < analyserBuffer.length; i++) {
                const barHeight = (analyserBuffer[i] / 255) * canvas.height;
                
                const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                gradient.addColorStop(0, '#ff00ff');
                gradient.addColorStop(0.5, '#00ddff');
                gradient.addColorStop(1, '#00ff88');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
            
            setTimeout(() => requestAnimationFrame(drawSpectrum), 50);
        }

        // Auto-initialize on load
        window.addEventListener('load', () => {
            log('HAOS.fm loaded - Click "Initialize Audio System" to begin', 'info');
        });
    </script>
</body>
</html>
