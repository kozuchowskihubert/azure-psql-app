<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="HAOS.fm Radio 24/7 - Non-stop techno and electronic music streaming with live visualization">
    <meta name="theme-color" content="#FF6B35">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HAOS.fm Radio">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/haos-logo-white.png">
    
    <title>üìª HAOS.fm - Radio 24/7</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- HAOS.fm Brand CSS -->
    <link rel="stylesheet" href="/css/haos-brand.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* HAOS.fm Radio Theme */
            --bg-primary: var(--haos-vinyl-black);
            --bg-secondary: var(--haos-tape-brown);
            --bg-tertiary: #2a2a2a;
            --bg-card: #1e1e1e;
            --accent-techno: var(--haos-acid-green);
            --accent-rap: #ff00ff;
            --accent-cyan: #00ffff;
            --accent-orange: #ff6b00;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #666;
            --border: #333;
            --success: #00ff41;
            --danger: #ff3366;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f0f1e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 255, 0, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 255, 0.05) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-techno);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, var(--accent-techno), var(--accent-cyan), var(--accent-rap), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(0, 255, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(255, 0, 255, 0.5)); }
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: var(--text-primary);
            text-decoration: none;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 5px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background: var(--accent-techno);
            color: var(--bg-primary);
            transform: translateY(-2px);
        }

        .nav-links a.active {
            background: linear-gradient(135deg, var(--accent-techno), var(--accent-rap));
            color: var(--bg-primary);
            font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Channel Selector */
        .channel-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .channel-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .channel-btn.techno {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: #000;
        }

        .channel-btn.rap {
            background: linear-gradient(135deg, #ff00ff, #cc00cc);
            color: #000;
        }

        .channel-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 30px currentColor;
        }

        .channel-btn:hover:not(.active) {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        /* Player Section */
        .player-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .now-playing {
            text-align: center;
            margin-bottom: 30px;
        }

        .now-playing h2 {
            color: var(--accent-cyan);
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .track-info {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .track-title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .track-artist {
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-techno), var(--accent-rap));
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s;
        }

        /* Player Controls */
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .control-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            background: var(--accent-techno);
            color: var(--bg-primary);
            transform: scale(1.05);
        }

        .control-btn.play-pause {
            padding: 20px 35px;
            font-size: 1.5em;
            background: linear-gradient(135deg, var(--accent-techno), var(--accent-rap));
            color: var(--bg-primary);
            font-weight: bold;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Volume Control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .volume-slider {
            width: 200px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-tertiary);
            border-radius: 10px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-techno);
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-techno);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Queue Section */
        .queue-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--border);
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .queue-header h2 {
            color: var(--accent-cyan);
            font-size: 1.5em;
        }

        .queue-stats {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .queue-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .queue-item {
            background: var(--bg-tertiary);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: move;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .queue-item:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-techno);
        }

        .queue-item.dragging {
            opacity: 0.5;
        }

        .queue-item.playing {
            border-color: var(--accent-rap);
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.1), rgba(255, 0, 255, 0.1));
        }

        .queue-number {
            font-weight: bold;
            color: var(--text-secondary);
            min-width: 30px;
        }

        .queue-track-info {
            flex: 1;
        }

        .queue-track-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .queue-track-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .queue-actions {
            display: flex;
            gap: 10px;
        }

        .queue-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .queue-btn:hover {
            background: var(--accent-techno);
            color: var(--bg-primary);
        }

        .queue-btn.danger:hover {
            background: var(--danger);
        }

        /* Upload Section */
        .upload-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--border);
        }

        .upload-section h2 {
            color: var(--accent-cyan);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-tertiary);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--accent-techno);
            background: rgba(0, 255, 0, 0.05);
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--accent-techno), var(--accent-rap));
            color: var(--bg-primary);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 255, 0, 0.5);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        /* Visualizer */
        .visualizer {
            height: 100px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        /* Stats */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent-techno);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-techno);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-rap);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .channel-selector {
                flex-direction: column;
            }

            .player-controls {
                flex-wrap: wrap;
            }

            .volume-control {
                width: 100%;
            }

            .volume-slider {
                flex: 1;
            }

            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto;">
            <div style="flex: 1;">
                <h1>üìª 24/7 MUSIC RADIO</h1>
                <p class="subtitle">Continuous Techno & Rap ‚Ä¢ Upload Tracks ‚Ä¢ Manage Queue</p>
            </div>
            <button id="theme-toggle" style="padding: 12px 18px; background: var(--bg-tertiary); border: 1px solid var(--accent-techno); border-radius: 8px; color: var(--text-primary); cursor: pointer; transition: all 0.3s; font-size: 1.2em;" aria-label="Toggle theme">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        
        <!-- Navigation -->
        <div class="nav-links">
            <a href="/">üè† Home</a>
            <a href="/trap-studio">üî• Trap Studio</a>
            <a href="/techno-creator">‚ö° Techno Creator</a>
            <a href="/radio" class="active">üìª Radio 24/7</a>
        </div>
    </div>

    <div class="container">
        <!-- Channel Selector -->
        <div class="channel-selector">
            <button class="channel-btn techno active" onclick="switchChannel('techno')">
                üéµ TECHNO RADIO
            </button>
            <button class="channel-btn rap" onclick="switchChannel('rap')">
                üé§ RAP RADIO
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalTracks">0</div>
                <div class="stat-label">Total Tracks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="queueLength">0</div>
                <div class="stat-label">In Queue</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalDuration">0:00</div>
                <div class="stat-label">Total Duration</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="listeners">1</div>
                <div class="stat-label">Listeners</div>
            </div>
        </div>

        <!-- Player Section -->
        <div class="player-section">
            <div class="now-playing">
                <h2>üéß NOW PLAYING</h2>
                <div class="track-info">
                    <div class="track-title" id="currentTitle">No track playing</div>
                    <div class="track-artist" id="currentArtist">Select a channel to start</div>
                </div>
            </div>

            <!-- Visualizer -->
            <div class="visualizer">
                <canvas id="visualizer"></canvas>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <!-- Player Controls -->
            <div class="player-controls">
                <button class="control-btn" onclick="previousTrack()" title="Previous">
                    ‚èÆÔ∏è Previous
                </button>
                <button class="control-btn play-pause" onclick="togglePlayPause()" id="playPauseBtn">
                    ‚ñ∂Ô∏è Play
                </button>
                <button class="control-btn" onclick="nextTrack()" title="Next">
                    ‚è≠Ô∏è Next
                </button>
                <button class="control-btn" onclick="toggleShuffle()" id="shuffleBtn" title="Shuffle">
                    üîÄ Shuffle
                </button>
                <button class="control-btn" onclick="toggleRepeat()" id="repeatBtn" title="Repeat">
                    üîÅ Repeat
                </button>
            </div>

            <!-- Volume Control -->
            <div class="volume-control">
                <span>üîà</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
                <span>üîä</span>
                <span id="volumeValue" style="margin-left: 10px; color: var(--text-secondary);">70%</span>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2>üì§ UPLOAD TRACKS</h2>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="audio/*" multiple>
                <div class="upload-icon">üéµ</div>
                <div class="upload-text">Click to upload or drag & drop</div>
                <div class="upload-hint">Supported formats: MP3, WAV, OGG, M4A</div>
            </div>
        </div>

        <!-- Queue Section -->
        <div class="queue-section">
            <div class="queue-header">
                <h2>üìã QUEUE</h2>
                <div class="queue-stats">
                    <span id="queueInfo">0 tracks</span>
                </div>
            </div>
            <div class="queue-list" id="queueList">
                <div class="empty-state">
                    <div class="empty-state-icon">üéµ</div>
                    <div class="empty-state-text">No tracks in queue. Upload some tracks to get started!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // RADIO 24/7 - MAIN APPLICATION
        // ============================================

        // State
        let currentChannel = 'techno';
        let isPlaying = false;
        let isShuffle = false;
        let isRepeat = false;
        let currentTrackIndex = -1;
        let audio = new Audio();
        let audioContext = null;
        let analyser = null;
        let dataArray = null;

        // Queue storage (separate for each channel)
        let technoQueue = [];
        let rapQueue = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeAudio();
            initializeUpload();
            initializeVisualizer();
            loadQueueFromStorage();
            updateUI();
            setupStudioIntegration();
        });

        // ============================================
        // STUDIO INTEGRATION
        // ============================================
        
        /**
         * Setup integration with Trap Studio and Techno Creator
         * Listens for exported beats and automatically adds them to queue
         */
        function setupStudioIntegration() {
            // Listen for Trap Studio exports
            window.addEventListener('trapStudioBeatExport', (event) => {
                const track = event.detail;
                console.log('Received beat from Trap Studio:', track);
                
                // Switch to Rap channel
                if (currentChannel !== 'rap') {
                    switchChannel('rap');
                }
                
                // Add track to rap queue
                addStudioTrackToQueue(track);
                
                // Show notification
                showNotification('üî• Trap Beat Added!', `"${track.title}" is now in the Rap Radio queue`);
            });
            
            // Listen for Techno Creator exports
            window.addEventListener('technoCreatorTrackExport', (event) => {
                const track = event.detail;
                console.log('Received track from Techno Creator:', track);
                
                // Switch to Techno channel
                if (currentChannel !== 'techno') {
                    switchChannel('techno');
                }
                
                // Add track to techno queue
                addStudioTrackToQueue(track);
                
                // Show notification
                showNotification('‚ö° Techno Track Added!', `"${track.title}" is now in the Techno Radio queue`);
            });
            
            // Listen for cross-window messages
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'ADD_TO_RADIO') {
                    const track = event.data.track;
                    console.log('Received track via postMessage:', track);
                    addStudioTrackToQueue(track);
                }
            });
        }

        /**
         * Add a track from studio to the queue
         */
        function addStudioTrackToQueue(track) {
            const queue = getCurrentQueue();
            
            // Create audio element to get duration
            const tempAudio = new Audio(track.url);
            
            tempAudio.addEventListener('loadedmetadata', () => {
                track.duration = tempAudio.duration;
                
                // Add to queue
                queue.push(track);
                setCurrentQueue(queue);
                
                // Save and update UI
                saveQueueToStorage();
                updateUI();
                
                // Auto-play if this is the first track and nothing is playing
                if (queue.length === 1 && !isPlaying) {
                    // Resume audio context (required for autoplay)
                    resumeAudioContext().then(() => {
                        playTrack(0);
                    }).catch(err => {
                        console.log('Autoplay blocked. User must click play button.');
                        // Show a friendly prompt
                        showPlayPrompt();
                    });
                }
            });
            
            tempAudio.addEventListener('error', () => {
                console.error('Failed to load track metadata');
                // Add anyway with 0 duration
                track.duration = 0;
                queue.push(track);
                setCurrentQueue(queue);
                saveQueueToStorage();
                updateUI();
                
                // Try to play if first track
                if (queue.length === 1 && !isPlaying) {
                    resumeAudioContext().then(() => {
                        playTrack(0);
                    }).catch(err => {
                        console.log('Autoplay blocked. User must click play button.');
                        showPlayPrompt();
                    });
                }
            });
        }

        /**
         * Resume audio context (required for autoplay on modern browsers)
         */
        function resumeAudioContext() {
            return new Promise((resolve, reject) => {
                if (!audioContext) {
                    // Initialize if not yet created
                    initializeVisualizer();
                }
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('Audio context resumed');
                        resolve();
                    }).catch(err => {
                        console.error('Failed to resume audio context:', err);
                        reject(err);
                    });
                } else {
                    resolve();
                }
            });
        }

        /**
         * Show a visual prompt for user to click play
         */
        function showPlayPrompt() {
            // Make the play button pulse/glow
            const playBtn = document.getElementById('playPauseBtn');
            playBtn.style.animation = 'pulse 1.5s ease-in-out infinite';
            
            // Show a tooltip/prompt
            const prompt = document.createElement('div');
            prompt.id = 'playPrompt';
            prompt.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, var(--accent-techno), var(--accent-rap));
                color: #000;
                padding: 30px 40px;
                border-radius: 15px;
                box-shadow: 0 20px 60px rgba(0, 255, 0, 0.6);
                z-index: 10000;
                font-size: 1.3em;
                font-weight: bold;
                text-align: center;
                animation: scaleIn 0.3s ease-out;
                cursor: pointer;
            `;
            
            prompt.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 15px;">üéµ</div>
                <div style="margin-bottom: 10px;">Track Added to Queue!</div>
                <div style="font-size: 0.8em; opacity: 0.9;">Click here or press Play to start listening</div>
            `;
            
            // Click to dismiss and play
            prompt.addEventListener('click', () => {
                document.body.removeChild(prompt);
                playBtn.style.animation = '';
                togglePlayPause();
            });
            
            document.body.appendChild(prompt);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (document.getElementById('playPrompt')) {
                    prompt.style.animation = 'scaleOut 0.3s ease-out';
                    setTimeout(() => {
                        if (document.body.contains(prompt)) {
                            document.body.removeChild(prompt);
                        }
                    }, 300);
                }
            }, 5000);
        }

        /**
         * Show notification toast
         */
        function showNotification(title, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--accent-techno), var(--accent-rap));
                color: #000;
                padding: 20px 30px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0, 255, 0, 0.5);
                z-index: 10000;
                font-weight: bold;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 1.2em; margin-bottom: 5px;">${title}</div>
                <div style="font-size: 0.9em; opacity: 0.8;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
            
            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                    box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
                }
                50% {
                    transform: scale(1.05);
                    box-shadow: 0 0 30px rgba(0, 255, 0, 1);
                }
            }
            
            @keyframes scaleIn {
                from {
                    transform: translate(-50%, -50%) scale(0.5);
                    opacity: 0;
                }
                to {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 1;
                }
            }
            
            @keyframes scaleOut {
                from {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 1;
                }
                to {
                    transform: translate(-50%, -50%) scale(0.5);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // ============================================
        // AUDIO INITIALIZATION
        // ============================================

        function initializeAudio() {
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', onTrackEnded);
            audio.addEventListener('loadedmetadata', onMetadataLoaded);
            audio.addEventListener('error', onAudioError);

            // Volume control
            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                audio.volume = volume;
                document.getElementById('volumeValue').textContent = e.target.value + '%';
            });

            // Progress bar seeking
            document.getElementById('progressBar').addEventListener('click', (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audio.currentTime = percent * audio.duration;
            });

            // Set initial volume
            audio.volume = 0.7;
        }

        function initializeVisualizer() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            // Audio context for visualization
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                analyser.fftSize = 256;
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
            }

            // Animation loop
            function draw() {
                requestAnimationFrame(draw);
                
                if (!analyser) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary');
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / dataArray.length) * 2.5;
                let x = 0;
                
                for (let i = 0; i < dataArray.length; i++) {
                    const barHeight = (dataArray[i] / 255) * canvas.height;
                    
                    const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                    if (currentChannel === 'techno') {
                        gradient.addColorStop(0, '#00ff00');
                        gradient.addColorStop(1, '#00cc00');
                    } else {
                        gradient.addColorStop(0, '#ff00ff');
                        gradient.addColorStop(1, '#cc00cc');
                    }
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }
            
            draw();
        }

        // ============================================
        // CHANNEL SWITCHING
        // ============================================

        function switchChannel(channel) {
            currentChannel = channel;
            
            // Update button states
            document.querySelectorAll('.channel-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.channel-btn.${channel}`).classList.add('active');
            
            // Stop current playback
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
            }
            
            // Reset track index
            currentTrackIndex = -1;
            
            // Update UI
            updateUI();
            
            // Auto-play if queue has tracks
            if (getCurrentQueue().length > 0) {
                playTrack(0);
            }
        }

        function getCurrentQueue() {
            return currentChannel === 'techno' ? technoQueue : rapQueue;
        }

        function setCurrentQueue(queue) {
            if (currentChannel === 'techno') {
                technoQueue = queue;
            } else {
                rapQueue = queue;
            }
        }

        // ============================================
        // PLAYBACK CONTROLS
        // ============================================

        function togglePlayPause() {
            const queue = getCurrentQueue();
            
            if (queue.length === 0) {
                alert('No tracks in queue. Please upload some tracks first!');
                return;
            }
            
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                document.getElementById('playPauseBtn').innerHTML = '‚ñ∂Ô∏è Play';
            } else {
                // Resume audio context first (handles autoplay policy)
                resumeAudioContext().then(() => {
                    if (currentTrackIndex === -1) {
                        playTrack(0);
                    } else {
                        audio.play().then(() => {
                            isPlaying = true;
                            document.getElementById('playPauseBtn').innerHTML = '‚è∏Ô∏è Pause';
                        }).catch(err => {
                            console.error('Play error:', err);
                            alert('Unable to play. Please try again.');
                        });
                    }
                }).catch(err => {
                    console.error('Audio context error:', err);
                    // Try to play anyway
                    if (currentTrackIndex === -1) {
                        playTrack(0);
                    } else {
                        audio.play();
                        isPlaying = true;
                        document.getElementById('playPauseBtn').innerHTML = '‚è∏Ô∏è Pause';
                    }
                });
            }
        }

        function playTrack(index) {
            const queue = getCurrentQueue();
            
            if (index < 0 || index >= queue.length) return;
            
            currentTrackIndex = index;
            const track = queue[index];
            
            // Remove play prompt if exists
            const playPrompt = document.getElementById('playPrompt');
            if (playPrompt && document.body.contains(playPrompt)) {
                document.body.removeChild(playPrompt);
            }
            
            // Remove pulse animation from play button
            const playBtn = document.getElementById('playPauseBtn');
            if (playBtn) {
                playBtn.style.animation = '';
            }
            
            // Load and play
            audio.src = track.url;
            audio.play().then(() => {
                isPlaying = true;
                document.getElementById('playPauseBtn').innerHTML = '‚è∏Ô∏è Pause';
                updateNowPlaying(track);
                updateQueueUI();
            }).catch(err => {
                console.error('Playback error:', err);
                
                // More user-friendly error handling
                if (err.name === 'NotAllowedError') {
                    console.log('Autoplay not allowed. Showing play prompt.');
                    showPlayPrompt();
                } else {
                    alert('Error playing track. Please try another file.');
                }
            });
        }

        function previousTrack() {
            const queue = getCurrentQueue();
            if (queue.length === 0) return;
            
            let newIndex = currentTrackIndex - 1;
            if (newIndex < 0) newIndex = queue.length - 1;
            
            playTrack(newIndex);
        }

        function nextTrack() {
            const queue = getCurrentQueue();
            if (queue.length === 0) return;
            
            let newIndex;
            if (isShuffle) {
                newIndex = Math.floor(Math.random() * queue.length);
            } else {
                newIndex = currentTrackIndex + 1;
                if (newIndex >= queue.length) {
                    newIndex = isRepeat ? 0 : currentTrackIndex;
                }
            }
            
            if (newIndex !== currentTrackIndex) {
                playTrack(newIndex);
            } else if (!isRepeat) {
                audio.pause();
                isPlaying = false;
                document.getElementById('playPauseBtn').innerHTML = '‚ñ∂Ô∏è Play';
            }
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            const btn = document.getElementById('shuffleBtn');
            if (isShuffle) {
                btn.style.background = 'var(--accent-techno)';
                btn.style.color = 'var(--bg-primary)';
            } else {
                btn.style.background = '';
                btn.style.color = '';
            }
        }

        function toggleRepeat() {
            isRepeat = !isRepeat;
            const btn = document.getElementById('repeatBtn');
            if (isRepeat) {
                btn.style.background = 'var(--accent-techno)';
                btn.style.color = 'var(--bg-primary)';
            } else {
                btn.style.background = '';
                btn.style.color = '';
            }
        }

        function onTrackEnded() {
            nextTrack();
        }

        function onMetadataLoaded() {
            updateProgress();
        }

        function onAudioError(e) {
            console.error('Audio error:', e);
            nextTrack();
        }

        // ============================================
        // UI UPDATES
        // ============================================

        function updateNowPlaying(track) {
            document.getElementById('currentTitle').textContent = track.title;
            document.getElementById('currentArtist').textContent = track.artist || 'Unknown Artist';
        }

        function updateProgress() {
            const current = formatTime(audio.currentTime);
            const total = formatTime(audio.duration);
            
            document.getElementById('currentTime').textContent = current;
            document.getElementById('duration').textContent = total;
            
            const percent = (audio.currentTime / audio.duration) * 100 || 0;
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateUI() {
            updateStats();
            updateQueueUI();
        }

        function updateStats() {
            const allTracks = technoQueue.length + rapQueue.length;
            const queueLength = getCurrentQueue().length;
            const totalDuration = getCurrentQueue().reduce((sum, track) => sum + (track.duration || 0), 0);
            
            document.getElementById('totalTracks').textContent = allTracks;
            document.getElementById('queueLength').textContent = queueLength;
            document.getElementById('totalDuration').textContent = formatTime(totalDuration);
        }

        function updateQueueUI() {
            const queue = getCurrentQueue();
            const queueList = document.getElementById('queueList');
            const queueInfo = document.getElementById('queueInfo');
            
            queueInfo.textContent = `${queue.length} track${queue.length !== 1 ? 's' : ''}`;
            
            if (queue.length === 0) {
                queueList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéµ</div>
                        <div class="empty-state-text">No tracks in queue. Upload some tracks to get started!</div>
                    </div>
                `;
                return;
            }
            
            queueList.innerHTML = queue.map((track, index) => `
                <div class="queue-item ${index === currentTrackIndex ? 'playing' : ''}" draggable="true" data-index="${index}">
                    <div class="queue-number">${index + 1}</div>
                    <div class="queue-track-info">
                        <div class="queue-track-title">${track.title}</div>
                        <div class="queue-track-meta">${track.artist || 'Unknown'} ‚Ä¢ ${formatTime(track.duration)}</div>
                    </div>
                    <div class="queue-actions">
                        <button class="queue-btn" onclick="playTrack(${index})" title="Play">‚ñ∂Ô∏è</button>
                        <button class="queue-btn danger" onclick="removeFromQueue(${index})" title="Remove">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            // Add drag and drop handlers
            setupDragAndDrop();
        }

        // ============================================
        // FILE UPLOAD
        // ============================================

        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            // File input
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('audio/')) {
                    addTrackToQueue(file);
                } else {
                    console.warn('Skipped non-audio file:', file.name);
                }
            });
            
            // Clear input
            document.getElementById('fileInput').value = '';
        }

        function addTrackToQueue(file) {
            const url = URL.createObjectURL(file);
            const tempAudio = new Audio(url);
            
            tempAudio.addEventListener('loadedmetadata', () => {
                const track = {
                    id: Date.now() + Math.random(),
                    title: file.name.replace(/\.[^/.]+$/, ''),
                    artist: currentChannel === 'techno' ? 'Techno Artist' : 'Rap Artist',
                    duration: tempAudio.duration,
                    url: url,
                    file: file,
                    channel: currentChannel
                };
                
                const queue = getCurrentQueue();
                queue.push(track);
                setCurrentQueue(queue);
                
                saveQueueToStorage();
                updateUI();
                
                // Auto-play if this is the first track
                if (queue.length === 1 && !isPlaying) {
                    playTrack(0);
                }
            });
        }

        function removeFromQueue(index) {
            const queue = getCurrentQueue();
            
            // Revoke object URL to free memory
            if (queue[index].url.startsWith('blob:')) {
                URL.revokeObjectURL(queue[index].url);
            }
            
            queue.splice(index, 1);
            setCurrentQueue(queue);
            
            // Adjust current track index
            if (index < currentTrackIndex) {
                currentTrackIndex--;
            } else if (index === currentTrackIndex) {
                if (isPlaying) {
                    if (queue.length > 0) {
                        playTrack(Math.min(currentTrackIndex, queue.length - 1));
                    } else {
                        audio.pause();
                        isPlaying = false;
                        currentTrackIndex = -1;
                    }
                }
            }
            
            saveQueueToStorage();
            updateUI();
        }

        // ============================================
        // DRAG AND DROP REORDERING
        // ============================================

        let draggedIndex = null;

        function setupDragAndDrop() {
            const items = document.querySelectorAll('.queue-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropIndex = parseInt(e.currentTarget.dataset.index);
            
            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                const queue = getCurrentQueue();
                const draggedItem = queue[draggedIndex];
                
                queue.splice(draggedIndex, 1);
                queue.splice(dropIndex, 0, draggedItem);
                
                // Adjust current track index
                if (currentTrackIndex === draggedIndex) {
                    currentTrackIndex = dropIndex;
                } else if (draggedIndex < currentTrackIndex && dropIndex >= currentTrackIndex) {
                    currentTrackIndex--;
                } else if (draggedIndex > currentTrackIndex && dropIndex <= currentTrackIndex) {
                    currentTrackIndex++;
                }
                
                setCurrentQueue(queue);
                saveQueueToStorage();
                updateUI();
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIndex = null;
        }

        // ============================================
        // STORAGE
        // ============================================

        function saveQueueToStorage() {
            // Note: Object URLs can't be persisted, so we save metadata only
            // In a real app, you'd upload files to a server
            const technoMeta = technoQueue.map(t => ({
                id: t.id,
                title: t.title,
                artist: t.artist,
                duration: t.duration,
                channel: t.channel
            }));
            
            const rapMeta = rapQueue.map(t => ({
                id: t.id,
                title: t.title,
                artist: t.artist,
                duration: t.duration,
                channel: t.channel
            }));
            
            localStorage.setItem('technoQueue', JSON.stringify(technoMeta));
            localStorage.setItem('rapQueue', JSON.stringify(rapMeta));
        }

        function loadQueueFromStorage() {
            // Note: Can't restore object URLs from localStorage
            // This is a limitation - in production, files would be on a server
            try {
                const technoMeta = JSON.parse(localStorage.getItem('technoQueue') || '[]');
                const rapMeta = JSON.parse(localStorage.getItem('rapQueue') || '[]');
                
                // We can't restore the actual files, so queues start empty
                // In production, you'd fetch from server here
                updateUI();
            } catch (e) {
                console.error('Error loading queue:', e);
            }
        }
    </script>

    <!-- Theme Manager Script -->
    <script src="/js/theme-manager.js"></script>
    <script>
        // Initialize theme manager
        const themeManager = new ThemeManager({
            toggleButtonId: 'theme-toggle',
            showToast: true
        });
        themeManager.init();
    </script>

</body>
</html>
