<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Collaborative Recording Studio - Record rap songs with multiple artists in real-time">
    <meta name="theme-color" content="#8b5cf6">
    
    <title>üé§ Collaborative Recording Studio üé§</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --accent-primary: #8b5cf6;
            --accent-secondary: #ec4899;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border: #374151;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Header */
        .header {
            position: relative;
            z-index: 10;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--accent-primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
        }

        /* Section Styles */
        .section {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .section-header h2 {
            font-size: 1.8em;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin-left: auto;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--accent-success);
            color: var(--accent-success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--accent-danger);
            color: var(--accent-danger);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        .status-dot.connected {
            background: var(--accent-success);
        }

        .status-dot.disconnected {
            background: var(--accent-danger);
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Room Management */
        .room-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-group label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9em;
        }

        .input-group input {
            padding: 12px 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-success {
            background: var(--accent-success);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Active Users */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .user-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .user-card.recording {
            border-color: var(--accent-danger);
            animation: recording-pulse 1s ease-in-out infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
        }

        .user-info {
            flex-grow: 1;
        }

        .user-name {
            font-weight: bold;
            color: var(--text-primary);
        }

        .user-track {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .user-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-success);
        }

        .user-status.recording {
            background: var(--accent-danger);
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Track Assignment */
        .tracks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .track-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .track-card.assigned {
            border-color: var(--accent-primary);
        }

        .track-card.recording {
            border-color: var(--accent-danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .track-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .track-name {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .track-duration {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .track-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .track-controls .btn {
            flex: 1;
            font-size: 0.9em;
            padding: 10px;
        }

        /* Waveform Visualization */
        .waveform {
            width: 100%;
            height: 60px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .waveform canvas {
            width: 100%;
            height: 100%;
        }

        /* Recording Controls */
        .recording-panel {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 2px solid var(--accent-primary);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .recording-timer {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent-primary);
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .recording-timer.active {
            color: var(--accent-danger);
            animation: pulse 1s ease-in-out infinite;
        }

        .recording-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .recording-controls .btn {
            min-width: 150px;
            font-size: 1.1em;
        }

        /* Beat Player */
        .beat-player {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .beat-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .beat-info {
            flex-grow: 1;
        }

        .beat-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .beat-meta {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        /* Chat/Messages */
        .chat-container {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--accent-primary);
            border-radius: 4px;
        }

        .chat-message-user {
            font-weight: bold;
            color: var(--accent-primary);
            margin-bottom: 4px;
        }

        .chat-message-text {
            color: var(--text-primary);
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 10px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .room-controls {
                grid-template-columns: 1fr;
            }

            .users-grid {
                grid-template-columns: 1fr;
            }

            .tracks-grid {
                grid-template-columns: 1fr;
            }

            .recording-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üé§ Collaborative Recording Studio üé§</h1>
        <p>Record rap songs with multiple artists in real-time</p>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Connection & Room Section -->
        <div class="section">
            <div class="section-header">
                <h2>
                    <span>üåê</span>
                    Session Management
                </h2>
                <div id="connectionStatus" class="connection-status disconnected">
                    <div class="status-dot disconnected"></div>
                    <span>Disconnected</span>
                </div>
            </div>

            <div class="room-controls">
                <div class="input-group">
                    <label for="usernameInput">Your Name</label>
                    <input type="text" id="usernameInput" placeholder="Enter your artist name..." maxlength="20">
                </div>

                <div class="input-group">
                    <label for="roomInput">Room Code</label>
                    <input type="text" id="roomInput" placeholder="Enter or create room code..." maxlength="20">
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="createRoom()">
                    <span>‚ûï</span> Create New Room
                </button>
                <button class="btn btn-success" onclick="joinRoom()">
                    <span>üö™</span> Join Room
                </button>
                <button class="btn btn-danger" onclick="leaveRoom()" disabled id="leaveBtn">
                    <span>üö™</span> Leave Room
                </button>
            </div>
        </div>

        <!-- Active Users Section -->
        <div class="section" id="usersSection" style="display: none;">
            <div class="section-header">
                <h2>
                    <span>üë•</span>
                    Active Artists (<span id="userCount">0</span>)
                </h2>
            </div>
            <div id="usersGrid" class="users-grid">
                <!-- Users will be populated here -->
            </div>
        </div>

        <!-- Beat Player Section -->
        <div class="section" id="beatSection" style="display: none;">
            <div class="section-header">
                <h2>
                    <span>üéµ</span>
                    Beat Player
                </h2>
            </div>

            <div class="beat-player">
                <div class="beat-controls">
                    <button class="btn btn-primary" onclick="playBeat()" id="playBeatBtn">
                        <span>‚ñ∂Ô∏è</span> Play
                    </button>
                    <button class="btn btn-danger" onclick="stopBeat()" id="stopBeatBtn" disabled>
                        <span>‚èπÔ∏è</span> Stop
                    </button>
                    <div class="beat-info">
                        <div class="beat-title" id="beatTitle">No beat loaded</div>
                        <div class="beat-meta" id="beatMeta">Select a beat to begin</div>
                    </div>
                    <button class="btn btn-primary" onclick="selectBeat()">
                        <span>üìÇ</span> Select Beat
                    </button>
                </div>
            </div>
        </div>

        <!-- Recording Section -->
        <div class="section" id="recordingSection" style="display: none;">
            <div class="section-header">
                <h2>
                    <span>üéôÔ∏è</span>
                    Recording Controls
                </h2>
            </div>

            <div class="recording-panel">
                <div class="recording-timer" id="recordingTimer">00:00</div>
                <div class="recording-controls">
                    <button class="btn btn-success" onclick="startRecording()" id="recordBtn">
                        <span>üî¥</span> Start Recording
                    </button>
                    <button class="btn btn-danger" onclick="stopRecording()" id="stopRecordBtn" disabled>
                        <span>‚èπÔ∏è</span> Stop Recording
                    </button>
                    <button class="btn btn-primary" onclick="downloadRecording()" id="downloadBtn" disabled>
                        <span>üíæ</span> Download
                    </button>
                </div>
            </div>
        </div>

        <!-- Tracks Section -->
        <div class="section" id="tracksSection" style="display: none;">
            <div class="section-header">
                <h2>
                    <span>üéöÔ∏è</span>
                    Track Assignment
                </h2>
            </div>

            <div id="tracksGrid" class="tracks-grid">
                <!-- Tracks will be populated here -->
            </div>
        </div>

        <!-- Chat Section -->
        <div class="section" id="chatSection" style="display: none;">
            <div class="section-header">
                <h2>
                    <span>üí¨</span>
                    Session Chat
                </h2>
            </div>

            <div class="chat-container">
                <div id="chatMessages" class="chat-messages">
                    <div class="chat-message">
                        <div class="chat-message-user">System</div>
                        <div class="chat-message-text">Welcome to the collaborative studio! Connect to start.</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." maxlength="200">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <span>üì§</span> Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        
        let ws = null;
        let currentRoom = null;
        let currentUser = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let timerInterval = null;
        let audioContext = null;
        let beatAudio = null;
        let localStream = null;

        const users = new Map();
        const tracks = [
            { id: 'verse1', name: 'Verse 1', assignedTo: null, recording: false, audioUrl: null },
            { id: 'verse2', name: 'Verse 2', assignedTo: null, recording: false, audioUrl: null },
            { id: 'verse3', name: 'Verse 3', assignedTo: null, recording: false, audioUrl: null },
            { id: 'hook', name: 'Hook/Chorus', assignedTo: null, recording: false, audioUrl: null },
            { id: 'bridge', name: 'Bridge', assignedTo: null, recording: false, audioUrl: null },
            { id: 'outro', name: 'Outro', assignedTo: null, recording: false, audioUrl: null }
        ];

        // ============================================
        // WEBSOCKET CONNECTION
        // ============================================
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000); // Reconnect after 3s
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'room_created':
                    onRoomCreated(data);
                    break;
                case 'room_joined':
                    onRoomJoined(data);
                    break;
                case 'user_joined':
                    onUserJoined(data);
                    break;
                case 'user_left':
                    onUserLeft(data);
                    break;
                case 'recording_started':
                    onRecordingStarted(data);
                    break;
                case 'recording_stopped':
                    onRecordingStopped(data);
                    break;
                case 'track_assigned':
                    onTrackAssigned(data);
                    break;
                case 'chat_message':
                    onChatMessage(data);
                    break;
                case 'beat_changed':
                    onBeatChanged(data);
                    break;
            }
        }

        function sendWebSocketMessage(type, data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, ...data }));
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const dotEl = statusEl.querySelector('.status-dot');
            const textEl = statusEl.querySelector('span');
            
            if (connected) {
                statusEl.className = 'connection-status connected';
                dotEl.className = 'status-dot connected';
                textEl.textContent = 'Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                dotEl.className = 'status-dot disconnected';
                textEl.textContent = 'Disconnected';
            }
        }

        // ============================================
        // ROOM MANAGEMENT
        // ============================================
        
        function createRoom() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Please enter your name first!');
                return;
            }
            
            const roomCode = generateRoomCode();
            document.getElementById('roomInput').value = roomCode;
            
            currentUser = {
                id: generateId(),
                name: username,
                isHost: true
            };
            
            currentRoom = roomCode;
            
            sendWebSocketMessage('create_room', {
                roomCode,
                user: currentUser
            });
            
            showSessionSections();
            addChatMessage('System', `Room created: ${roomCode}`);
        }

        function joinRoom() {
            const username = document.getElementById('usernameInput').value.trim();
            const roomCode = document.getElementById('roomInput').value.trim();
            
            if (!username || !roomCode) {
                alert('Please enter your name and room code!');
                return;
            }
            
            currentUser = {
                id: generateId(),
                name: username,
                isHost: false
            };
            
            currentRoom = roomCode;
            
            sendWebSocketMessage('join_room', {
                roomCode,
                user: currentUser
            });
        }

        function leaveRoom() {
            if (!currentRoom || !currentUser) return;
            
            sendWebSocketMessage('leave_room', {
                roomCode: currentRoom,
                userId: currentUser.id
            });
            
            resetSession();
        }

        function resetSession() {
            currentRoom = null;
            currentUser = null;
            users.clear();
            tracks.forEach(track => {
                track.assignedTo = null;
                track.recording = false;
                track.audioUrl = null;
            });
            
            hideSessionSections();
            document.getElementById('usernameInput').value = '';
            document.getElementById('roomInput').value = '';
        }

        function showSessionSections() {
            document.getElementById('usersSection').style.display = 'block';
            document.getElementById('beatSection').style.display = 'block';
            document.getElementById('recordingSection').style.display = 'block';
            document.getElementById('tracksSection').style.display = 'block';
            document.getElementById('chatSection').style.display = 'block';
            document.getElementById('leaveBtn').disabled = false;
            
            updateUsersDisplay();
            updateTracksDisplay();
        }

        function hideSessionSections() {
            document.getElementById('usersSection').style.display = 'none';
            document.getElementById('beatSection').style.display = 'none';
            document.getElementById('recordingSection').style.display = 'none';
            document.getElementById('tracksSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('leaveBtn').disabled = true;
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        function onRoomCreated(data) {
            showSessionSections();
            addChatMessage('System', `Welcome! Share room code: ${currentRoom}`);
        }

        function onRoomJoined(data) {
            showSessionSections();
            data.users.forEach(user => {
                users.set(user.id, user);
            });
            updateUsersDisplay();
            addChatMessage('System', `Joined room: ${currentRoom}`);
        }

        function onUserJoined(data) {
            users.set(data.user.id, data.user);
            updateUsersDisplay();
            addChatMessage('System', `${data.user.name} joined the session`);
        }

        function onUserLeft(data) {
            const user = users.get(data.userId);
            if (user) {
                users.delete(data.userId);
                updateUsersDisplay();
                addChatMessage('System', `${user.name} left the session`);
            }
        }

        function onRecordingStarted(data) {
            const user = users.get(data.userId);
            if (user) {
                user.recording = true;
                updateUsersDisplay();
                addChatMessage('System', `${user.name} started recording`);
            }
        }

        function onRecordingStopped(data) {
            const user = users.get(data.userId);
            if (user) {
                user.recording = false;
                updateUsersDisplay();
                addChatMessage('System', `${user.name} stopped recording`);
            }
        }

        function onTrackAssigned(data) {
            const track = tracks.find(t => t.id === data.trackId);
            if (track) {
                track.assignedTo = data.userId;
                updateTracksDisplay();
                
                const user = users.get(data.userId);
                if (user) {
                    addChatMessage('System', `${user.name} assigned to ${track.name}`);
                }
            }
        }

        function onChatMessage(data) {
            addChatMessage(data.username, data.message);
        }

        function onBeatChanged(data) {
            document.getElementById('beatTitle').textContent = data.beatName;
            document.getElementById('beatMeta').textContent = `${data.bpm} BPM | ${data.key}`;
            addChatMessage('System', `Beat changed to: ${data.beatName}`);
        }

        // ============================================
        // UI UPDATES
        // ============================================
        
        function updateUsersDisplay() {
            const grid = document.getElementById('usersGrid');
            const count = document.getElementById('userCount');
            
            grid.innerHTML = '';
            count.textContent = users.size;
            
            users.forEach(user => {
                const card = document.createElement('div');
                card.className = `user-card ${user.recording ? 'recording' : ''}`;
                card.innerHTML = `
                    <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${user.name}${user.isHost ? ' üëë' : ''}</div>
                        <div class="user-track">${getUserTrack(user.id)}</div>
                    </div>
                    <div class="user-status ${user.recording ? 'recording' : ''}"></div>
                `;
                grid.appendChild(card);
            });
        }

        function getUserTrack(userId) {
            const track = tracks.find(t => t.assignedTo === userId);
            return track ? track.name : 'No track assigned';
        }

        function updateTracksDisplay() {
            const grid = document.getElementById('tracksGrid');
            grid.innerHTML = '';
            
            tracks.forEach(track => {
                const card = document.createElement('div');
                card.className = `track-card ${track.assignedTo ? 'assigned' : ''} ${track.recording ? 'recording' : ''}`;
                
                const assignedUser = track.assignedTo ? users.get(track.assignedTo) : null;
                
                card.innerHTML = `
                    <div class="track-header">
                        <div class="track-name">${track.name}</div>
                        <div class="track-duration">0:00</div>
                    </div>
                    <div class="waveform">
                        <canvas id="waveform-${track.id}"></canvas>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 10px;">
                        ${assignedUser ? `Assigned to: ${assignedUser.name}` : 'Not assigned'}
                    </div>
                    <div class="track-controls">
                        <button class="btn btn-primary" onclick="assignTrack('${track.id}')" 
                                ${track.assignedTo ? 'disabled' : ''}>
                            ${track.assignedTo ? '‚úì Assigned' : 'üìå Take This'}
                        </button>
                        ${track.audioUrl ? `
                            <button class="btn btn-success" onclick="playTrack('${track.id}')">
                                ‚ñ∂Ô∏è Play
                            </button>
                        ` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // ============================================
        // RECORDING FUNCTIONS
        // ============================================
        
        async function startRecording() {
            try {
                // Request microphone permission
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(localStream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Find user's assigned track and save audio
                    const myTrack = tracks.find(t => t.assignedTo === currentUser.id);
                    if (myTrack) {
                        myTrack.audioUrl = audioUrl;
                        updateTracksDisplay();
                    }
                    
                    document.getElementById('downloadBtn').disabled = false;
                };
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                startRecordingTimer();
                
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopRecordBtn').disabled = false;
                
                sendWebSocketMessage('recording_started', {
                    roomCode: currentRoom,
                    userId: currentUser.id
                });
                
                addChatMessage('System', 'Recording started!');
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Failed to access microphone. Please grant permission.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                localStream.getTracks().forEach(track => track.stop());
                
                stopRecordingTimer();
                
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('stopRecordBtn').disabled = true;
                
                sendWebSocketMessage('recording_stopped', {
                    roomCode: currentRoom,
                    userId: currentUser.id
                });
                
                addChatMessage('System', 'Recording stopped!');
            }
        }

        function startRecordingTimer() {
            const timerEl = document.getElementById('recordingTimer');
            timerEl.classList.add('active');
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopRecordingTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('recordingTimer').classList.remove('active');
        }

        function downloadRecording() {
            if (audioChunks.length === 0) return;
            
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const url = URL.createObjectURL(audioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `recording-${currentUser.name}-${Date.now()}.wav`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // TRACK MANAGEMENT
        // ============================================
        
        function assignTrack(trackId) {
            if (!currentUser) return;
            
            const track = tracks.find(t => t.id === trackId);
            if (track && !track.assignedTo) {
                track.assignedTo = currentUser.id;
                updateTracksDisplay();
                
                sendWebSocketMessage('track_assigned', {
                    roomCode: currentRoom,
                    trackId,
                    userId: currentUser.id
                });
            }
        }

        function playTrack(trackId) {
            const track = tracks.find(t => t.id === trackId);
            if (track && track.audioUrl) {
                const audio = new Audio(track.audioUrl);
                audio.play();
            }
        }

        // ============================================
        // BEAT PLAYER
        // ============================================
        
        function playBeat() {
            // For now, we'll use a placeholder
            // In production, integrate with trap-studio beat generation
            document.getElementById('playBeatBtn').disabled = true;
            document.getElementById('stopBeatBtn').disabled = false;
            addChatMessage('System', 'Beat playback started');
        }

        function stopBeat() {
            document.getElementById('playBeatBtn').disabled = false;
            document.getElementById('stopBeatBtn').disabled = true;
            addChatMessage('System', 'Beat playback stopped');
        }

        function selectBeat() {
            // Integration point with trap-studio.html
            alert('Beat selection coming soon! Will integrate with Trap Studio.');
        }

        // ============================================
        // CHAT
        // ============================================
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && currentUser && currentRoom) {
                sendWebSocketMessage('chat_message', {
                    roomCode: currentRoom,
                    userId: currentUser.id,
                    username: currentUser.name,
                    message
                });
                
                input.value = '';
            }
        }

        function addChatMessage(username, message) {
            const messagesEl = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';
            messageEl.innerHTML = `
                <div class="chat-message-user">${username}</div>
                <div class="chat-message-text">${message}</div>
            `;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Allow Enter to send chat
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ============================================
        // UTILITIES
        // ============================================
        
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            
            // Show welcome message
            setTimeout(() => {
                addChatMessage('System', 'Welcome to the Collaborative Recording Studio! Create or join a room to start.');
            }, 1000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentRoom && currentUser) {
                leaveRoom();
            }
        });
    </script>
</body>
</html>
