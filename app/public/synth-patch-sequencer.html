<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAOS.fm - Patch Sequencer | Visual Routing System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Home Link */
        .home-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #FF6B35;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            transition: opacity 0.3s;
        }

        .home-link:hover {
            opacity: 0.7;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 107, 53, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FF6B35, #FF8C42);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #888;
            font-size: 0.9em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .preset-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: left;
        }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .preset-btn.active {
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .preset-name {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .preset-desc {
            font-size: 0.75em;
            opacity: 0.8;
        }

        .patch-matrix {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .patch-cable {
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid #666;
            font-family: monospace;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .patch-cable.active {
            background: rgba(0, 212, 255, 0.2);
            border-left-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .sequencer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: scale(1.05);
        }

        .control-btn.play {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .control-btn.stop {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .step-display {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 5px;
            margin: 15px 0;
        }

        .step {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            transition: all 0.2s ease;
            position: relative;
        }

        .step.active {
            background: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.6);
            transform: scale(1.1);
        }

        .step.has-note {
            background: rgba(255, 0, 255, 0.3);
        }

        .step.has-note.active {
            background: #ff00ff;
        }

        .cv-gate-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .signal-meter {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
        }

        .signal-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }

        .signal-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d4ff;
        }

        .signal-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .signal-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            transition: width 0.1s ease;
        }

        .synth-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .param-group {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
        }

        .param-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 8px;
        }

        .param-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .param-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
        }

        .param-value {
            min-width: 50px;
            text-align: right;
            font-size: 0.9em;
            color: #00d4ff;
        }

        .info-panel {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            margin-top: 20px;
        }

        .info-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #00d4ff;
        }

        .info-text {
            font-size: 0.9em;
            line-height: 1.6;
            color: #ccc;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .playing {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Home Link -->
    <a href="/" class="home-link">
        <span style="font-size: 2rem;">üè†</span>
        <span>HAOS.FM</span>
    </a>

    <div class="container">
        <header>
            <h1>üéõÔ∏è HAOS Patch Sequencer</h1>
            <p class="subtitle">Visual patch routing system for advanced modular synthesis</p>
        </header>

        <div class="main-grid">
            <!-- Left Panel: Presets & Patches -->
            <div class="panel">
                <div class="panel-title">
                    <span>üéöÔ∏è</span>
                    <span>Preset Patches</span>
                </div>

                <div class="preset-grid">
                    <button class="preset-btn" onclick="loadPreset('acid-bass')">
                        <div class="preset-name">Acid Bass</div>
                        <div class="preset-desc">Classic 303-style sequenced bass</div>
                    </button>
                    <button class="preset-btn" onclick="loadPreset('techno-lead')">
                        <div class="preset-name">Techno Lead</div>
                        <div class="preset-desc">Dual VCO arpeggio lead</div>
                    </button>
                    <button class="preset-btn" onclick="loadPreset('random-melody')">
                        <div class="preset-name">Random Melody</div>
                        <div class="preset-desc">S&H random note generator</div>
                    </button>
                </div>

                <div class="panel-title" style="margin-top: 20px;">
                    <span>üîå</span>
                    <span>Active Patches</span>
                </div>
                <div class="patch-matrix" id="patchMatrix">
                    <div style="color: #888; text-align: center;">Load a preset to see patch cables</div>
                </div>
            </div>

            <!-- Right Panel: Sequencer Controls -->
            <div class="panel">
                <div class="panel-title">
                    <span>‚ñ∂Ô∏è</span>
                    <span>Sequencer Control</span>
                </div>

                <div class="sequencer-controls">
                    <button class="control-btn play" onclick="startSequencer()">‚ñ∂ Play</button>
                    <button class="control-btn stop" onclick="stopSequencer()">‚èπ Stop</button>
                </div>

                <div class="step-display" id="stepDisplay">
                    <!-- Steps will be generated by JS -->
                </div>

                <div class="cv-gate-display">
                    <div class="signal-meter">
                        <div class="signal-label">CV Signal</div>
                        <div class="signal-value" id="cvValue">0.00V</div>
                        <div class="signal-bar">
                            <div class="signal-fill" id="cvBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="signal-meter">
                        <div class="signal-label">Gate Signal</div>
                        <div class="signal-value" id="gateValue">0</div>
                        <div class="signal-bar">
                            <div class="signal-fill" id="gateBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="panel-title" style="margin-top: 20px;">
                    <span>üéµ</span>
                    <span>Frequency Display</span>
                </div>
                <div class="signal-meter">
                    <div class="signal-value" id="freqValue" style="font-size: 2em;">440 Hz</div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel: Synth Parameters -->
        <div class="panel">
            <div class="panel-title">
                <span>üéõÔ∏è</span>
                <span>Synthesizer Parameters</span>
            </div>

            <div class="synth-params">
                <div class="param-group">
                    <div class="param-label">Filter Cutoff</div>
                    <div class="param-control">
                        <input type="range" class="param-slider" id="cutoffSlider" 
                               min="100" max="8000" value="1000" step="10">
                        <span class="param-value" id="cutoffValue">1000 Hz</span>
                    </div>
                </div>

                <div class="param-group">
                    <div class="param-label">Filter Resonance</div>
                    <div class="param-control">
                        <input type="range" class="param-slider" id="resonanceSlider" 
                               min="0" max="20" value="5" step="0.5">
                        <span class="param-value" id="resonanceValue">5</span>
                    </div>
                </div>

                <div class="param-group">
                    <div class="param-label">Envelope Attack</div>
                    <div class="param-control">
                        <input type="range" class="param-slider" id="attackSlider" 
                               min="0.001" max="1" value="0.01" step="0.001">
                        <span class="param-value" id="attackValue">0.01 s</span>
                    </div>
                </div>

                <div class="param-group">
                    <div class="param-label">Envelope Release</div>
                    <div class="param-control">
                        <input type="range" class="param-slider" id="releaseSlider" 
                               min="0.01" max="2" value="0.3" step="0.01">
                        <span class="param-value" id="releaseValue">0.3 s</span>
                    </div>
                </div>

                <div class="param-group">
                    <div class="param-label">Tempo (BPM)</div>
                    <div class="param-control">
                        <input type="range" class="param-slider" id="tempoSlider" 
                               min="60" max="180" value="120" step="1">
                        <span class="param-value" id="tempoValue">120</span>
                    </div>
                </div>

                <div class="param-group">
                    <div class="param-label">Master Volume</div>
                    <div class="param-control">
                        <input type="range" class="param-slider" id="volumeSlider" 
                               min="0" max="1" value="0.7" step="0.01">
                        <span class="param-value" id="volumeValue">0.70</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <div class="info-title">‚ÑπÔ∏è How It Works</div>
            <div class="info-text">
                This demo integrates the step sequencer with the Behringer 2600 patch matrix system. 
                The sequencer outputs CV (control voltage), Gate, and Velocity signals that are routed 
                through the patch cables you see above. Each preset has a different patch configuration:
                <br><br>
                ‚Ä¢ <strong>Acid Bass</strong> - Sequencer CV controls VCO1 frequency, Gate triggers envelope<br>
                ‚Ä¢ <strong>Techno Lead</strong> - Dual VCO routing with velocity-controlled filter<br>
                ‚Ä¢ <strong>Random Melody</strong> - Sample & Hold creates random note sequences<br>
                <br>
                Watch the active patches light up as notes play through the configured signal path!
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/synth-modules.js"></script>
    <script src="/js/synth-2600-audio.js"></script>
    <script src="/js/patch-sequencer.js"></script>

    <script>
        let audioEngine;
        let sequencer;
        let patchSequencer;
        let currentPreset = null;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeSynthesizer();
            initializeUI();
            initializeEventListeners();
        });

        function initializeSynthesizer() {
            // Create audio engine
            audioEngine = new Synth2600Audio();
            
            // Create sequencer
            sequencer = new StepSequencer();
            
            // Create patch-aware sequencer
            patchSequencer = new PatchAwareSequencer(audioEngine, sequencer);
            
            // Set default tempo
            sequencer.setTempo(120);
            
            console.log('üéõÔ∏è Synthesizer initialized');
        }

        function initializeUI() {
            // Generate step display
            const stepDisplay = document.getElementById('stepDisplay');
            for (let i = 0; i < 16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                step.textContent = i + 1;
                step.id = `step-${i}`;
                stepDisplay.appendChild(step);
            }
        }

        function initializeEventListeners() {
            // Listen to sequencer step events
            window.addEventListener('patchSequencerStep', (e) => {
                updateStepDisplay(e.detail);
            });

            // Listen to preset loaded events
            window.addEventListener('patchPresetLoaded', (e) => {
                updatePresetButtons(e.detail.preset);
            });

            // Parameter controls
            document.getElementById('cutoffSlider').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                audioEngine.setFilterCutoff(value);
                document.getElementById('cutoffValue').textContent = `${Math.round(value)} Hz`;
            });

            document.getElementById('resonanceSlider').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                audioEngine.setFilterResonance(value);
                document.getElementById('resonanceValue').textContent = value.toFixed(1);
            });

            document.getElementById('attackSlider').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                audioEngine.envelope.attack = value;
                document.getElementById('attackValue').textContent = `${value.toFixed(3)} s`;
            });

            document.getElementById('releaseSlider').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                audioEngine.envelope.release = value;
                document.getElementById('releaseValue').textContent = `${value.toFixed(2)} s`;
            });

            document.getElementById('tempoSlider').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                sequencer.setTempo(value);
                document.getElementById('tempoValue').textContent = value;
            });

            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                if (audioEngine.masterGain) {
                    audioEngine.masterGain.gain.value = value;
                }
                document.getElementById('volumeValue').textContent = value.toFixed(2);
            });
        }

        function loadPreset(presetName) {
            patchSequencer.loadPresetWithPattern(presetName);
            currentPreset = presetName;
            renderPatchMatrix();
        }

        function renderPatchMatrix() {
            const matrix = document.getElementById('patchMatrix');
            const patches = patchSequencer.getCurrentPatches();
            
            if (patches.length === 0) {
                matrix.innerHTML = '<div style="color: #888; text-align: center;">No patches loaded</div>';
                return;
            }
            
            matrix.innerHTML = '';
            patches.forEach((patch, index) => {
                const cable = document.createElement('div');
                cable.className = 'patch-cable';
                cable.setAttribute('data-patch', `${patch.from}-${patch.to}`);
                cable.textContent = `${patch.from} ‚Üí ${patch.to}`;
                matrix.appendChild(cable);
            });
        }

        function updateStepDisplay(detail) {
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active');
                if (index === detail.step) {
                    step.classList.add('active');
                }
            });

            // Update CV/Gate displays
            const cvValue = detail.cv !== undefined ? detail.cv.toFixed(2) : '0.00';
            const gateValue = detail.gate || 0;
            const frequency = detail.frequency || 0;

            document.getElementById('cvValue').textContent = `${cvValue}V`;
            document.getElementById('gateValue').textContent = gateValue;
            document.getElementById('freqValue').textContent = `${Math.round(frequency)} Hz`;

            // Update signal bars
            const cvPercent = Math.min(100, (detail.cv / 5) * 100); // 0-5V range
            document.getElementById('cvBar').style.width = `${cvPercent}%`;
            document.getElementById('gateBar').style.width = `${gateValue * 100}%`;
        }

        function updatePresetButtons(presetName) {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = Array.from(document.querySelectorAll('.preset-btn'))
                .find(btn => btn.textContent.toLowerCase().includes(presetName.replace('-', ' ')));
            
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function startSequencer() {
            if (!currentPreset) {
                alert('Please load a preset first!');
                return;
            }
            
            if (!audioEngine.isPlaying) {
                audioEngine.start();
            }
            
            sequencer.start();
            
            document.querySelector('.control-btn.play').classList.add('playing');
        }

        function stopSequencer() {
            sequencer.stop();
            audioEngine.stop();
            
            document.querySelector('.control-btn.play').classList.remove('playing');
            
            // Reset display
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
        }
    </script>
</body>
</html>
