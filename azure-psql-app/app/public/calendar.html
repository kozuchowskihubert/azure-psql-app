<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - Notes App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        #calendar {
            max-width: 1200px;
            margin: 0 auto;
        }
        .fc-event {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-calendar-alt mr-3"></i>
                        Calendar
                    </h1>
                    <p class="text-blue-100 mt-2">Manage your events and meetings</p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Notes
                    </a>
                    <button id="add-event-btn" class="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-lg transition-all">
                        <i class="fas fa-plus mr-2"></i>
                        New Event
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Feature Status Banner -->
        <div id="feature-status" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded-r-lg">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-500 mt-1 mr-3"></i>
                <div>
                    <h3 class="font-bold text-yellow-800">Calendar Feature Status</h3>
                    <p class="text-yellow-700 text-sm mt-1">
                        <span id="status-message">Checking calendar service...</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Search -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
            <div class="flex flex-wrap items-center gap-4 justify-between">
                <div class="flex items-center gap-2">
                    <button id="filter-all" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                        <i class="fas fa-list mr-2"></i>All Events
                    </button>
                    <button id="filter-today" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
                        <i class="fas fa-calendar-day mr-2"></i>Today
                    </button>
                    <button id="filter-week" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
                        <i class="fas fa-calendar-week mr-2"></i>This Week
                    </button>
                    <button id="export-ics" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                        <i class="fas fa-download mr-2"></i>Export (.ics)
                    </button>
                </div>
                <div class="flex items-center gap-2 flex-1 max-w-md">
                    <i class="fas fa-search text-gray-400"></i>
                    <input type="text" id="event-search" placeholder="Search events..." 
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- Calendar Container -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Event Creation Modal -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-calendar-plus text-blue-500 mr-2"></i>
                    Create Event
                </h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="event-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                    <input type="text" id="event-title" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="event-description" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date & Time *</label>
                        <input type="datetime-local" id="event-start" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date & Time *</label>
                        <input type="datetime-local" id="event-end" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                    <input type="text" id="event-location" placeholder="e.g., Conference Room A"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="event-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="meeting" data-color="#f59e0b">Meeting (Orange)</option>
                        <option value="event" data-color="#667eea">Event (Blue)</option>
                        <option value="deadline" data-color="#ef4444">Deadline (Red)</option>
                        <option value="reminder" data-color="#10b981">Reminder (Green)</option>
                        <option value="personal" data-color="#8b5cf6">Personal (Purple)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <input type="checkbox" id="event-recurring" class="mr-2">
                        Recurring Event
                    </label>
                    <div id="recurring-options" class="hidden mt-2 pl-6 space-y-2">
                        <select id="recurring-frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Repeat Until (optional)</label>
                            <input type="date" id="recurring-until" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <input type="checkbox" id="event-reminder" class="mr-2">
                        Set Reminder
                    </label>
                    <div id="reminder-options" class="hidden mt-2 pl-6">
                        <select id="reminder-time" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="5">5 minutes before</option>
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                            <option value="60">1 hour before</option>
                            <option value="1440">1 day before</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center space-x-4 pt-4">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-all">
                        <i class="fas fa-save mr-2"></i>
                        Create Event
                    </button>
                    <button type="button" id="cancel-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg transition-all">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let calendar;
        let allEvents = [];
        const API_BASE = window.location.origin;

        // Check if calendar API is available
        async function checkCalendarService() {
            try {
                const response = await fetch(`${API_BASE}/api/calendar/events`);
                if (response.status === 404) {
                    showStatus('warning', 'Calendar API not enabled. Using local storage for demo. Enable ENABLE_CALENDAR_SYNC=true for cloud sync.');
                    return false;
                }
                if (!response.ok) {
                    throw new Error('Calendar service unavailable');
                }
                showStatus('success', 'Calendar service is active. Events synced to cloud!');
                return true;
            } catch (error) {
                showStatus('warning', 'Using local storage. Events saved in browser only.');
                return false;
            }
        }

        function showStatus(type, message) {
            const banner = document.getElementById('feature-status');
            const statusMsg = document.getElementById('status-message');
            statusMsg.textContent = message;

            banner.className = 'border-l-4 p-4 mb-6 rounded-r-lg';
            if (type === 'success') {
                banner.classList.add('bg-green-50', 'border-green-500');
                statusMsg.className = 'text-green-700 text-sm mt-1';
            } else if (type === 'warning') {
                banner.classList.add('bg-yellow-50', 'border-yellow-500');
                statusMsg.className = 'text-yellow-700 text-sm mt-1';
            } else {
                banner.classList.add('bg-red-50', 'border-red-500');
                statusMsg.className = 'text-red-700 text-sm mt-1';
            }
        }

        // Initialize calendar
        document.addEventListener('DOMContentLoaded', async function() {
            await checkCalendarService();
            loadEventsFromStorage();

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                eventDrop: handleEventDrop,
                eventResize: handleEventResize,
                events: function(info, successCallback, failureCallback) {
                    successCallback(allEvents);
                },
                eventClick: function(info) {
                    showEventDetails(info.event);
                },
                select: function(info) {
                    document.getElementById('event-start').value = formatDateTimeLocal(info.start);
                    document.getElementById('event-end').value = formatDateTimeLocal(info.end);
                    openModal();
                }
            });

            calendar.render();
            setupEventListeners();
        });

        function getDemoEvents() {
            const now = new Date();
            return [
                {
                    id: 'demo-1',
                    title: 'Team Meeting',
                    start: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 10, 0),
                    end: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 11, 0),
                    backgroundColor: '#f59e0b',
                    extendedProps: { category: 'meeting', location: 'Conference Room A' }
                },
                {
                    id: 'demo-2',
                    title: 'Project Review',
                    start: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3, 14, 0),
                    end: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3, 15, 30),
                    backgroundColor: '#667eea',
                    extendedProps: { category: 'event', location: 'Online' }
                }
            ];
        }

        function setupEventListeners() {
            // Modal handlers
            document.getElementById('add-event-btn').addEventListener('click', () => {
                const now = new Date();
                document.getElementById('event-start').value = formatDateTimeLocal(now);
                document.getElementById('event-end').value = formatDateTimeLocal(new Date(now.getTime() + 3600000));
                openModal();
            });

            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-modal').addEventListener('click', closeModal);
            document.getElementById('event-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createEvent();
            });

            // Recurring event toggle
            document.getElementById('event-recurring').addEventListener('change', (e) => {
                document.getElementById('recurring-options').classList.toggle('hidden', !e.target.checked);
            });

            // Reminder toggle
            document.getElementById('event-reminder').addEventListener('change', (e) => {
                document.getElementById('reminder-options').classList.toggle('hidden', !e.target.checked);
            });

            // Filter buttons
            document.getElementById('filter-all').addEventListener('click', () => {
                setActiveFilter('filter-all');
                calendar.refetchEvents();
            });

            document.getElementById('filter-today').addEventListener('click', () => {
                setActiveFilter('filter-today');
                calendar.changeView('timeGridDay');
                calendar.today();
            });

            document.getElementById('filter-week').addEventListener('click', () => {
                setActiveFilter('filter-week');
                calendar.changeView('timeGridWeek');
                calendar.today();
            });

            // Export to .ics
            document.getElementById('export-ics').addEventListener('click', exportToICS);

            // Search
            document.getElementById('event-search').addEventListener('input', (e) => {
                searchEvents(e.target.value);
            });
        }

        function setActiveFilter(activeId) {
            ['filter-all', 'filter-today', 'filter-week'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === activeId) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        }

        function searchEvents(query) {
            if (!query) {
                allEvents = loadEventsFromStorage();
                calendar.refetchEvents();
                return;
            }

            const filtered = allEvents.filter(event => 
                event.title.toLowerCase().includes(query.toLowerCase()) ||
                (event.extendedProps?.description || '').toLowerCase().includes(query.toLowerCase()) ||
                (event.extendedProps?.location || '').toLowerCase().includes(query.toLowerCase())
            );

            calendar.removeAllEvents();
            calendar.addEventSource(filtered);
        }

        function handleEventDrop(info) {
            const event = allEvents.find(e => e.id === info.event.id);
            if (event) {
                event.start = info.event.start;
                event.end = info.event.end || info.event.start;
                saveEventsToStorage();
                showToast('Event moved successfully', 'success');
            }
        }

        function handleEventResize(info) {
            const event = allEvents.find(e => e.id === info.event.id);
            if (event) {
                event.start = info.event.start;
                event.end = info.event.end;
                saveEventsToStorage();
                showToast('Event updated successfully', 'success');
            }
        }

        function showEventDetails(event) {
            const details = `
                Event: ${event.title}
                Start: ${event.start.toLocaleString()}
                End: ${event.end ? event.end.toLocaleString() : 'N/A'}
                ${event.extendedProps?.location ? 'Location: ' + event.extendedProps.location : ''}
                ${event.extendedProps?.description ? 'Description: ' + event.extendedProps.description : ''}
                Category: ${event.extendedProps?.category || 'event'}
            `;
            
            if (confirm(details + '\n\nDelete this event?')) {
                deleteEvent(event.id);
            }
        }

        function deleteEvent(eventId) {
            allEvents = allEvents.filter(e => e.id !== eventId);
            saveEventsToStorage();
            calendar.refetchEvents();
            showToast('Event deleted', 'success');
        }

        function loadEventsFromStorage() {
            const stored = localStorage.getItem('calendar-events');
            if (stored) {
                try {
                    allEvents = JSON.parse(stored).map(e => ({
                        ...e,
                        start: new Date(e.start),
                        end: e.end ? new Date(e.end) : null
                    }));
                    return allEvents;
                } catch (error) {
                    console.error('Error loading events:', error);
                }
            }
            allEvents = getDemoEvents();
            return allEvents;
        }

        function saveEventsToStorage() {
            localStorage.setItem('calendar-events', JSON.stringify(allEvents));
        }

        function generateRecurringEvents(baseEvent, frequency, until) {
            const events = [baseEvent];
            const start = new Date(baseEvent.start);
            const end = baseEvent.end ? new Date(baseEvent.end) : new Date(start.getTime() + 3600000);
            const duration = end - start;
            const untilDate = until ? new Date(until) : new Date(start.getTime() + 365 * 24 * 60 * 60 * 1000);
            
            let currentStart = new Date(start);
            let counter = 1;

            while (currentStart < untilDate && counter < 100) {
                switch (frequency) {
                    case 'daily':
                        currentStart.setDate(currentStart.getDate() + 1);
                        break;
                    case 'weekly':
                        currentStart.setDate(currentStart.getDate() + 7);
                        break;
                    case 'monthly':
                        currentStart.setMonth(currentStart.getMonth() + 1);
                        break;
                    case 'yearly':
                        currentStart.setFullYear(currentStart.getFullYear() + 1);
                        break;
                }

                if (currentStart < untilDate) {
                    const newEnd = new Date(currentStart.getTime() + duration);
                    events.push({
                        ...baseEvent,
                        id: `${baseEvent.id}-recur-${counter}`,
                        start: new Date(currentStart),
                        end: newEnd
                    });
                    counter++;
                }
            }

            return events;
        }

        function exportToICS() {
            let icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Notes App//Calendar//EN\n';
            
            allEvents.forEach(event => {
                const start = new Date(event.start);
                const end = event.end ? new Date(event.end) : new Date(start.getTime() + 3600000);
                
                icsContent += 'BEGIN:VEVENT\n';
                icsContent += `UID:${event.id}@notesapp.com\n`;
                icsContent += `DTSTART:${formatICSDate(start)}\n`;
                icsContent += `DTEND:${formatICSDate(end)}\n`;
                icsContent += `SUMMARY:${event.title}\n`;
                if (event.extendedProps?.description) {
                    icsContent += `DESCRIPTION:${event.extendedProps.description}\n`;
                }
                if (event.extendedProps?.location) {
                    icsContent += `LOCATION:${event.extendedProps.location}\n`;
                }
                icsContent += 'END:VEVENT\n';
            });
            
            icsContent += 'END:VCALENDAR';

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `calendar-export-${new Date().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Calendar exported successfully!', 'success');
        }

        function formatICSDate(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 z-50`;
            
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-600');
                    break;
                case 'error':
                    toast.classList.add('bg-red-600');
                    break;
                default:
                    toast.classList.add('bg-blue-600');
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.transform = 'translateY(0)', 10);
            setTimeout(() => {
                toast.style.transform = 'translateY(100px)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function openModal() {
            document.getElementById('event-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('event-modal').classList.add('hidden');
            document.getElementById('event-form').reset();
        }

        async function createEvent() {
            const title = document.getElementById('event-title').value;
            const description = document.getElementById('event-description').value;
            const start = new Date(document.getElementById('event-start').value);
            const end = new Date(document.getElementById('event-end').value);
            const location = document.getElementById('event-location').value;
            const category = document.getElementById('event-category').value;
            const categoryColor = document.getElementById('event-category').selectedOptions[0].dataset.color;
            const isRecurring = document.getElementById('event-recurring').checked;
            const recurringFrequency = document.getElementById('recurring-frequency').value;
            const recurringUntil = document.getElementById('recurring-until').value;
            const hasReminder = document.getElementById('event-reminder').checked;
            const reminderTime = document.getElementById('reminder-time').value;

            const baseEvent = {
                id: 'event-' + Date.now(),
                title: title,
                start: start,
                end: end,
                backgroundColor: categoryColor,
                extendedProps: {
                    description,
                    location,
                    category,
                    reminder: hasReminder ? parseInt(reminderTime) : null,
                    recurring: isRecurring ? { frequency: recurringFrequency, until: recurringUntil } : null
                }
            };

            // Generate recurring events if needed
            let newEvents = [baseEvent];
            if (isRecurring) {
                newEvents = generateRecurringEvents(baseEvent, recurringFrequency, recurringUntil);
                showToast(`Created ${newEvents.length} recurring events`, 'success');
            } else {
                showToast('Event created successfully!', 'success');
            }

            allEvents.push(...newEvents);
            saveEventsToStorage();
            calendar.refetchEvents();

            // Set reminder if enabled
            if (hasReminder) {
                scheduleReminder(baseEvent, parseInt(reminderTime));
            }

            closeModal();
        }

        function scheduleReminder(event, minutesBefore) {
            const reminderTime = new Date(event.start).getTime() - (minutesBefore * 60 * 1000);
            const now = Date.now();
            
            if (reminderTime > now) {
                setTimeout(() => {
                    if (Notification.permission === 'granted') {
                        new Notification('Event Reminder', {
                            body: `${event.title} starting in ${minutesBefore} minutes`,
                            icon: '/favicon.ico'
                        });
                    } else {
                        alert(`Reminder: ${event.title} starting in ${minutesBefore} minutes`);
                    }
                }, reminderTime - now);
            }
        }
    </script>
</body>
</html>
