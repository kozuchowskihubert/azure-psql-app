<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - Notes App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        #calendar {
            max-width: 1200px;
            margin: 0 auto;
        }
        .fc-event {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-calendar-alt mr-3"></i>
                        Calendar
                    </h1>
                    <p class="text-blue-100 mt-2">Manage your events and meetings</p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-lg transition-all">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Notes
                    </a>
                    <button id="add-event-btn" class="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-lg transition-all">
                        <i class="fas fa-plus mr-2"></i>
                        New Event
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Feature Status Banner -->
        <div id="feature-status" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded-r-lg">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-500 mt-1 mr-3"></i>
                <div>
                    <h3 class="font-bold text-yellow-800">Calendar Feature Status</h3>
                    <p class="text-yellow-700 text-sm mt-1">
                        <span id="status-message">Checking calendar service...</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Calendar Container -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Event Creation Modal -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-calendar-plus text-blue-500 mr-2"></i>
                    Create Event
                </h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <form id="event-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                    <input type="text" id="event-title" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="event-description" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date & Time *</label>
                        <input type="datetime-local" id="event-start" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date & Time *</label>
                        <input type="datetime-local" id="event-end" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                    <input type="text" id="event-location"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="flex items-center space-x-4 pt-4">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-all">
                        <i class="fas fa-save mr-2"></i>
                        Create Event
                    </button>
                    <button type="button" id="cancel-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg transition-all">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let calendar;
        const API_BASE = window.location.origin;

        // Check if calendar API is available
        async function checkCalendarService() {
            try {
                const response = await fetch(`${API_BASE}/api/calendar/events`);
                if (response.status === 404) {
                    showStatus('warning', 'Calendar API not enabled. Set ENABLE_CALENDAR_SYNC=true in environment variables.');
                    return false;
                }
                if (!response.ok) {
                    throw new Error('Calendar service unavailable');
                }
                showStatus('success', 'Calendar service is active. Ready to manage events!');
                return true;
            } catch (error) {
                showStatus('error', 'Calendar API not configured. Backend integration needed.');
                return false;
            }
        }

        function showStatus(type, message) {
            const banner = document.getElementById('feature-status');
            const statusMsg = document.getElementById('status-message');
            statusMsg.textContent = message;

            banner.className = 'border-l-4 p-4 mb-6 rounded-r-lg';
            if (type === 'success') {
                banner.classList.add('bg-green-50', 'border-green-500');
                statusMsg.className = 'text-green-700 text-sm mt-1';
            } else if (type === 'warning') {
                banner.classList.add('bg-yellow-50', 'border-yellow-500');
                statusMsg.className = 'text-yellow-700 text-sm mt-1';
            } else {
                banner.classList.add('bg-red-50', 'border-red-500');
                statusMsg.className = 'text-red-700 text-sm mt-1';
            }
        }

        // Initialize calendar
        document.addEventListener('DOMContentLoaded', async function() {
            await checkCalendarService();

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                editable: true,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                events: async function(info, successCallback, failureCallback) {
                    try {
                        const response = await fetch(
                            `${API_BASE}/api/calendar/events?start=${info.startStr}&end=${info.endStr}`
                        );
                        if (response.ok) {
                            const data = await response.json();
                            const events = data.events?.map(e => ({
                                id: e.id,
                                title: e.title,
                                start: e.start_time,
                                end: e.end_time,
                                backgroundColor: e.event_type === 'meeting' ? '#f59e0b' : '#667eea',
                            })) || [];
                            successCallback(events);
                        } else {
                            // Calendar API not available, show demo events
                            successCallback(getDemoEvents());
                        }
                    } catch (error) {
                        console.log('Using demo events');
                        successCallback(getDemoEvents());
                    }
                },
                eventClick: function(info) {
                    alert('Event: ' + info.event.title + '\nStart: ' + info.event.start.toLocaleString());
                },
                select: function(info) {
                    document.getElementById('event-start').value = formatDateTimeLocal(info.start);
                    document.getElementById('event-end').value = formatDateTimeLocal(info.end);
                    openModal();
                }
            });

            calendar.render();

            // Modal handlers
            document.getElementById('add-event-btn').addEventListener('click', () => {
                const now = new Date();
                document.getElementById('event-start').value = formatDateTimeLocal(now);
                document.getElementById('event-end').value = formatDateTimeLocal(new Date(now.getTime() + 3600000));
                openModal();
            });

            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-modal').addEventListener('click', closeModal);

            document.getElementById('event-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createEvent();
            });
        });

        function getDemoEvents() {
            const now = new Date();
            return [
                {
                    title: 'Team Meeting (Demo)',
                    start: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 10, 0),
                    end: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 11, 0),
                    backgroundColor: '#f59e0b'
                },
                {
                    title: 'Project Review (Demo)',
                    start: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3, 14, 0),
                    end: new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3, 15, 30),
                    backgroundColor: '#667eea'
                }
            ];
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function openModal() {
            document.getElementById('event-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('event-modal').classList.add('hidden');
            document.getElementById('event-form').reset();
        }

        async function createEvent() {
            const eventData = {
                title: document.getElementById('event-title').value,
                description: document.getElementById('event-description').value,
                startTime: new Date(document.getElementById('event-start').value).toISOString(),
                endTime: new Date(document.getElementById('event-end').value).toISOString(),
                location: document.getElementById('event-location').value,
                eventType: 'event'
            };

            try {
                const response = await fetch(`${API_BASE}/api/calendar/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });

                if (response.ok) {
                    alert('Event created successfully!');
                    calendar.refetchEvents();
                    closeModal();
                } else {
                    const error = await response.json();
                    alert('Failed to create event: ' + (error.error || 'Calendar API not enabled'));
                }
            } catch (error) {
                alert('Calendar API not available. Please enable ENABLE_CALENDAR_SYNC=true');
            }
        }
    </script>
</body>
</html>
